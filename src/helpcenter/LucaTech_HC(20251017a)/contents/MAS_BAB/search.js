var searchWords = $('<div class="search"><div id="MAS13001"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; はじめに</div></div><div id="MAS13003"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 残高登録の概要</div><div class="search_title">残高登録の概要</div><div class="displayText">残高登録の概要『LucaTech GX』導入時に、会社の残高を登録します。『LucaTech GX』には次の３つの残高登録のメニューがあります。各メニュー、部門ごとに残高の登録が可 ...</div><div class="search_word">残高登録の概要『LucaTech GX』導入時に、会社の残高を登録します。『LucaTech GX』には次の３つの残高登録のメニューがあります。各メニュー、部門ごとに残高の登録が可能です。 残高登録のメニュー説明勘定科目残高登録会社全体の残高を科目・科目別補助ごとに登録するメニューです。システム導入時に必ず登録します。⇒『科目の残高を登録する』参照摘要残高登録科目のほかに、固定摘要で残高を管理する場合に登録するメニューです。たとえば、交際費を「会食向けの交際費」「贈答向けの交際費」といった内訳で残高を管理する場合に使用します。⇒『摘要の残高を登録する』参照共通補助残高登録科目のほかに、取引先や銀行などの共通補助で残高を管理する場合に登録するメニューです。たとえば、売掛金を「A社」「B社」といった取引先別などで残高を管理する場合に使用します。⇒『共通補助の残高を登録する』参照 残高登録の登録イメージ</div></div><div id="MAS13004"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 科目の残高を登録する</div><div class="search_title">科目の残高を登録する</div><div class="displayText">科目の残高を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］『LucaTech GX』の導入時に、科目・科目別補助ごとに残高を登録します。ここでは、残高を手入力する方法 ...</div><div class="search_word">科目の残高を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］『LucaTech GX』の導入時に、科目・科目別補助ごとに残高を登録します。ここでは、残高を手入力する方法について説明します。残高を一括で登録する場合は、［データ関係処理］＞［データ交換］＞［インポート］で行います。インポートの方法については、次を参照してください。⇒『データ交換の流れ』参照どの時点の残高を登録するかによって、登録する残高の種類が異なります。登録する残高の種類説明期首残高期首の残高を登録します。『LucaTech GX』に残高を登録する場合は、必ず期首残高を登録します。⇒『期首残高を登録する』参照経過月発生残高期中から『LucaTech   GX』を導入した場合に、期首から仕訳入力を開始する月までの実績を登録します。⇒『経過月発生高を登録する』参照過年度残高過去の期首残高と実績を登録します。最大4年分の実績を登録できます。⇒『過年度の実績金額を登録する』参照 たとえば、2025年7月に他システムから『LucaTech GX』にデータを移行するときは、次のような期首残高や実績を登録します。『LucaTech GX』運用後は、『決算更新』を行うことで過年度分の残高が自動的に更新されるため、『残高登録』を行う必要はありません。 期首残高を登録した後の推移は、『仕訳参照』で確認できます。 勘定科目残高の画面説明［入力区分：過年度実績の場合］ 1［…］［一括削除］登録した残高を一括削除します。科目を範囲指定して削除できます。⇒『登録した残高を削除する』参照2出力条件設定エリア登録する残高の条件を指定します。3残高表示エリア入力した残高の借方・貸方の合計金額や貸借差額が表示されます。［合計セット］部門、または科目別補助ごとに残高を登録した場合に、個別に登録した残高を全体の科目の残高に反映させます。⇒『合計セットを行う』参照4残高登録エリア科目・科目別補助の残高を入力します。［出力順序］『科目出力順序』で登録したパターンで科目の並び順を変更できます。5すべて閉じるすべて展開科目別補助の予算入力欄の表示有無を切り替えることができます。6＞＞＞画面に表示されていない右側にも入力欄があることを示しています。</div></div><div id="MAS13005"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 科目の残高を登録する &gt; 期首残高を登録する</div><div class="search_title">期首残高を登録する</div><div class="displayText">期首残高を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］＞［入力区分：期首残高］期首の残高を登録します。『LucaTech GX』に残高を登録する場合は、必ず登録しま ...</div><div class="search_word">期首残高を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］＞［入力区分：期首残高］期首の残高を登録します。『LucaTech GX』に残高を登録する場合は、必ず登録します。勘定科目残高で共通する項目の説明については、次を参照してください。⇒『勘定科目残高の画面説明』参照  期首残高を登録する①　残高を登録する条件を指定します。 入力区分［期首残高］を選択します。種類会社全体で管理する科目の残高を登録する場合は［全社］を選択します。部門ごとに管理する科目の残高を登録する場合は［部門］を選択し、から部門を選択します。②　［条件で出力］をクリックします。③　科目・科目別補助ごとに残高を入力します。マイナス金額を入力する場合は、「－」を入力します。ただし、貸倒引当金、減価償却累計額などの減算する科目はマイナス金額にする必要はありません。▶がついた科目をクリックすると、右側に科目別補助が表示され、科目別補助の残高を入力できます。前期末の繰越利益剰余金は、当期首の期首繰越利益剰余金に入力します。④　［更新］をクリックします。⑤　他の部門の残高を登録する場合は［種類］で部門を選択し、手順①～手順④までを繰り返します。⑥　科目別補助、部門ごとに残高を登録した場合は、［合計セット］をクリックして、個々に登録した残高を全体の科目の残高に反映させます。［合計セット］については、次を参照してください。⇒『合計セットを行う』参照⑦　すべての残高の登録が完了した後は、［種類］で［全社］を選択して、総合計の貸借差額が「0」になっていることを確認します。   総合計の貸借差額が発生している場合総合計の貸借差額が「0」になっていない場合、その差額が「繰越利益剰余金」として処理され、財務報告書などの帳票の「繰越利益剰余金」に正しい金額が表示されません。  合計セットを行う部門や科目別補助、共通補助ごとに残高を登録しただけでは、全体の科目残高には反映されないため、合計セットを行い、全体の科目残高に対して残高を反映する必要があります。合計セットは、残高登録画面の［種類］で集計先を選択し、［合計セット］をクリックした後の［合計セット］画面で［セット種類］に集計元を選択して行います。 （例）科目別補助の残高を科目の残高に反映させる場合  なお、科目別補助または共通補助に加えて、部門でも残高を管理している場合は、先に科目別補助または共通補助から部門に対して合計セットを行い、その後部門から科目に対して合計セットを行います。  合計セットを行う①　残高登録画面で集計先を選択し、［条件で出力］をクリックします。［全社］会社全体の科目に対して部門・科目別補助・共通補助の合計セットを行う場合に選択します。［部門］特定の部門の科目に対して科目別補助・共通補助の合計セットを行う場合に選択します。②　［合計セット］をクリックします。［合計セット］画面が別ウィンドウで開きます。③　合計セット行う条件を指定します。 セット種類集計対象の内訳を選択します。セット範囲特定の科目で表示を絞り込む場合に、開始と終了の科目コードを指定します。CSV出力合計セットを行う科目の一覧をCSVファイルに出力する場合は、［出力する］を選択します。④　［条件で出力］をクリックします。全体の科目の残高と、部門や科目別補助、共通補助別に登録した残高に差異がある科目は、［ステータス］欄に［差異あり］が表示されます。⑤　［差異あり］の科目の［残高（合計前）］と［残高（合計後）］の金額を確認し、［合計セット反映］をクリックします。［差異あり］の表示がなくなり、［残高（合計後）］の金額が全体の科目の残高にセットされます。⑥　［合計セット］画面の［×］をクリックして画面を閉じます。⑦　残高登録の画面を開き、をクリックします。部門や科目別補助、共通補助の残高が科目の残高に反映されます。  登録した残高を削除する登録した残高を一括で削除します。   削除の注意点削除したデータは元に戻すことはできません。 ［…］から［一括削除］をクリックします。 一括削除の画面が開きます。削除する残高の条件を指定して［削除］をクリックします。 入力区分削除する残高の種類を選択します。年度区分［入力区分］で［過年度実績］を選択した場合に、削除する残高の年を選択します。種類削除する種類を選択します。［全社］全体科目の残高を削除する場合に選択します。［部門］特定の部門の残高を削除する場合に選択します。部門［種類］で部門を選択した場合に、削除する部門の範囲を指定します。翌期以降の残高登録において、期首残高を部門配賦前の金額で開始したい場合に、［配賦金額のみ削除］を［適用する］にします。科目削除する科目の範囲を指定します。指定した科目に対して、科目別補助のみ削除する場合は、［科目別補助のみ削除］を［適用する］にします。対象月［入力区分］で［経過月発生残高］［過年度実績］を選択した場合に、削除したい月の範囲を指定します。</div></div><div id="MAS13008"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 科目の残高を登録する &gt; 経過月発生高を登録する</div><div class="search_title">経過月発生高を登録する</div><div class="displayText">経過月発生高を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］＞［入力区分：経過月発生高］期中に『LucaTech GX』を導入した場合に、期首から仕訳入力開始月までの ...</div><div class="search_word">経過月発生高を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］＞［入力区分：経過月発生高］期中に『LucaTech GX』を導入した場合に、期首から仕訳入力開始月までの実績（経過月発生高）を登録します。勘定科目残高で共通する項目の説明については、次を参照してください。⇒『勘定科目残高の画面説明』参照  経過月発生高を登録する①　経過月発生高を登録する条件を指定します。 入力区分［経過月発生高］を選択します。種類会社全体の科目の経過月発生高を登録する場合は［全社］を選択します。部門ごとに科目の経過月発生高を登録する場合は［部門］を選択し、から部門を選択します。月度登録する経過月発生高の月を入力します。②　［条件で出力］をクリックします。③　科目・科目別補助ごとに借方・貸方の経過月発生高を入力します。▶がついた科目をクリックすると、右側に科目別補助が表示され、科目別補助の残高を入力できます。④　［更新］をクリックします。⑤　他の部門の残高を登録する場合は［種類］で部門を選択し、手順①～手順④までを繰り返します。⑥　部門・科目別補助ごとに金額を登録した場合は、［合計セット］をクリックして、個々に登録した金額を全体の科目の金額に反映させます。［合計セット］については、次を参照してください。⇒『合計セットを行う』参照⑦　経過月発生高の登録が完了した後は、［種類］で［全社］を選択して、総合計の貸借差額が「０」になっていることを確認します。   総合計の貸借差額が発生している場合総合計の貸借差額が「0」になっていない場合、その差額が「繰越利益剰余金」として処理され、財務報告書などの帳票の「繰越利益剰余金」に正しい金額が表示されません。</div></div><div id="MAS13009"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 科目の残高を登録する &gt; 過年度の実績金額を登録する</div><div class="search_title">過年度の実績金額を登録する</div><div class="displayText">過年度の実績金額を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］＞［入力区分：過年度実績］他業務システムの実績金額を『LucaTech GX』に反映する場合に、過年度 ...</div><div class="search_word">過年度の実績金額を登録する　［設定］＞［残高登録］＞［財務］＞［勘定科目残高］＞［入力区分：過年度実績］他業務システムの実績金額を『LucaTech GX』に反映する場合に、過年度の期首残高と実績金額を登録します。登録できる過年度は、最大4年までです。勘定科目残高で共通する項目の説明については、次を参照してください。⇒『勘定科目残高の画面説明』参照  過年度の期首残高と実績金額を登録する①　 過年度の期首残高と実績を登録する条件を指定します。 入力区分［過年度実績］を選択します。年度区分登録する過年度の年を選択します。種類会社全体の科目の残高を登録する場合は［全社］を選択します。部門ごとに科目の残高を登録する場合は［部門］を選択し、から部門を選択します。②　［条件で出力］をクリックします。③　科目・科目別補助ごとに期首残高と各年月の借方・貸方の実績金額を入力します。金額を入力して［Enter］を押すと、カーソルが右に移動します。期首残高欄について、マイナス金額を入力する場合は、「－」を入力します。ただし、貸倒引当金、減価償却累計額などの減算する科目はマイナス金額にする必要はありません。▶がついた科目をクリックすると、科目別補助が表示され、科目別補助の残高を入力できます。④　［更新］をクリックします。⑤　他の部門の残高を登録する場合は［種類］で部門を選択し、手順①～手順④までを繰り返します。⑥　部門・科目別補助ごとに残高を登録した場合は、［合計セット］をクリックして、個々に登録した残高を全体の科目の残高に反映させます。［合計セット］については、次を参照してください。⇒『合計セットを行う』参照⑦　残高登録の最後に、［種類］で［全社］を選択して、総合計の貸借差額が「０」になっていることを確認します。</div></div><div id="MAS13010"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 摘要の残高を登録する</div><div class="search_title">摘要の残高を登録する</div><div class="displayText">摘要の残高を登録する　［設定］＞［残高登録］＞［財務］＞［摘要残高］科目の残高登録に加え、『固定摘要登録』で登録した摘要を用いて残高を管理する場合は、ここで摘要の期首の残高を登録し ...</div><div class="search_word">摘要の残高を登録する　［設定］＞［残高登録］＞［財務］＞［摘要残高］科目の残高登録に加え、『固定摘要登録』で登録した摘要を用いて残高を管理する場合は、ここで摘要の期首の残高を登録します。摘要の残高は、科目のほかに科目別補助や銀行などの共通補助に対して登録できます。 科目別に摘要残高を登録するイメージ 科目別補助に対して摘要残高を登録するイメージ共通補助（銀行）に対して摘要残高を登録するイメージ 摘要残高を登録した後の推移は、『補助・摘要残高一覧表』や『仕訳参照』＞［参照種別：検証］の［科目別集計］などで確認できます。 摘要残高の画面説明 1［…］［一括削除］登録した残高を一括削除します。科目を範囲指定して削除できます。⇒『登録した残高を削除する』参照2出力条件設定エリア登録する残高を条件指定します。3残高登録エリア入力した残高の借方・貸方の合計金額や貸借差額が表示されます。［絞り込み］ 科目別補助などと組み合わせて摘要残高を登録する場合、新規に摘要行を追加するときに、固定摘要の検索画面に表示する摘要を絞り込みます。［新規摘要行追加］エリアに表示されていない摘要の残高を登録する場合は、［新規摘要行追加］をクリックして摘要を追加します。 摘要の残高を登録する摘要の残高の登録手順について説明します。科目に対して残高を登録する場合と、科目別補助や汎用補助と組み合わせて残高を登録する場合で方法が異なります。  摘要の残高を登録する（科目の場合）①　［入力区分］で［科目］を選択します。②　［条件で出力］をクリックします。『固定摘要登録』の［科目連想］の［摘要残高］が［管理あり］に設定されている科目とその摘要が表示されます。③　表示されていない摘要の残高を登録する場合は、［新規摘要行追加］をクリックして科目と摘要を追加します。④　科目の摘要の残高を入力します。マイナス金額を入力する場合は、［－］を入力します。残高がない場合は0を入力します。⑤　［更新］をクリックします。［新規摘要行追加］で摘要を追加した場合は、『固定摘要登録』の科目連想にその科目が追加され、自動的に［摘要残高］が［管理あり］に設定されます。［固定摘要登録］画面［摘要残高］が［管理あり］に設定されている科目は、仕訳入力時に摘要の入力が必須になり、残高の推移を管理できるようになります。  摘要の残高を登録する（科目別補助や汎用補助と組み合わせる場合）科目別補助に対して摘要の残高を登録する場合を例に説明します。①　［入力区分］で［科目別補助］を選択し、［科目］で摘要を設定する科目を選択します。②　［条件で出力］をクリックします。③　［新規摘要行追加］をクリックして科目別補助と摘要を追加し、残高を入力します。マイナス金額を入力する場合は、［－］を入力します。④　［更新］をクリックします。ここで残高を登録した摘要は、『固定摘要登録』の科目連想にその科目が追加され、自動的に［摘要残高］が［管理なし］に設定されます。 ［固定摘要登録］画面</div></div><div id="MAS13011"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 共通補助の残高を登録する</div><div class="search_title">共通補助の残高を登録する</div><div class="displayText">共通補助の残高を登録する　［設定］＞［残高登録］＞［財務］＞［共通補助残高］科目の残高登録に加え、取引先や銀行などの共通補助を用いて残高を管理する場合は、ここで共通補助の残高を登録 ...</div><div class="search_word">共通補助の残高を登録する　［設定］＞［残高登録］＞［財務］＞［共通補助残高］科目の残高登録に加え、取引先や銀行などの共通補助を用いて残高を管理する場合は、ここで共通補助の残高を登録します。たとえば、売掛金を「A社」「B社」といった取引先別などで残高の推移を確認できます。共通補助残高を登録した後の推移は、『補助・摘要残高一覧表』や『仕訳参照』の［科目別集計］などで確認できます。『補助・摘要残高一覧表』 共通補助残高の画面説明［入力区分：過年度実績の場合］ 1［…］［一括削除］登録した残高を一括削除します。科目を範囲指定して削除できます。⇒『登録した残高を削除する』参照2出力条件設定エリア登録する残高を条件指定します。3残高表示エリア『勘定科目残高』の科目の残高と、登録した共通補助の科目の残高が表示されます。［合計セット］部門ごとに共通補助の残高を登録した場合、合計セットを行い、全体の共通補助の残高に反映させます。合計セットの考え方や手順は『勘定科目残高』と同様です。⇒『合計セットを行う』参照4残高登録エリア共通補助の残高を入力します。5＞＞＞画面に表示されていない右側にも入力欄があることを示しています。</div></div><div id="MAS13012"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 共通補助の残高を登録する &gt; 期首残高を登録する（共通補助）</div><div class="search_title">期首残高を登録する（共通補助）</div><div class="displayText">期首残高を登録する（共通補助）　［設定］＞［残高登録］＞［財務］＞［共通補助残高］＞［入力区分：期首残高］共通補助の期首残高を登録します。  共通補助の期首残高を登録する『取引先登 ...</div><div class="search_word">期首残高を登録する（共通補助）　［設定］＞［残高登録］＞［財務］＞［共通補助残高］＞［入力区分：期首残高］共通補助の期首残高を登録します。  共通補助の期首残高を登録する『取引先登録』のマスターを使用して売掛金の残高を登録する場合の画面を例に説明します。①　残高を登録する条件を指定します。 補助区分残高を登録する共通補助を選択します。入力区分［期首残高］を選択します。種類会社全体で管理する科目の残高を登録する場合は［全社］を選択します。部門ごとに管理する科目の残高を登録する場合は［部門］を選択し、から部門を選択します。科目残高を登録する科目を選択します。②　［条件で出力］をクリックします。③　共通補助ごとに残高を入力します。マイナス金額を入力する場合は、「－」を入力します。『勘定科目残高』で登録した科目の残高が表示されるので、一致するように共通補助の残高を入力します。④　［更新］をクリックします。⑤　共通補助ごとに登録した科目の残高が表示されるので、［科目残高］と同じ金額になっていることを確認します。⑥　他の部門の残高を登録する場合は［種類］で部門を選択し、手順①～手順⑤までを繰り返します。⑦　部門ごとに残高を登録した場合は、全社の状態で［合計セット］をクリックして、個々に登録した残高を共通補助全体の残高に反映させます。［合計セット］については、次を参照してください。⇒『合計セットを行う』参照</div></div><div id="MAS13013"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 共通補助の残高を登録する &gt; 経過月発生高を登録する（共通補助）</div><div class="search_title">経過月発生高を登録する（共通補助）</div><div class="displayText">経過月発生高を登録する（共通補助）　［設定］＞［残高登録］＞［財務］＞［共通補助残高］＞［入力区分：経過月発生高］期中に『LucaTech GX』を導入した場合に、期首から仕訳入力 ...</div><div class="search_word">経過月発生高を登録する（共通補助）　［設定］＞［残高登録］＞［財務］＞［共通補助残高］＞［入力区分：経過月発生高］期中に『LucaTech GX』を導入した場合に、期首から仕訳入力開始月までの共通補助の実績（経過月発生高）を登録します。共通補助残高で共通する項目の説明については、次を参照してください。⇒『共通補助残高の画面説明』参照  共通補助の経過月発生高を登録する『取引先登録』のマスターを使用して売掛金の経過月発生高を登録する場合の画面を例に説明します。①　経過月発生高を登録する条件を指定します。 補助区分残高を登録する共通補助を選択します。入力区分［経過月発生高］を選択します。種類会社全体の科目の経過月発生高を登録する場合は［全社］を選択します。部門ごとに科目の経過月発生高を登録する場合は［部門］を選択し、から部門を選択します。科目登録する科目を選択します。月度登録する経過月発生高の月を入力します。②　［条件で出力］をクリックします。③　共通補助ごとに借方・貸方の経過月発生高を入力します。『勘定科目残高』の［経過月発生高］で登録した科目の経過月発生高が表示されるので、一致するように共通補助の実績金額を入力します。④　［更新］をクリックします。⑤　共通補助ごとに登録した科目の金額が表示されるので、［科目バランス］と同じ金額になっていることを確認します。⑥　他の部門の経過月発生高を登録する場合は［種類］で部門を選択し、手順①～手順⑤までを繰り返します。⑦　部門ごとに経過月発生高を登録した場合は、［合計セット］をクリックして、個々に登録した金額を共通補助全体の科目の金額に反映させます。［合計セット］については、次を参照してください。⇒『合計セットを行う』参照</div></div><div id="MAS13014"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 残高登録 &gt; 共通補助の残高を登録する &gt; 過年度実績を登録する（共通補助）</div><div class="search_title">過年度実績を登録する（共通補助）</div><div class="displayText">過年度実績を登録する（共通補助）　［設定］＞［残高登録］＞［財務］＞［共通補助残高］＞［入力区分：過年度実績］他業務システムの共通補助の実績金額を『LucaTech GX』に反映す ...</div><div class="search_word">過年度実績を登録する（共通補助）　［設定］＞［残高登録］＞［財務］＞［共通補助残高］＞［入力区分：過年度実績］他業務システムの共通補助の実績金額を『LucaTech GX』に反映する場合に、過年度の期首残高と実績金額を登録します。登録できる過年度は、最大4年までです。共通補助残高で共通する項目の説明については、次を参照してください。⇒『共通補助残高の画面説明』参照  共通補助の過年度の期首残高と実績金額を登録する『取引先登録』のマスターを使用して売掛金の期首残高と実績を登録する場合の画面を例に説明します。①　 過年度の期首残高と実績を入力する条件を指定します。 補助区分登録する共通補助を選択します。入力区分［過年度実績］を選択します。年度区分登録する過年度の年を選択します。種類会社全体の科目の残高を登録する場合は［全社］を選択します。部門ごとに科目の残高を登録する場合は［部門］を選択し、から部門を選択します。科目残高を登録する科目を選択します。②　［条件で出力］をクリックします。③　共通補助ごとに期首残高と各年月の借方・貸方の実績金額を入力します。金額を入力して［Enter］を押すと、カーソルが右に移動します。期首残高欄について、マイナス金額を入力する場合は、「－」を入力します。ただし、貸倒引当金、減価償却累計額などの減算する科目はマイナス金額にする必要はありません。④　［更新］をクリックします。⑤　他の部門の残高を登録する場合は［種類］で部門を選択し、手順①～手順④までを繰り返します。⑥　部門ごとに残高を登録した場合は、［合計セット］をクリックして、個々に登録した残高を共通補助全体の科目の残高に反映させます。［合計セット］については、次を参照してください。⇒『合計セットを行う』参照</div></div><div id="MAS13016"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 予算登録の概要</div><div class="search_title">予算登録の概要</div><div class="displayText">予算登録の概要『LucaTech GX』では、次の予算登録のメニューがあります。各メニュー、部門ごとに複数の予算の登録が可能です。予算登録を行うには、あらかじめ［設定］＞［導入処理 ...</div><div class="search_word">予算登録の概要『LucaTech GX』では、次の予算登録のメニューがあります。各メニュー、部門ごとに複数の予算の登録が可能です。予算登録を行うには、あらかじめ［設定］＞［導入処理］＞［会社情報］＞［マスター採用情報登録］で予算登録を行うマスターに対して［予算採用］を設定する必要があります。 予算登録のメニュー説明勘定科目予算登録会社全体の予算を科目・科目別補助ごとに登録するメニューです。⇒『科目の予算を登録する』参照共通補助予算登録科目のほかに、取引先や銀行などの共通補助で予算を管理する場合に登録するメニューです。たとえば、売掛金を「A社」「B社」といった取引先別などで予算を管理する場合に使用します。⇒『共通補助の予算を登録する』参照 予算登録では、当期予算と来期予算の2つの年度を登録できます。 登録した当期予算と来期予算は、『決算更新』の実行時に次期会社データへ移送されます。『決算更新』については、次を参照してください。⇒『決算を更新する』参照   『マスター更新』で来期予算の配賦を行っている場合『マスター更新』の［予算配賦更新条件］で［来期の予算配賦は通期で更新する］に✔をつけると、『部門配賦情報』の内容で配賦された金額が来期予算に表示されます。</div></div><div id="MAS13017"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 科目の予算を登録する</div><div class="search_title">科目の予算を登録する</div><div class="displayText">科目の予算を登録する　［設定］＞［予算登録］＞［財務］＞［勘定科目予算登録］科目・科目別補助ごとに予算を登録します。予算の登録は次の方法があります。 月ごとに予算を入力して登録しま ...</div><div class="search_word">科目の予算を登録する　［設定］＞［予算登録］＞［財務］＞［勘定科目予算登録］科目・科目別補助ごとに予算を登録します。予算の登録は次の方法があります。 月ごとに予算を入力して登録します。⇒『月ごとに予算を登録する』参照配賦基準を登録し、配賦基準で年間予算を月別・部門別に自動配賦します。⇒『年間の予算を月別・部門別に配賦して予算を登録する』参照非会計科目を計算式に使用して予算を登録します。⇒『非会計科目を使用して部門の予算を登録する』参照Excelファイルを取り込んで予算を一括で登録します。⇒『Excelファイルを取り込んで予算を登録する』参照  1［…］［予算配賦処理］［予算配賦設定］年間科目の予算を月別・部門別に自動で割り振り、予算配賦を行います。［予算配賦設定］で予算の配賦方法を設定し、［予算配賦処理］で配賦処理を行います。⇒『年間の予算を月別・部門別に配賦して予算を登録する』参照［一括削除］登録した予算を一括で削除します。科目を範囲指定して削除できます。⇒『予算の合計セットを行う』参照［Excel取込］予算を入力したExcelを取り込み、一括で登録します。⇒『Excelファイルを取り込んで予算を登録する』参照2出力条件設定エリア登録する予算を条件指定します。３単位表示する金額の単位を切り替えます。端数が生じたときは、切り捨てて表示されます。出力順序『科目出力順序』で登録したパターンで科目の並び順を変更できます。合計セット部門、または科目別補助ごとに予算を入力した場合に、個別に入力した予算を全体の科目の予算に反映させます。合計セットについては、次を参照してください。⇒『予算の合計セットを行う』参照すべて閉じるすべて展開科目別補助の予算入力欄の表示有無を切り替えることができます。［…］［非会計演算］非会計科目を計算式に使用して予算を登録します⇒『非会計科目を使用して部門の予算を登録する』参照4予算表示エリア入力した予算の金額が表示されます。［＞＞＞］は、画面に表示されていない右側にも入力欄があることを示しています。</div></div><div id="MAS13018"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 科目の予算を登録する &gt; 月ごとに予算を登録する</div><div class="search_title">月ごとに予算を登録する</div><div class="displayText">月ごとに予算を登録する　［設定］＞［予算登録］＞［財務］＞［勘定科目予算登録］月ごとに科目の予算を登録します。①　予算を入力する条件を指定します。 予算区分登録する予算を選択します ...</div><div class="search_word">月ごとに予算を登録する　［設定］＞［予算登録］＞［財務］＞［勘定科目予算登録］月ごとに科目の予算を登録します。①　予算を入力する条件を指定します。 予算区分登録する予算を選択します。［設定］＞［導入処理］＞［会社情報］＞［マスター採用情報登録］において、勘定科目で採用した予算が表示されます。予算年度登録する予算の年度を選択します。参照実績実績データを参照して予算を入力する場合に、表示する実績の年度を選択します。表示できる実績データは過去4年までです。表示しない場合は［なし］を選択します。種類会社全体の科目の予算を入力する場合は、［全社］を選択します。部門ごとに科目の予算を入力する場合は、［部門］を選択し、から部門を選択します。②　［条件で出力］をクリックします。③　科目・科目別補助ごとに予算を入力します。他の月の予算や、実績からコピーして予算を入力する場合は、ファンクションキーを使用します。入力方法については、次を参照してください。⇒『登録済みの予算・実績をコピーして入力する』参照④　［更新］をクリックします。⑤　他の部門の予算を登録する場合は［種類］で部門を選択し、手順①～手順④までを繰り返します。⑥　科目別補助、部門ごとに予算を登録した場合は、［合計セット］をクリックして、個々に登録した予算を全体の科目の予算に反映させます。科目別補助や部門ごとに予算を登録しただけでは、会社全体の科目の予算には反映されません。登録した予算を会社全体の科目の予算に反映させるには、合計セットを行う必要があります。［合計セット］については、次を参照してください。⇒『予算の合計セットを行う』参照 登録済みの予算・実績をコピーして入力する実績や他の月の予算などをコピーして予算を入力する場合は、ファンクションキーを使用します。 他の予算区分で登録した予算をコピーする（F1 予算コピー）他の予算区分で登録した予算をコピーします。   種類会社全体の科目に予算をコピーして入力する場合は［全社］を選択します。特定の部門の科目に予算をコピーして入力する場合は［部門］を選択します。部門［種類］で［部門］を選択した場合に、から部門を選択します。予算年度コピーする予算年度を選択します。［当期予算から来期予算］［コピー元］の当期予算を［コピー先］の来期予算にコピーします。［当期予算］［コピー元］の当期予算を［コピー先］の当期予算にコピーします。［来期予算］［コピー元］の来期予算を［コピー先］の来期予算にコピーします。コピー元コピー元とする予算を選択します。コピー先コピー先とする予算を選択します。洗い替えで更新コピーしたときの洗い替えの有無を選択します。［洗い替えする］コピー先の予算がすべて削除され、コピー元の予算で上書きされます。コピー元の予算が0円の科目は、0円になります。［洗い替えしない］コピー元で予算を登録している科目のみコピー先に反映されます。コピー元の予算が0円の科目は、上書きされません。 他の月に入力した予算をコピーする（F3 範囲コピー）他の月に入力した月のデータをコピーします。  コピー元コピー元とする月を入力します。コピー先コピー先とする月を範囲指定します。コピーする範囲一部の科目のみをコピーする場合に範囲指定します。 前月分をコピーする（F4 前月コピー）前月に入力した予算をコピーします。予算入力画面でコピー先となる箇所にカーソルをあて、［F4 前月コピー］を押します。 実績をコピーする（F5 実績コピー）実績をコピーします。［参照実績］で実績を表示している場合に、実績をコピーして予算を入力できます。  コピー先コピー先とする月を範囲指定します。実績割合実績値に対してコピーする割合を入力します。コピーする範囲コピーする科目を範囲指定する場合に指定します。何も指定しない場合は、［コピー元］で指定した月のデータで上書きされます。 予算の合計セットを行う　［設定］＞［予算登録］＞［勘定科目予算登録］＞［合計セット］部門や科目別補助、共通補助ごとに予算を登録しただけでは、全体の科目の予算には反映されないため、合計セットを行い、全体の科目に対して予算を反映する必要があります。合計セットは、予算登録画面の［種類］で集計先を選択し、［合計セット］をクリックした後の［合計セット］画面で［セット種類］に集計元を選択して行います。 （例）科目別補助の予算を科目の予算に反映させる場合  なお、科目別補助または共通補助に加えて、部門でもを管理している場合は、先に科目別補助または共通補助から部門に対して合計セットを行い、その後部門から科目に対して合計セットを行います。  合計セットを行う①　予算登録画面で集計先を選択し、［条件で出力］をクリックします。［全社］会社全体の科目に対して部門・科目別補助・共通補助の合計セットを行う場合に選択します。［部門］特定の部門の科目に対して科目別補助・共通補助の合計セットを行う場合に選択します。②　［合計セット］をクリックします。［合計セット］画面が別ウィンドウで開きます。③　合計セット行う条件を指定します。 セット種類集計対象の内訳を選択します。セット範囲特定の科目で表示を絞り込む場合に、開始と終了の科目コードを指定します。予算配賦予算配賦で設定した結果もセットするかどうかを選択します。 ④　［条件で出力］をクリックします。全体の科目の予算と、部門や科目別補助別に登録した予算に差異がある科目は、［ステータス］欄に［差異あり］が表示されます。⑤　［差異あり］の科目の［合計前］と［合計後］の金額を確認し、［合計セット反映］をクリックします。［差異あり］の表示がなくなり、［合計後］の金額が全体の科目の予算にセットされます。⑥　［合計セット］画面の［×］をクリックして画面を閉じます。⑦　予算登録の画面を開き、をクリックします。部門や科目別補助、共通補助の予算が科目の予算に反映されます。</div></div><div id="MAS13021"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 科目の予算を登録する &gt; 年間の予算を月別・部門別に配賦して予算を登録する</div><div class="search_title">年間の予算を月別・部門別に配賦して予算を登録する</div><div class="displayText">年間の予算を月別・部門別に配賦して予算を登録する年間科目の予算を月別・部門別に自動で割り振る（配賦する）場合は、予算配賦を行います。予算配賦を行うには、［…］から［予算配賦設定］で ...</div><div class="search_word">年間の予算を月別・部門別に配賦して予算を登録する年間科目の予算を月別・部門別に自動で割り振る（配賦する）場合は、予算配賦を行います。予算配賦を行うには、［…］から［予算配賦設定］で配賦方法を設定した後、［予算配賦処理］で年間予算を入力して配賦を実行します。配賦金額の合計と年間予算に端数が発生した場合は、先頭月で調整されます。 複数の条件を組み合わせて２段階以上の条件で配賦する場合は、［設定］＞［マスター登録処理］＞［部門配賦情報］の［予算配賦情報］タブで行います。『部門配賦情報』については、次を参照してください。⇒『予算の配賦情報を登録する』参照 予算配賦で行える配賦予算配賦では、次のような配賦が行えます。●全社の科目の年間予算を月別にのみ配賦する●全社の科目の年間予算を月別に配賦し、さらに部門別に配賦する●全社の科目の年間予算を部門の年間予算に配賦する●部門の科目の年間予算を部門の月別に配賦する 予算配賦の配賦方法予算配賦では、次の４つの配賦方法があります。 実績金額を基準に配賦（①）全社または部門の科目について、実績から算出した月別割合をもとに年間予算を配賦します。たとえば、使用する実績が「前年実績」で、「売上高」の年間予算と前年実績が次の場合、配賦方法は次のようになります。 年間予算：1,500,000円配賦割合の計算式：月別実績÷合計実績配賦割金額の計算式：年間予算×配賦割合月前年実績配賦割合配賦金額4月200,000円20％（200,000円÷1,000,000円）300,000円（1,500,000円×20％）5月300,000円30％（300,000円÷1,000,000円）450,000円（1,500,000円×30％）6月500,000円50％（500,000円÷1,000,000円）750,000円（1,500,000円×50％）合計1,000,000円100%1,500,000円 12か月を等分して配賦（②）全社の科目について、年間予算を均等に12分割して配賦します。たとえば、「売上高」の年間予算が次の場合、配賦方法は次のようになります。 売上高の年間予算：1,500,000円配賦金額の計算式：年間予算÷12月配賦金額4月125,000円（1,500,000円÷12か月）5月125,000円（1,500,000円÷12か月）6月125,000円（1,500,000円÷12か月）7月…125,000円（1,500,000円÷12か月）…合計1,500,000円 月別に任意の配賦係数を設定して配賦（③）全社の科目について、［実績金額基準］［12か月等分］以外の方法で配賦したい場合に、月ごとに任意の配賦基準値を設定します。設定した配賦基準値をもとに割合が算出され、算出された月別割合をもとに年間予算を配賦します。たとえば、「売上高」の年間予算と配賦基準が次の場合、配賦方法は次のようになります。 売上高の年間予算：1,500,000円配賦割合：月別配賦基準（配賦係数）÷基準値合計配賦金額：年間予算×配賦割合月配賦係数配賦割合配賦金額4月3025％（30÷120）375,000円   (1,500,000円×25％)5月3025％（30÷120）375,000円   (1,500,000円×25％)6月6050％（60÷120）750,000円   (1,500,000円×50％)合計120100%1,500,000円 部門別に任意の配賦係数を設定して配賦（④）部門の科目を［実績金額基準］以外の方法で配賦する場合は、部門ごとに任意の配賦基準値を設定します。設定した基準値から部門割合を算出し、その割合に基づいて月別に配賦された予算を部門に配賦します。たとえば、「売上高」の月別予算と配賦基準が次の場合、配賦方法は次のようになります。 月別の予算4月：750,000円5月：750,000円6月：300,000円配賦割合の計算式：部門配賦基準（配賦係数）÷基準値合計配賦金額の計算式：年間予算×配賦割合 配賦係数配賦割合配賦金額4月5月6月札幌支社1012.5％（10÷80）93,750円（750,000円×12.5％）93,750円（750,000円×12.5％）37,500円（300,000円×12.5％）仙台営業2025％（20÷80）187,500円（750,000円×25％）187,500円（750,000円×25％）75,000円（300,000円×25％）岩手支社5062.5％（50÷80）468,750円（750,000円×62.5％）93,750円（750,000円×62.5％）187,500円（300,000円×62.5％）合計80100%750,000円750,000円300,000円  予算配賦のイメージ予算配賦の設定を行う　［設定］＞［予算登録］＞［勘定科目予算登録］＞［予算配賦設定］年間の予算を月別に配賦します。各科目に対して次の図の赤枠（［月別配賦基準］［部門別配賦基準］）を設定します。 月別配賦基準科目ごとに月別の配賦方法を設定します。なお、すべての科目に対して一括で配賦方法を設定する場合は、［月別配賦基準デフォルト設定］で［実績金額基準］または［12か月等分］のどちらかを選択します。［実績金額基準］実績をもとに配賦基準値を設定して配賦します。［12か月等分］年間予算を均等に12分割して配賦します。［実績金額基準］［12か月等分］以外の方法で配賦する場合は、先に［月別配賦基準登録］タブで月別の配賦基準値を設定した後、設定した配賦基準値を選択します。⇒『［月別配賦基準登録］タブ』参照部門別配賦基準部門を採用している科目に対して、部門別の配賦基準を設定します。［実績金額基準］実績をもとに配賦基準値を設定して配賦します。［実績金額基準］以外の方法で配賦する場合は、先に［部門配賦基準］タブで部門別の配賦基準値を設定した後、設定した配賦基準値を選択します。⇒『［部門別配賦基準］タブ』参照 全社の年間予算を月別にのみ配賦する場合［月別配賦基準］の設定目的に応じた配賦方法（［実績金額基準］または［12か月等分］、それ以外の配賦方法）を設定します。［部門別配賦基準］の設定［部門別配賦基準］タブですべての部門の配賦係数を0のパターンを登録し、部門を採用している科目に対して登録したパターンを選択します。 全社の年間予算を月別に配賦し、さらに部門別に配賦する場合［月別配賦基準］の設定目的に応じた配賦方法（［実績金額基準］［12か月等分］、またはそれ以外の配賦方法）を設定します。［部門別配賦基準］の設定目的に応じた配賦方法（［実績金額基準］またはそれ以外の配賦方法）を設定します。 全社の年間予算を部門の年間予算に配賦する場合［月別配賦基準］の設定［月別配賦基準登録］タブですべての月の配賦係数を0のパターンを登録し、部門を採用している科目に対して登録したパターンを選択します。［部門別配賦基準］の設定目的に応じた配賦方法（［実績金額基準］またはそれ以外の配賦方法）を設定します。 部門の年間予算を部門の月別に配賦する場合［月別配賦基準］の設定目的に応じた配賦方法（［実績金額基準］［12か月等分］、またはそれ以外の配賦方法）を設定します。［部門別配賦基準］の設定特に設定を修正する必要はありません。 ［月別配賦基準登録］タブ月ごとに任意の配賦基準値を設定します。設定した配賦基準値をもとに配賦金額が計算されます。月のすべて配賦係数が0の場合は、配賦は行われません。 月別配賦基準コード未使用のコードを入力し、月別配賦基準の名称を入力します。配賦係数任意の配賦基準値を小数点以下第4位以下で入力します。 ［部門別配賦基準］タブ部門ごとに配賦基準値を設定します。設定した配賦基準値をもとに配賦金額が計算されます。部門のすべて配賦係数が0の場合は、配賦は行われません。 部門別配賦基準コード未使用のコードを入力し、部門別配賦基準の名称を入力します。配賦係数任意の配賦基準値を小数点以下第4位以下で入力します。 予算配賦を実行する　［設定］＞［予算登録］＞［勘定科目予算登録］＞［予算配賦処理］入力した年間予算について、［月別配賦基準］で設定した配賦基準や部門を適用している科目の場合は、［部門別配賦基準］で設定した内容に基づき、自動で配賦が行われます。なお、配賦を行うためには、あらかじめ［予算配賦設定］で科目ごとに配賦設定をしておく必要があります。 ①　予算を入力する条件を指定します。 予算区分登録する予算を選択します。［設定］＞［導入処理］＞［会社情報］＞［マスター採用情報登録］において、勘定科目で採用した予算が表示されます。予算年度登録する予算の年度を選択します。当期・来期の予算の用途については、次を参照してください。⇒『予算登録の概要』参照参照実績『予算配賦設定』で［実績金額基準］を設定している場合に、配賦割合を算出する実績の年度を選択します。［実績金額基準］以外を設定している場合は、実績データを参照して予算を入力する場合に、表示する実績の年度を選択します。表示できる実績データは過去4年までです。種類会社全体の科目の年間予算を基に配賦する場合は、［全社］を選択します。［月別配賦基準］［部門別配賦基準］両方の配賦方法に基づいて年間予算が配賦されます。部門の科目の年間予算を基に配賦する場合は、［部門］を選択します。［月別配賦基準］の配賦方法に基づいて部門の年間予算が配賦されます。②　［条件で出力］をクリックします。予算登録画面で予算を登録済みの場合は、登録した予算が表示されます。③　配賦を行う科目・科目別補助の［年間予算］を入力します。配賦しない科目・科目別補助は、ここでは予算を入力しません（ここで予算を登録すると、配賦された金額で予算が上書きされるため）。参照実績の金額をコピーする場合は、［F5 実績コピー］を押します。実績コピーについては、次を参照してください。⇒『実績をコピーする（F5 実績コピー）』参照④　［更新］をクリックします。</div></div><div id="MAS13024"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 科目の予算を登録する &gt; 非会計科目を使用して部門の予算を登録する</div><div class="search_title">非会計科目を使用して部門の予算を登録する</div><div class="displayText">非会計科目を使用して部門の予算を登録する　［設定］＞［予算登録］＞［勘定科目予算登録］＞［非会計演算］非会計科目を使用した計算式を作成し、その計算結果を部門の予算として登録します。 ...</div><div class="search_word">非会計科目を使用して部門の予算を登録する　［設定］＞［予算登録］＞［勘定科目予算登録］＞［非会計演算］非会計科目を使用した計算式を作成し、その計算結果を部門の予算として登録します。たとえば、「交際費」という科目に対して、「単価×人数」で予算を登録したい場合などに利用できます。この場合、「人数」を非会計科目として科目を登録する必要があります。非会計科目の概要については次を参照してください。⇒『非会計科目について』参照①　予算登録画面の［…］から［非会計演算］をクリックします。②　［新規パターン追加］をクリックします。別ウィンドウで計算式の登録画面が表示されます。③　［パターンNo.］でNoとパターン名称を入力し、各項目を設定します。予算セット対象期間登録する予算の期間を入力します。入力できる期間は、当期の会計期間開始から翌期の終了までの間です。予算区分登録する予算を選択します。科目登録する予算の科目を選択します。部門登録する予算の部門を選択します。参照マスター非会計科目計算を行う非会計科目を選択します。マスター計算に使用する非会計科目の実績または予算区分を選択します。［当年実績］非会計科目の当年実績を使用して計算します。現在は使用できません。［予算］予算登録画面で登録した非会計科目の数値を使用します。［前年実績］非会計科目の過年度実績を使用して計算します。予算セット計算式単価計算式に使用する単価を入力します。たとえば、「一人当たりの単価×人数」という計算式で「人数」を非会計科目に設定した場合、「一人当たりの単価」を入力します。加算金額計算結果に対して金額を調整する場合に入力します。 ④　このまま計算式を反映させて予算を登録する場合は、［実行］をクリックします。計算式のみ登録する場合は、［保存］をクリックします。⑤　［×］をクリックして、計算式の登録画面を閉じます。実行後、予算登録画面に計算結果が反映されます。 登録したパターンは、『勘定科目予算登録_非会計演算』画面に追加されます。次回以降、ここから計算を行うパターンを選択し、実行できます。</div></div><div id="MAS13025"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 科目の予算を登録する &gt; Excelファイルを取り込んで予算を登録する</div><div class="search_title">Excelファイルを取り込んで予算を登録する</div><div class="displayText">Excelファイルを取り込んで予算を登録する　［設定］＞［予算登録］＞［インポート］＞［Excel取込］Excelファイルを取り込んで予算を一括で登録します。取込用のExcelファ ...</div><div class="search_word">Excelファイルを取り込んで予算を登録する　［設定］＞［予算登録］＞［インポート］＞［Excel取込］Excelファイルを取り込んで予算を一括で登録します。取込用のExcelファイルはシステムから出力します。 登録できる予算は次のとおりです。予算の種類登録できる予算科目予算科目別の予算（月別・年間での予算登録が可能）科目別補助別の予算部門別の予算（月別・年間での予算登録が可能）部門・科目別補助別の予算共通補助予算共通補助別の予算部門・共通補助別の予算 Excelファイルから登録できる予算は12か月と決算月（決算月1）です。決算月2～3や、中間決算月を登録する場合は、取込後、画面から入力します。 また、科目の年間予算のみを取り込み、［予算配賦処理］で月別・部門別に配賦を行うことも可能です。 取込用のExcelファイルを出力する　［設定］＞［予算登録］＞［インポート］＞［Excel取込］＞［テンプレート］タブ①　『Excel取込』または『勘定科目予算登録』の［…］から［Excel取込］をクリックします。②　［テンプレート］タブで、出力条件を選択します。 対象マスター予算を登録するマスターの種類を選択します。［予算配賦処理］で配賦を行う場合は、［科目］または［部門］を選択します。共通補助［対象マスター］で［共通補助予算］を選択した場合に、出力する共通補助を選択します。コード範囲［対象マスター］で［部門予算］［部門科目別補助予算］［共通補助予算］［部門共通補助予算］を選択した場合に、出力する範囲を選択します。参照コピー区分実績金額や他の予算区分で登録した予算を出力する場合は［実績参照する］を選択します。参照実績［参照コピー区分］で［実績参照する］を選択した場合に、出力する実績の年度を選択します。実績割合［参照コピー区分］で［実績参照する］を選択した場合に、実績値に対して出力する割合を入力します。100を入力すると、実績値と同じ金額が出力されます。予算区分［参照コピー区分］で［実績参照する］を選択した場合、予算区分を選択します。選択した予算区分に予算が登録されている場合は、予算の年間金額が出力されます。予算年度予算年度を選択します。③　［作成］をクリックします。にファイルが出力されます。④　出力されたExcelファイルに予算を入力します。［Excelファイル］（勘定科目のファイル）Excelファイルのレイアウト列名対象マスター説明科目コードすべて科目コードが表示されます。［科目別補助予算］［部門予算］［部門科目別補助予算］［共通補助予算］［部門共通補助］を選択した場合は、補助を採用している科目のみ表示されます。科目名すべて科目名が表示されます。科目別補助コード科目別補助予算部門科目別補助予算科目別補助のコードが表示されます。科目別補助名科目別補助予算部門科目別補助予算科目別補助名が表示されます。補助コード共通補助予算部門共通補助予算補助コードが表示されます。補助名共通補助予算部門共通補助予算補助名が表示されます。年間予算勘定科目予算部門予算年間予算を入力します。［予算配賦処理］で配賦を行う場合は、ここに入力した予算が使用されます。［参照実績］で［参照コピー区分］を選択した場合は、［予算区分］と［予算年度］で選択した予算の年間金額が出力されます。YYYY年MM月すべて月別に予算金額を入力します。［参照実績］で［参照コピー区分］を選択している場合は、［参照実績］［実績割合］の結果が出力されます。決算月予算額すべて決算月1の予算を入力します。合計予算額すべてExcelに予算を入力すると、科目ごとの合計金額が自動で表示されます。参考値のため、予算には取り込まれません。 ［対象マスター］で部門を含むマスターを選択した場合、部門ごとにシートが分かれたExcelファイルが出力されます。各シートで予算を入力します。１つのExcelファイルに出力される部門は50までです。部門が51以上の場合は、Excelファイルが分かれて出力されます。 また、最後の行に表示される「合計」は、Excelファイルに予算を入力すると月ごとの合計金額が自動で表示されます。参考値のため、予算には取り込まれません。  予算を入力したExcelファイルを取り込む　［設定］＞［予算登録］＞［インポート］＞［Excel取込］＞［Excel取込］タブ①　『Excel取込』または『勘定科目予算登録』の［…］から［Excel取込］をクリックします。②　［Excel取込］タブで条件を指定します。 対象マスター取り込む予算のマスターの種類を選択します。共通補助［対象マスター］で［共通補助予算］を選択した場合に、取り込む共通補助を選択します。予算区分取り込む予算の予算区分を選択します。年度区分取り込む予算の年度を選択します。取込区分［対象マスター］に対して、取り込みの方法を選択します。［0：更新］Excelファイルに入力した予算のみ登録されます。Excelファイルの予算が0円の科目は、上書きされません。［1：洗替］登録済みの予算がすべて削除され、Excelファイルに入力した予算で上書きされます。Excelファイルの予算が0円の科目は、0円になります取込ファイル［ファイル選択］をクリックして取り込むExcelファイルをドラッグ＆ドロップまたは選択します。③　［取込］をクリックします。取込が完了すると、ヘッダーに取り込み結果の通知と、に取り込んだ情報（予算連結リストまたはエラーリスト）のPDFファイルが出力されます。予算連結リスト・エラーリストについては次を参照してください。⇒『予算連結リスト・予算エラーリストについて』参照④　予算取込後は、予算登録画面で予算内容を確認します。科目・科目別補助の予算の場合は『勘定科目予算登録』の［全社］、部門ごとに予算を入力した場合は［部門］を選択すると確認できます。共通補助の予算の場合は『共通補助予算登録』の［全社］、部門ごとに予算を入力した場合は［部門］を選択すると確認できます。⑤　必要に応じて他の決算月の入力や、配賦処理の実行を行います。決算月2～3や、中間決算月を登録する場合は、予算登録画面から入力します。［予算配賦処理］で配賦を行う場合は、先に［配賦予算設定］で配賦方法を設定してから行います。［予算配賦処理］で［年間予算］に予算が入力されていることを確認し、入力欄にカーソルを置いて［Enter］を押して［更新］をクリックします。 予算連結リスト・予算エラーリストについてExcelファイルを取り込むと、から連結リスト・エラーリストをダウンロードでき、取込結果を確認できます。 ［連結リスト］予算の取込が完了した場合に出力されます。取り込んだすべての科目と予算の情報が出力されます。  ［エラーリスト］予算が取り込まれなかった場合に出力されます。エラーとなっている科目の情報が出力されます。エラーの科目が一つでもあると、予算は取り込まれません。</div></div><div id="MAS13028"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 科目の予算を登録する &gt; 登録した予算を削除する</div><div class="search_title">登録した予算を削除する</div><div class="displayText">登録した予算を削除する登録した予算を一括で削除します。 ［…］から［一括削除］をクリックします。 一括削除の画面が開きます。削除する予算の条件を指定して［削除］をクリックします。  ...</div><div class="search_word">登録した予算を削除する登録した予算を一括で削除します。 ［…］から［一括削除］をクリックします。 一括削除の画面が開きます。削除する予算の条件を指定して［削除］をクリックします。 予算区分削除する予算区分を選択します。予算年度削除する予算年度を選択します。種類削除する予算の種類を選択します。［全社］全社の科目の予算を削除する場合に選択します。［部門］特定の部門の予算を削除する場合に選択します。部門［種類］で部門を選択した場合に、削除する部門の範囲を指定します。配賦処理実行前の金額に戻す場合は、［配賦金額のみ削除］を［適用する］にします。科目削除する科目の範囲を指定します。指定した科目に対して、科目別補助の予算のみ削除する場合は、［科目別補助のみ削除］を［適用する］にします。対象月削除する月の範囲を指定します。</div></div><div id="MAS13029"><div class="search_breadcrumbs">導入処理（残高・予算） &gt; 予算登録 &gt; 共通補助の予算を登録する</div><div class="search_title">共通補助の予算を登録する</div><div class="displayText">共通補助の予算を登録する　［設定］＞［予算登録］＞［財務］＞［共通補助予算登録］科目の予算登録に加え、取引先や銀行などの共通補助を用いて予算を管理する場合は、ここで共通補助の予算を ...</div><div class="search_word">共通補助の予算を登録する　［設定］＞［予算登録］＞［財務］＞［共通補助予算登録］科目の予算登録に加え、取引先や銀行などの共通補助を用いて予算を管理する場合は、ここで共通補助の予算を登録します。たとえば、売掛金を「A社」「B社」といった取引先別などで予算の推移を確認できます。予算の登録は画面から手入力する方法と、Excelファイルで一括で登録する方法があります。ここでは、予算を手入力する方法について説明します。予算を一括で登録する場合は、『Excel取込』で行います。一括で登録する方法については、次を参照してください。⇒『予算を入力したExcelファイルを取り込む』参照 1［…］［…］登録した予算を一括で削除します。科目を範囲指定して削除できます。⇒『登録した予算を削除する』参照2出力条件設定エリア登録する予算を条件指定します。3予算表示エリア入力した予算の金額が表示されます。［単位］は、表示する金額の単位を切り替えます。端数が生じたときは、切り捨てて表示されます。［＞＞＞］は、画面に表示されていない右側にも入力欄があることを示しています。  共通補助の予算を登録する①　予算を入力する条件を指定します。 補助区分登録する予算の補助を選択します予算区分登録する予算を選択します。［設定］＞［導入処理］＞［会社情報］＞［マスター採用情報登録］において、勘定科目で採用した予算が表示されます。予算年度登録する予算の年度を選択します。参照実績実績データを参照して予算を入力する場合に、表示する実績の年度を選択します。表示できる実績データは過去4年までです。表示しない場合は［なし］を選択します。種類会社全体の科目の予算を入力する場合は、［全社］を選択します。部門ごとに科目の予算を入力する場合は、［部門］を選択し、から部門を選択します。  部門別に共通補助予算を入力した場合、全社の共通補助の予算に対して［合計セット］はできません。また、『勘定科目予算登録』の全社の科目に対して［合計セット］はできません。共通補助全体で予算を管理したい場合は、必ず共通補助の全社の科目にも予算を登録してください。②　［条件で出力］をクリックします。③　共通補助ごとに予算を入力します。他の月の予算や、実績からコピーして予算を入力する場合は、ファンクションキーを使用します。入力方法については、次を参照してください。⇒『登録済みの予算・実績をコピーして入力する』参照④　［更新］をクリックします。⑤　他の部門の予算を登録する場合は［種類］で部門を選択し、手順①～手順④までを繰り返します。⑥　『勘定科目予算登録』の［合計セット］の［セット種類］で［共通補助］を選択して合計セットを行います。共通補助の予算を登録しただけでは会社全体の科目には反映されません。全体の科目に反映させるには、必ず合計セットを行ってください。［合計セット］については、次を参照してください。⇒『予算の合計セットを行う』参照</div></div></div>');
// ========================================
// グローバル変数定義
// ========================================

// MutationObserver機能用のグローバル変数
var currentSearchValue = ""; // 現在の検索キーワード
var mutationObserver = null; // MutationObserverインスタンス
var debounceTimer = null; // DOM変更用のデバウンスタイマー

// jQueryセレクタキャッシュ
var $cachedElements = {
    iframe: null,
    searchField: null,
    searchResultItemsBlock: null,
    searchResultsEnd: null,
    searchMsg: null,
    searchInput: null
};

// セレクタマップ（キャッシュ機構の効率化）
var selectorMap = {
    iframe: "iframe.topic",
    searchField: ".wSearchField",
    searchResultItemsBlock: ".wSearchResultItemsBlock",
    searchResultsEnd: ".wSearchResultsEnd",
    searchMsg: "#searchMsg",
    searchInput: ".search-input"
};

// HTMLエンティティ復元用の正規表現（効率化のためグローバル定義）
var htmlEntityRegexes = {
    nbsp: /&nbsp;(?=[^<>]*<)/gm,
    gt: /&gt;(?=[^<>]*<)/gm,
    lt: /&lt;(?=[^<>]*<)/gm,
    quot: /&quot;(?=[^<>]*<)/gm,
    amp: /&amp;(?=[^<>]*<)/gm
};

// 文字変換マップ（効率化のため初期化時に正規表現を構築）
var characterMappings = (function () {
    // 文字変換用の配列定義（配列リテラルに変更）
    var wide = ["０", "１", "２", "３", "４", "５", "６", "７", "８", "９", "ａ", "ｂ", "ｃ", "ｄ", "ｅ", "ｆ", "ｇ", "ｈ", "ｉ", "ｊ", "ｋ", "ｌ", "ｍ", "ｎ", "ｏ", "ｐ", "ｑ", "ｒ", "ｓ", "ｔ", "ｕ", "ｖ", "ｗ", "ｘ", "ｙ", "ｚ", "ガ", "ギ", "グ", "ゲ", "ゴ", "ザ", "ジ", "ズ", "ゼ", "ゾ", "ダ", "ヂ", "ヅ", "デ", "ド", "バ", "ビ", "ブ", "ベ", "ボ", "パ", "ピ", "プ", "ペ", "ポ", "。", "「", "」", "、", "ヲ", "ァ", "ィ", "ゥ", "ェ", "ォ", "ャ", "ュ", "ョ", "ッ", "ー", "ア", "イ", "ウ", "エ", "オ", "カ", "キ", "ク", "ケ", "コ", "サ", "シ", "ス", "セ", "ソ", "タ", "チ", "ツ", "テ", "ト", "ナ", "ニ", "ヌ", "ネ", "ノ", "ハ", "ヒ", "フ", "ヘ", "ホ", "マ", "ミ", "ム", "メ", "モ", "ヤ", "ユ", "ヨ", "ラ", "リ", "ル", "レ", "ロ", "ワ", "ン"];
    var narrow = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "ｶﾞ", "ｷﾞ", "ｸﾞ", "ｹﾞ", "ｺﾞ", "ｻﾞ", "ｼﾞ", "ｽﾞ", "ｾﾞ", "ｿﾞ", "ﾀﾞ", "ﾁﾞ", "ﾂﾞ", "ﾃﾞ", "ﾄﾞ", "ﾊﾞ", "ﾋﾞ", "ﾌﾞ", "ﾍﾞ", "ﾎﾞ", "ﾊﾟ", "ﾋﾟ", "ﾌﾟ", "ﾍﾟ", "ﾎﾟ", "｡", "｢", "｣", "､", "ｦ", "ｧ", "ｨ", "ｩ", "ｪ", "ｫ", "ｬ", "ｭ", "ｮ", "ｯ", "ｰ", "ｱ", "ｲ", "ｳ", "ｴ", "ｵ", "ｶ", "ｷ", "ｸ", "ｹ", "ｺ", "ｻ", "ｼ", "ｽ", "ｾ", "ｿ", "ﾀ", "ﾁ", "ﾂ", "ﾃ", "ﾄ", "ﾅ", "ﾆ", "ﾇ", "ﾈ", "ﾉ", "ﾊ", "ﾋ", "ﾌ", "ﾍ", "ﾎ", "ﾏ", "ﾐ", "ﾑ", "ﾒ", "ﾓ", "ﾔ", "ﾕ", "ﾖ", "ﾗ", "ﾘ", "ﾙ", "ﾚ", "ﾛ", "ﾜ", "ﾝ"];
    var highlight = ["(?:０|0)", "(?:１|1)", "(?:２|2)", "(?:３|3)", "(?:４|4)", "(?:５|5)", "(?:６|6)", "(?:７|7)", "(?:８|8)", "(?:９|9)", "(?:ａ|a)", "(?:ｂ|b)", "(?:ｃ|c)", "(?:ｄ|d)", "(?:ｅ|e)", "(?:ｆ|f)", "(?:ｇ|g)", "(?:ｈ|h)", "(?:ｉ|i)", "(?:ｊ|j)", "(?:ｋ|k)", "(?:ｌ|l)", "(?:ｍ|m)", "(?:ｎ|n)", "(?:ｏ|o)", "(?:ｐ|p)", "(?:ｑ|q)", "(?:ｒ|r)", "(?:ｓ|s)", "(?:ｔ|t)", "(?:ｕ|u)", "(?:ｖ|v)", "(?:ｗ|w)", "(?:ｘ|x)", "(?:ｙ|y)", "(?:ｚ|z)", "(?:ガ|ｶﾞ)", "(?:ギ|ｷﾞ)", "(?:グ|ｸﾞ)", "(?:ゲ|ｹﾞ)", "(?:ゴ|ｺﾞ)", "(?:ザ|ｻﾞ)", "(?:ジ|ｼﾞ)", "(?:ズ|ｽﾞ)", "(?:ゼ|ｾﾞ)", "(?:ゾ|ｿﾞ)", "(?:ダ|ﾀﾞ)", "(?:ヂ|ﾁﾞ)", "(?:ヅ|ﾂﾞ)", "(?:デ|ﾃﾞ)", "(?:ド|ﾄﾞ)", "(?:バ|ﾊﾞ)", "(?:ビ|ﾋﾞ)", "(?:ブ|ﾌﾞ)", "(?:ベ|ﾍﾞ)", "(?:ボ|ﾎﾞ)", "(?:パ|ﾊﾟ)", "(?:ピ|ﾋﾟ)", "(?:プ|ﾌﾟ)", "(?:ペ|ﾍﾟ)", "(?:ポ|ﾎﾟ)", "(?:。|｡)", "(?:「|｢)", "(?:」|｣)", "(?:、|､)", "(?:ヲ|ｦ)", "(?:ァ|ｧ)", "(?:ィ|ｨ)", "(?:ゥ|ｩ)", "(?:ェ|ｪ)", "(?:ォ|ｫ)", "(?:ャ|ｬ)", "(?:ュ|ｭ)", "(?:ョ|ｮ)", "(?:ッ|ｯ)", "(?:ー|ｰ)", "(?:ア|ｱ)", "(?:イ|ｲ)", "(?:ウ|ｳ)", "(?:エ|ｴ)", "(?:オ|ｵ)", "(?:カ|ｶ)", "(?:キ|ｷ)", "(?:ク|ｸ)", "(?:ケ|ｹ)", "(?:コ|ｺ)", "(?:サ|ｻ)", "(?:シ|ｼ)", "(?:ス|ｽ)", "(?:セ|ｾ)", "(?:ソ|ｿ)", "(?:タ|ﾀ)", "(?:チ|ﾁ)", "(?:ツ|ﾂ)", "(?:テ|ﾃ)", "(?:ト|ﾄ)", "(?:ナ|ﾅ)", "(?:ニ|ﾆ)", "(?:ヌ|ﾇ)", "(?:ネ|ﾈ)", "(?:ノ|ﾉ)", "(?:ハ|ﾊ)", "(?:ヒ|ﾋ)", "(?:フ|ﾌ)", "(?:ヘ|ﾍ)", "(?:ホ|ﾎ)", "(?:マ|ﾏ)", "(?:ミ|ﾐ)", "(?:ム|ﾑ)", "(?:メ|ﾒ)", "(?:モ|ﾓ)", "(?:ヤ|ﾔ)", "(?:ユ|ﾕ)", "(?:ヨ|ﾖ)", "(?:ラ|ﾗ)", "(?:リ|ﾘ)", "(?:ル|ﾙ)", "(?:レ|ﾚ)", "(?:ロ|ﾛ)", "(?:ワ|ﾜ)", "(?:ン|ﾝ)"];

    // 全角→半角の変換マップを作成
    var wideToNarrowMap = {};
    var narrowToHighlightMap = {};

    for (var i = 0; i < wide.length; i++) {
        wideToNarrowMap[wide[i]] = narrow[i];
        // 半角文字をキーにしてハイライトパターンをマップ
        narrowToHighlightMap[narrow[i]] = highlight[i];
    }

    // 全角文字の正規表現パターンを作成（エスケープ処理を含む）
    var wideCharsPattern = wide.map(function (char) {
        return char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }).join('|');

    var wideToNarrowRegex = new RegExp(wideCharsPattern, 'g');

    return {
        wideToNarrowMap: wideToNarrowMap,
        narrowToHighlightMap: narrowToHighlightMap,
        wideToNarrowRegex: wideToNarrowRegex,
        // 効率的な変換関数
        convertWideToNarrow: function (text) {
            return text.replace(wideToNarrowRegex, function (match) {
                return wideToNarrowMap[match] || match;
            });
        }
    };
})();

// ========================================
// 基本ユーティリティ関数（依存なし）
// ========================================

// セレクタ用のエスケープ処理
function selectorEscape(val) {
    return val.replace(/[-\/\\^$*+?.()|[\]{}\!]/g, '\\$&');
}

// 文字列を正規化（全角→半角カナ変換、小文字化）
function normalizeForSearch(text) {
    var normalized = text.toLowerCase();
    return characterMappings.convertWideToNarrow(normalized);
}

// HTMLエンティティを復元
function decodeHtmlEntities(html) {
    return html
        .replace(htmlEntityRegexes.nbsp, "　")
        .replace(htmlEntityRegexes.gt, ">")
        .replace(htmlEntityRegexes.lt, "<")
        .replace(htmlEntityRegexes.quot, '"')
        .replace(htmlEntityRegexes.amp, "&");
}

// ========================================
// キャッシュ管理関数
// ========================================

// キャッシュを初期化
function initializeCachedElements() {
    for (var key in selectorMap) {
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
}

// キャッシュされた要素を取得（存在チェック付き）
function getCachedElement(key) {
    if (!$cachedElements[key] || $cachedElements[key].length === 0) {
        // キャッシュが無効な場合は再取得
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
    return $cachedElements[key];
}

// ========================================
// 検索処理関連関数（依存関係順）
// ========================================

// 検索語を正規化してエスケープ
function prepareSearchWords(searchValue) {
    // 全角・半角スペースを統一して連続スペースを1つにまとめる
    var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim().toLowerCase();
    searchWordTmp = characterMappings.convertWideToNarrow(searchWordTmp);

    var searchWord = searchWordTmp.split(" ");
    for (var i = 0; i < searchWord.length; i++) {
        searchWord[i] = selectorEscape(searchWord[i].replace(/>/g, "&gt;").replace(/</g, "&lt;"));
    }
    return searchWord;
}

// ハイライト用の正規表現パターンを生成
function createHighlightPattern(searchWords) {
    // 各検索ワードを全角・半角両対応のパターンに変換
    var patterns = searchWords.map(function(word) {
        // 2文字パターンを優先的にマッチさせる正規表現を作成
        var result = '';
        var pos = 0;
        
        while (pos < word.length) {
            var matched = false;
            
            // 2文字の組み合わせを試行
            if (pos + 1 < word.length) {
                var twoChar = word.substring(pos, pos + 2);
                var pattern = characterMappings.narrowToHighlightMap[twoChar];
                if (pattern) {
                    result += pattern;
                    pos += 2;
                    matched = true;
                }
            }
            
            // 1文字で処理
            if (!matched) {
                var char = word.charAt(pos);
                var pattern = characterMappings.narrowToHighlightMap[char];
                result += pattern || char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                pos++;
            }
        }
        
        return result;
    });
    return patterns.join("|");
}

// iframeのbody要素を取得
function getIframeBody() {
    var $iframe = getCachedElement('iframe');
    if ($iframe.length === 0) return null;
    return $iframe.contents().find("body");
}

// iframeコンテンツにハイライトを適用
function applyHighlight(searchValue) {
    var $body = getIframeBody();
    if (!$body) return;

    var searchWords = prepareSearchWords(searchValue);
    var highlightPattern = createHighlightPattern(searchWords);
    var reg = new RegExp("(" + highlightPattern + ")(?=[^<>]*<)", "gmi");
    var html = $body.html();
    var decodedHtml = decodeHtmlEntities(html);
    var highlightedHtml = decodedHtml.replace(reg, "<font class='keyword' style='color:rgb(0, 0, 0); background-color:rgb(252, 255, 0);'>$1</font>");

    $body.html(highlightedHtml);
}

// キーワードのハイライトを削除
function removeHighlight() {
    var $body = getIframeBody();
    if (!$body) return;

    $body.find(".keyword").each(function () {
        var $this = $(this);
        $this.replaceWith($this.contents());
    });
}

// 検索結果をクリア
function clearSearchResults() {
    var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
    var $searchResultsEnd = getCachedElement('searchResultsEnd');
    var $searchMsg = getCachedElement('searchMsg');

    $searchResultItemsBlock.html("");
    $searchResultsEnd.addClass("rh-hide");
    $searchResultsEnd.attr("hidden", "");
    $searchMsg.html("2つ以上の語句を入力して検索する場合は、スペース（空白）で区切ります。");
    removeHighlight();
    currentSearchValue = "";
    disconnectMutationObserver();
}

// ========================================
// MutationObserver関連関数
// ========================================

// キーワード要素のみの追加かどうかを判定
function isOnlyKeywordAddition(mutation) {
    if (mutation.addedNodes.length !== 1) {
        return false;
    }
    
    var node = mutation.addedNodes[0];
    if (node.nodeType !== Node.ELEMENT_NODE) {
        return false;
    }
    
    // 追加されたノードがキーワード要素か、キーワード要素を含むか
    return (node.classList && node.classList.contains('keyword')) ||
           (node.querySelector && node.querySelector('.keyword') !== null);
}

// デバウンスされた再ハイライト処理
function debouncedReHighlight() {
    if (debounceTimer) {
        clearTimeout(debounceTimer);
    }

    debounceTimer = setTimeout(function () {
        reHighlightAfterDomChange();
    }, 500);
}

// DOM変更後の再ハイライト処理
function reHighlightAfterDomChange() {
    if (!currentSearchValue || currentSearchValue.trim() === "") {
        return;
    }

    try {
        disconnectMutationObserver();
        removeHighlight();
        applyHighlight(currentSearchValue);

        setTimeout(function () {
            setupMutationObserver();
        }, 100);

        console.debug("DOM変更後に検索語を再ハイライトしました");
    } catch (error) {
        console.warn("DOM変更後の再ハイライトに失敗しました:", error);
        setupMutationObserver();
    }
}

// iframeコンテンツ用のMutationObserverをセットアップ
function setupMutationObserver() {
    disconnectMutationObserver();

    try {
        var $iframe = getCachedElement('iframe');
        if ($iframe.length === 0) return;

        var iframeDocument = $iframe[0].contentDocument || $iframe[0].contentWindow.document;
        if (!iframeDocument || !iframeDocument.body) return;

        mutationObserver = new MutationObserver(function (mutations) {
            if (!currentSearchValue || currentSearchValue.trim() === "") {
                return;
            }

            var shouldReHighlight = mutations.some(function(mutation) {
                if (mutation.type === 'characterData') {
                    return true;
                }
                
                if (mutation.type === 'childList') {
                    // キーワード要素自身の追加は無視
                    if (isOnlyKeywordAddition(mutation)) {
                        return false;
                    }
                    
                    // ノードの追加または削除があれば再ハイライト
                    return mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0;
                }
                
                return false;
            });

            if (shouldReHighlight) {
                debouncedReHighlight();
            }
        });

        mutationObserver.observe(iframeDocument.body, {
            childList: true,
            subtree: true,
            characterData: true,
            attributes: false
        });

        console.debug("iframeコンテンツ用のMutationObserverをセットアップしました");
    } catch (error) {
        console.warn("MutationObserverのセットアップに失敗しました:", error);
    }
}

// MutationObserverを切断
function disconnectMutationObserver() {
    if (mutationObserver) {
        mutationObserver.disconnect();
        mutationObserver = null;
    }

    if (debounceTimer) {
        clearTimeout(debounceTimer);
        debounceTimer = null;
    }
}

// ========================================
// jQueryカスタムセレクタ
// ========================================

// カスタムの:contains()セレクタ（正規化された検索用）
$.expr[':'].containsNormalized = function (elem, index, match) {
    var normalizedElemText = normalizeForSearch($(elem).text());
    var normalizedSearchText = normalizeForSearch(match[3]);
    return normalizedElemText.indexOf(normalizedSearchText) >= 0;
};

// ========================================
// jQueryイベントハンドラー
// ========================================

$(function () {
    // 要素のキャッシュを初期化
    initializeCachedElements();

    $(document).on("click", "ul.toc li.book", function () {
        if ($(this).children("a[href='#'],a[href='javascript:void 0;']").length == 0) {
            $(this).children("a").each(function () {
                location.href = location.href.replace(location.hash, "") + "#t=" + $(this).attr("href");
            });
        }
    });

    getCachedElement('searchField').each(function () {
        $(this).off();
    });

    $(document).on("keyup", ".wSearchField", function () {
        var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
        var $searchResultsEnd = getCachedElement('searchResultsEnd');
        var $searchMsg = getCachedElement('searchMsg');
        var searchValue = $(this).val();

        // trim()を追加してスペースのみの入力も空として扱う
        if (searchValue.trim() === "") {
            clearSearchResults();
            return;
        }

        $searchMsg.html("");
        currentSearchValue = searchValue; // 現在の検索値を保存
        
        // スペースを正規化
        var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim();
        // 正規化（全角→半角カナ、小文字化）
        searchWordTmp = normalizeForSearch(searchWordTmp);

        // 正規化後も空文字列チェックを追加
        if (searchWordTmp === "") {
            clearSearchResults();
            return;
        }

        var searchWord = searchWordTmp.split(" ");
        var searchQuery = searchWord.map(function(word) {
            return ":containsNormalized(" + word + ")";
        }).join("");

        var findItems = searchWords.find(".search_word" + searchQuery);
        if (findItems.length !== 0) {
            $searchResultsEnd.removeClass("rh-hide");
            $searchResultsEnd.removeAttr("hidden");
            $searchResultItemsBlock.html("");
            findItems.each(function () {
                var displayText = $(this).parent().find(".displayText").text();
                var parentId = $(this).parent().attr("id");
                var searchTitle = $(this).parent().find(".search_title").html();
                
                var resultHtml = "<div class='wSearchResultItem'>" +
                    "<a class='nolink' href='./" + parentId + ".html'>" +
                    "<div class='wSearchResultTitle'>" + searchTitle + "</div>" +
                    "</a>" +
                    "<div class='wSearchContent'>" +
                    "<span class='wSearchContext'>" + displayText + "</span>" +
                    "</div></div>";
                
                $searchResultItemsBlock.append($(resultHtml));
            });
            removeHighlight();
            applyHighlight(currentSearchValue);
        }
        else {
            removeHighlight();
            $searchResultsEnd.addClass("rh-hide");
            $searchResultsEnd.attr("hidden", "");
            $searchResultItemsBlock.html("");
            var displayText = "検索条件に一致するトピックはありません。";
            $searchResultItemsBlock.append($("<div class='wSearchResultItem'><div class='wSearchContent'><span class='wSearchContext'>" + displayText + "</span></div></div>"));
        }
    });

    getCachedElement('iframe').on("load", function () {
        var $searchInput = getCachedElement('searchInput');
        var $searchField = getCachedElement('searchField');

        if ($searchInput.is(":not(.rh-hide)") && ($searchField.val() != "")) {
            var searchValue = $searchField.val();
            currentSearchValue = searchValue; // 現在の検索値を保存
            applyHighlight(searchValue);
        }

        // iframeコンテンツ変更用のMutationObserverをセットアップ
        setupMutationObserver();
    });
});
