var searchWords = $('<div class="search"><div id="CMN11001"><div class="search_breadcrumbs">導入処理 &gt; はじめに</div></div><div id="CMN11003"><div class="search_breadcrumbs">導入処理 &gt; 導入処理 &gt; 導入の流れ</div><div class="search_title">導入の流れ</div><div class="displayText">導入の流れ『LucaTech GX』でマスターを新規に登録する場合の設定手順について説明します。 ///この部分は検索テスト用/// 全角・半角テストテスト / ﾃｽﾄ - カタカ ...</div><div class="search_word">導入の流れ『LucaTech GX』でマスターを新規に登録する場合の設定手順について説明します。 ///この部分は検索テスト用/// 全角・半角テストテスト / ﾃｽﾄ - カタカナの全角・半角１２３ / 123 - 数字の全角・半角ａｂｃ / abc - アルファベットの全角・半角 アルファベットの大文字・小文字ABC / abc / Abc - 基本Test / TEST / TeSt / test - 混在パターン 濁音・半濁音テスト•     ガイド / ｶﾞｲﾄﾞ - 濁音•     パソコン / ﾊﾟｿｺﾝ - 半濁音•     バージョン / ﾊﾞｰｼﾞｮﾝ - 濁音+長音の組み合わせ 複数キーワード検索テスト•     検索 機能 - スペース区切りの複数キーワード•     HTML　出力 - 全角スペース区切り•     設定　　変更 - 複数スペースの正規化テスト 記号混在テスト•     「検索」 / ｢検索｣ - かぎ括弧の全角・半角•     。、 / ｡､ - 句読点の変換 エッジケース•     ー / ｰ - 長音記号のみ•     ッ / ｯ - 促音のみ•     `` (空文字) - 検索フィールドクリアのテスト  処理権限の管理方法は次の2種類があり、それぞれの方法によって導入手順が異なります。担当者区分～処理可能部門を組み合わせて権限管理する、または『ワークフロー』を使用する場合担当者区分・個人番号区分のみで権限管理する場合 担当者区分～処理可能部門を組み合わせて権限管理する、またはワークフローを使用する場合STEP1ログインの基本情報を設定する［処理権限管理設定］で［設定する］を選択します。システム別マスターを選択した場合、および共通マスターを選択し社外のユーザーを担当者として登録する場合は［担当者同時作成設定］で［担当者として作成する］を選択します。すべての会社で共通する設定です。⇒『ログインの基本情報を設定する』参照パスワードおよびアカウントのポリシーを設定する場合ポリシーを設定するパスワードの有効期限や複雑さ、およびアカウントのロック条件を設定します。すべての会社で共通する設定です。⇒『ポリシーを設定する』参照STEP2会社を作成する会社を新規に作成します。マスターの管理方法を選択します。⇒『会社データを作成する』参照STEP3会社の基本情報を登録する会社の基本情報登録の登録や、業務システムの選択、マスターの採用、休日の登録を行います。⇒『会社基本情報を登録する』参照⇒『利用システムを追加する』参照⇒『マスター採用情報を登録する』参照⇒『休日を登録する』参照STEP4ログインアカウントを作成するログインアカウントを作成し、アカウントごとに［担当者区分］を設定します。ユーザーの招待はまだ行いません。［紐付け先社員］で［新規社員登録］をクリックして社員を同時に登録し、ログインアカウントと紐付けます。また『ログイン基本情報』の［担当者同時作成設定］で［担当者として作成する］を選択した場合は［紐付け先担当者］で［新規担当者登録］をクリックして担当者を会社に紐付けます。⇒『ログインアカウントを設定する』参照STEP5所属体系のマスターを登録する部門・役職・社員の所属体系のマスターを登録します。⇒『部門を登録する』参照⇒『部門の体系を登録する』参照⇒『役職を登録する』参照⇒『役職の体系を登録する』参照⇒『社員を登録する』参照⇒『社員の所属部門・役職・部門長区分を登録する』参照STEP6業務システムのマスターを登録する各業務システムに必要なマスターを登録します。⇒『科目を登録する』参照⇒『科目別補助を登録する（詳細）』参照⇒『銀行を登録する』参照⇒『取引先を登録する』参照⇒『汎用補助を登録する』参照⇒『固定摘要を登録する』参照STEP7各業務システムの導入設定を行う業務システムごとに導入設定を行います。財務大将⇒『財務大将の業務の流れ』参照固定資産管理⇒『処理の流れ』参照ワークフロー⇒『処理の流れ』参照会社作成時に『共通マスター』を選択した場合業務システム別にマスターの表示内容を変更する『財務大将』や『固定資産管理』で表示するマスターを設定します。⇒『システム別にマスターの表示内容を変更する』参照役割ごとにメニューの表示を設定する場合メニューパターンを登録する権限ごとにメニューパターンを作成します。⇒『メニューパターンを登録する』参照処理ごとに操作権限を設定する場合ロールを登録する処理の操作を制限するロールを作成します。⇒『ロールを登録する』参照STEP8処理権限を登録する『メニューパターン登録』『ロール登録』を組み合わせて処理権限を登録します。⇒『処理権限を登録する』参照STEP9処理権限を付与する『処理権限登録』で登録した処理権限を、社員マスター・役職マスター・部門マスター・担当者マスターのいずれかに付与します。⇒『処理権限を付与する』参照ログインアカウントと社員マスターが紐づいていない場合ログインアカウントと社員の紐付けログインアカウントと社員マスターを紐づけます。⇒『社員に処理権限を付与する』参照STEP10ポータル設定ホーム画面（ポータル）に表示する機能の設定を行います。⇒『ポータルを設定する』参照STEP11ログインアカウントを招待するログインアカウントを招待します。⇒『登録済みのログインアカウントを招待する』参照 担当者区分・個人番号区分のみで権限管理する場合STEP1処理権限の管理方法と担当者の同時作成設定を行う［処理権限管理設定］で［設定しない］を選択します。［担当者同時作成設定］で［担当者として作成する］を選択します。⇒『ログインの基本情報を設定する』参照パスワードおよびアカウントのポリシーを設定する場合ポリシーを設定するパスワードの有効期限や複雑さおよび、アカウントのロック条件を設定します。すべての会社で共通する設定です。⇒『ポリシーを設定する』参照STEP2会社を作成する会社を新規に作成します。マスターの管理方法を選択します。⇒『会社データを作成する』参照STEP3会社の基本情報を登録する会社の基本情報登録の登録や、業務システムの選択・マスターの採用、休日の登録を行います。⇒『会社基本情報を登録する』参照⇒『利用システムを追加する』参照⇒『マスター採用情報を登録する』参照⇒『休日を登録する』参照STEP4ログインアカウントを作成するログインアカウントを作成し、アカウントごとに［担当者区分］を設定します。ユーザーの招待はまだ行いません。［紐付け先担当者］で［新規担当者登録］をクリックして担当者を同時に登録し、担当者を会社に紐付けます。⇒『ログインアカウントを設定する』参照STEP5業務システムのマスターを登録する各業務システムに必要なマスターを登録します。⇒『銀行を登録する』参照⇒『取引先を登録する』参照⇒『汎用補助を登録する』参照⇒『固定摘要を登録する』参照STEP6各業務システムの導入設定を行う業務システムごとに導入設定を行います。財務大将⇒『財務大将の業務の流れ』参照固定資産管理⇒『処理の流れ』参照会社作成時に『共通マスター』を選択した場合業務システム別にマスターの表示内容を変更する『財務大将』や『固定資産管理』で表示するマスターを設定します。⇒『システム別にマスターの表示内容を変更する』参照『ログイン基本設定』の［担当者同時作成設定］で［ログインアカウントのみ作成する］を選択した場合担当者グループと担当者マスターを登録する担当者とログインアカウントを紐付けて、担当者マスターを登録します。⇒『担当者および担当者グループに処理権限を付与する』参照STEP7ポータル設定ホーム画面（ポータル）に表示する機能の設定を行います。⇒『ポータルを設定する』参照STEP8ログインアカウントを招待するログインアカウントを招待します。⇒『登録済みのログインアカウントを招待する』参照</div></div><div id="CMN11004"><div class="search_breadcrumbs">導入処理 &gt; 導入処理 &gt; 会社基本情報を登録する</div><div class="search_title">会社基本情報を登録する</div><div class="displayText">会社基本情報を登録する　［設定］＞［導入処理］＞［会社情報］＞［会社基本情報登録］会社名や法人番号などの会社情報、代表者や役職者を設定します。［基本情報］タブ 会社コード選択してい ...</div><div class="search_word">会社基本情報を登録する　［設定］＞［導入処理］＞［会社情報］＞［会社基本情報登録］会社名や法人番号などの会社情報、代表者や役職者を設定します。［基本情報］タブ 会社コード選択している会社の会社コードが表示されます。正式会社名会社名を変更する場合は、60文字以内で入力します。簡略会社名システムの画面上で表示される名称です。正式会社名の［簡略会社名へコピー］をクリックすると、入力した会社名の15文字分が［簡略会社名］へコピーされます。修正する場合は15文字以内で入力します。フリガナ会社名のフリガナを90文字以内で入力します。法人番号法人番号を入力またはをクリックして検索します。和暦／西暦区分年の表示・入力方法を［和暦］または［西暦］から選択します。会計期間選択している会社の会計期間が表示されます。変更はできません。月次開始日月次開始日が表示されます。変更はできません。設立年月日設立年月日をカレンダーから選択または西暦で直接入力します。決算期（期数）当期の期数を入力します。代表者役職名代表者の役職名を入力します。代表者氏名代表者の氏名を入力します。代表者名フリガナ代表者氏名のフリガナを入力します。郵便番号会社所在地の郵便番号を入力し、をクリックして住所を検索します。検索結果に表示された住所を選択して［OK］をクリックすると、住所が自動で反映されます。住所上段住所下段会社所在地の住所を30文字以内で入力します。をクリックすると郵便番号を検索できます。住所上段フリガナ住所下段フリガナ住所のフリガナを入力します。電話番号FAX番号電話番号とFAX番号を入力します。日次入力確定採用区分仕訳データの確定処理を日次で行う場合は［採用］を選択します。月次で行う場合は［未採用］に変更します。システム別表示設定採用区分『財務大将』や『固定資産管理』の業務システムごとに表示するマスターを変える場合は［採用］を選択します。表示の設定は［設定］＞［マスター登録処理］＞［その他］＞［システム別表示設定］で行います。ミドルネーム採用区分『社員登録』などでミドルネームを登録する場合は［採用］を選択します。フリーコードに使用する記号マスターや伝票No.のコード属性が「フリー」の場合で、半角カタカナ、半角数字、半角アルファベット（大文字・小文字）以外をコードに使用したいときは、使用する記号を入力します。複数の記号を登録する場合はスペースなどで区切らず、続けて入力します。最大10個まで入力できます。  システムが正常に稼動しなくなる可能性があるため、次の記号は登録しないでください。シングルコート（’）、ダブルコート（”）、パーセント（%） フリー項目登録［基本情報］タブの項目を追加する場合は［フリー項目採用情報設定］で登録します。会社の基本情報に関する項目やメモを追加で登録できます。 ［フリー項目採用情報設定］画面 フリー項目名称項目の名前を登録します。採用項目の表示／非表示を切り替えます。 ［代表者／役職者］タブ代表者、取締役、監査役を設定します。『社員登録』または『役職登録』で社員および役職を登録している場合は、をクリックして社員と役職を選択します。社員コードを入力せずに氏名のみを登録することも可能です。</div></div><div id="CMN11005"><div class="search_breadcrumbs">導入処理 &gt; 導入処理 &gt; マスター採用情報を登録する</div><div class="search_title">マスター採用情報を登録する</div><div class="displayText">マスター採用情報を登録する［設定］＞［導入処理］＞［会社情報］＞［マスター採用情報登録］システムで利用するマスターを採用（登録）します。 ［マスター採用情報］タブ［採用区分］から［ ...</div><div class="search_word">マスター採用情報を登録する［設定］＞［導入処理］＞［会社情報］＞［マスター採用情報登録］システムで利用するマスターを採用（登録）します。 ［マスター採用情報］タブ［採用区分］から［予算採用］までを指定して、システムで利用するマスターと桁数などを登録します。［採用区分］と［マスター名称］を指定して［条件で出力］をクリックすると、登録内容が表示されます。 マスター区分利用可能なマスターが表示されます。採用区分利用するマスターを［採用あり］に変更します。［マスター区分］によって、［P/Lのみ採用］か［B/S&amp;P/L採用］を選択します。［P/Lのみ採用］P/L科目の仕訳データなどには、そのマスターの入力が必須となります。［B/S&amp;P/L採用］B/S科目またはP/L科目の仕訳データなどには、そのマスターの入力が必須となります。マスター名称システムに表示されるマスターの名称を、20文字以内で変更します。［科目］［科目別補助］［資金繰科目］［C/F科目］は、変更できません。桁数マスターごとに、コードの桁数を入力します。［科目］［科目別補助］［C/F科目］は、変更できません。属性コードの属性を選択します。［科目別補助］［資金繰科目］［C/F科目］は変更できません。［数字］「1」を入力すると、右寄せで「1」と表示されます。［数字（前ゼロあり）］設定した［桁数］になるように、数字の前に0（ゼロ）がついて表示されます。たとえば、［桁数］が3のときに「1」を入力すると、右寄せで「001」と表示されます。［フリー］半角カタカナ、半角数字、半角アルファベット（大文字・小文字）、記号を利用できます。記号は、『会社基本情報登録』の［フリーコードに使用する記号］で登録したものが利用できます。記号の登録方法は次を参照してください。⇒『［基本情報］タブ』参照取引先マスターで［フリー］を選択すると、マスターコードの自動付番は設定できません。  一度［フリー］で登録すると、［数字］または［数字（前ゼロあり）］への変更はできません。予算採用予算管理する場合に、使用する予算を選択します。予算管理するマスターにカーソルを置いて［予算名称登録］をクリックすると、そのマスターの予算名称を変更できます。ここで変更した予算名称は、予算登録や各マスターの管理表に反映されます。予算名称は、14文字以内で入力します。［資金繰科目］［C/F科目］は、個別の予算名称を登録できます。そのほかの予算名称は共通です。 ［分類採用情報］タブ任意の分類でマスターを管理する場合は、分類を採用します。たとえば、業種別や地域別に、得意先の売上を集計したい場合は、得意先に分類を採用します。［マスター区分］で管理するマスターを選択し、［採用区分］から［属性］までを指定して、［更新］をクリックします。 採用区分登録する分類を［採用あり］に変更します。マスター名称登録する分類の名称を20文字以内で入力します。入力した分類の名称は、『分類登録』の［分類種別］に表示されます。『分類登録』については、次を参照してください。⇒『分類を登録する』参照桁数分類ごとに、コードの桁数を入力します。属性コードの属性を選択します。［数字］「1」を入力すると、右寄せで「1」と表示されます。［数字（前ゼロあり）］設定した［桁数］になるように、数字の前に0（ゼロ）がついて表示されます。たとえば、［桁数］が3のときに「1」を入力すると、右寄せで「001」と表示されます。［フリー］半角カタカナ、半角数字、半角アルファベット（大文字・小文字）、記号を利用できます。記号は、『会社基本情報登録』の［フリーコードに使用する記号］で登録したものが利用できます。記号の登録方法は次を参照してください。⇒『［基本情報］タブ』参照  一度［フリー］で登録すると、［数字］または［数字（前ゼロあり）］への変更はできません。 ［マスターコード自動付番］タブ取引先コードを自動付番する場合に、［取引先自動付番採用区分］を選択し、［マスター採用情報］タブで設定した桁数の範囲を入力します。取引先マスターのコード属性が、［数字］または［数字（前ゼロあり）］のときに設定できます。取引先コードが指定した範囲を超えた場合は、取引先の登録ができないため、付番設定を見直す必要があります。 取引先自動付番採用区分自動付番する取引先マスターの区分を選択します。［全体］取引先マスターの全範囲を指定します。［得意先／仕入先］コードによって得意先・仕入先を区別する場合に選択します。［業種］コードによって業種を区別する場合に選択します。</div></div><div id="CMN11006"><div class="search_breadcrumbs">導入処理 &gt; 導入処理 &gt; 休日を登録する</div><div class="search_title">休日を登録する</div><div class="displayText">休日を登録する　［設定］＞［導入処理］＞［会社情報］＞［休日登録］会社や金融機関などの休日を管理するカレンダーを会社ごとに登録します。 『LucaTech GX』では、土曜・日曜・ ...</div><div class="search_word">休日を登録する　［設定］＞［導入処理］＞［会社情報］＞［休日登録］会社や金融機関などの休日を管理するカレンダーを会社ごとに登録します。 『LucaTech GX』では、土曜・日曜・祝日が休日の「標準カレンダー」を用意しています。標準カレンダーは当年を含む12年分（過去10年、当年、翌年）が表示されます。年度更新を行うと、最も古い年度のカレンダーは削除され、翌年度分は毎年2月に自動で追加されます。 標準カレンダーとは異なる休日を登録する場合は、カレンダーグループを作成し、グループごとにカレンダーを作成します。年度更新を行ってもカレンダーは自動で追加されないため、新しい年のカレンダーを作成する必要があります。⇒『カレンダーを作成する』参照作成したカレンダーは、『銀行登録』などで使用します。</div></div><div id="CMN11007"><div class="search_breadcrumbs">導入処理 &gt; 導入処理 &gt; 休日を登録する &gt; カレンダーグループを作成する</div><div class="search_title">カレンダーグループを作成する</div><div class="displayText">カレンダーグループを作成する年度ごとのカレンダーをまとめて管理するグループを作成し、通年の休日を登録します。カレンダーグループで登録した休日は、同一カレンダーグループ内のすべてのカ ...</div><div class="search_word">カレンダーグループを作成する年度ごとのカレンダーをまとめて管理するグループを作成し、通年の休日を登録します。カレンダーグループで登録した休日は、同一カレンダーグループ内のすべてのカレンダーに反映されます。①　［新規グループ追加］をクリックします。②　［コード］［カレンダーグループ名称］［開始日］を入力し、［追加］をクリックします。コードコードを半角数字4桁で入力します。カレンダーグループ名称グループ名称を20文字以内で入力します。開始日をクリックして、カレンダーの開始日を指定します。③　作成したグループの［…］で［通年休日設定］をクリックします。④　［休日一括設定］画面で通年の休日を登録します。 曜日毎設定［全て］✔をつけた曜日がすべて休日になります。［第1週～第6週］第1週から第6週までの特定の曜日を指定します。［第1～第5］特定の曜日（第1月曜日、第2火曜日など）を指定します。定休日設定特定の日付を休日にする場合は［新規定休日追加］をクリックしてカレンダーから休日とする日を指定します。 ⑤　［更新］をクリックします。続けてカレンダーを作成します。⇒『カレンダーを作成する』参照 カレンダーグループの名称を編集するカレンダーグループの名称を変更する場合は、 をクリックします。標準カレンダーは編集できません。 ［カレンダーグループ名称］を修正し、［更新］をクリックします。 カレンダーグループを削除するカレンダーグループを削除します。カレンダーグループを削除するには、カレンダーをすべて削除している必要があります。なお、標準カレンダーは削除できません。 ［…］の［カレンダーグループ削除］をクリックします。 次のメッセージで［削除］をクリックします。</div></div><div id="CMN11010"><div class="search_breadcrumbs">導入処理 &gt; 導入処理 &gt; 休日を登録する &gt; カレンダーを作成する</div><div class="search_title">カレンダーを作成する</div><div class="displayText">カレンダーを作成する年度ごとにカレンダーを作成します。カレンダーグループで登録した休日はカレンダーに引き継がれますが、その年ごとに休日が異なる場合は、カレンダーに個別に登録します。 ...</div><div class="search_word">カレンダーを作成する年度ごとにカレンダーを作成します。カレンダーグループで登録した休日はカレンダーに引き継がれますが、その年ごとに休日が異なる場合は、カレンダーに個別に登録します。①　カレンダーグループの［…］で［カレンダー追加］をクリックします。②　作成する年度を西暦で入力し、［追加］をクリックします。次のメッセージが表示され、カレンダーグループにカレンダーが追加されます。③　カレンダーグループで設定した休日に変更がある場合は、カレンダーごとに休日を設定します。カレンダーの［…］で［カレンダー設定］をクリックします。④　その年度の休日を設定します。休日は、カレンダー上に赤字で表示されます。［特定の日付を休日にする場合］日付を2回クリックすると、休日（赤）になります。再度クリックすると営業日（黒）に戻ります。［一年を通して特定の曜日を休日にする場合］［曜日毎設定］で曜日に✔をつけます。［特定の期間を休日にする場合］［期間設定］で日付を範囲指定します。⑤　［更新］をクリックします。カレンダーを削除するカレンダーを削除します。『銀行登録』や『財務基本情報登録』などでカレンダーを使用している場合は、再設定が必要です。 ［…］の［カレンダー削除］をクリックします。 次のメッセージで［削除］をクリックします。</div></div></div>');
// ========================================
// グローバル変数定義
// ========================================

// MutationObserver機能用のグローバル変数
var currentSearchValue = ""; // 現在の検索キーワード
var mutationObserver = null; // MutationObserverインスタンス
var debounceTimer = null; // DOM変更用のデバウンスタイマー

// jQueryセレクタキャッシュ
var $cachedElements = {
    iframe: null,
    searchField: null,
    searchResultItemsBlock: null,
    searchResultsEnd: null,
    searchMsg: null,
    searchInput: null
};

// セレクタマップ（キャッシュ機構の効率化）
var selectorMap = {
    iframe: "iframe.topic",
    searchField: ".wSearchField",
    searchResultItemsBlock: ".wSearchResultItemsBlock",
    searchResultsEnd: ".wSearchResultsEnd",
    searchMsg: "#searchMsg",
    searchInput: ".search-input"
};

// HTMLエンティティ復元用の正規表現（効率化のためグローバル定義）
var htmlEntityRegexes = {
    nbsp: /&nbsp;(?=[^<>]*<)/gm,
    gt: /&gt;(?=[^<>]*<)/gm,
    lt: /&lt;(?=[^<>]*<)/gm,
    quot: /&quot;(?=[^<>]*<)/gm,
    amp: /&amp;(?=[^<>]*<)/gm
};

// 文字変換マップ（効率化のため初期化時に正規表現を構築）
var characterMappings = (function () {
    // 文字変換用の配列定義（配列リテラルに変更）
    var wide = ["０", "１", "２", "３", "４", "５", "６", "７", "８", "９", "ａ", "ｂ", "ｃ", "ｄ", "ｅ", "ｆ", "ｇ", "ｈ", "ｉ", "ｊ", "ｋ", "ｌ", "ｍ", "ｎ", "ｏ", "ｐ", "ｑ", "ｒ", "ｓ", "ｔ", "ｕ", "ｖ", "ｗ", "ｘ", "ｙ", "ｚ", "ガ", "ギ", "グ", "ゲ", "ゴ", "ザ", "ジ", "ズ", "ゼ", "ゾ", "ダ", "ヂ", "ヅ", "デ", "ド", "バ", "ビ", "ブ", "ベ", "ボ", "パ", "ピ", "プ", "ペ", "ポ", "。", "「", "」", "、", "ヲ", "ァ", "ィ", "ゥ", "ェ", "ォ", "ャ", "ュ", "ョ", "ッ", "ー", "ア", "イ", "ウ", "エ", "オ", "カ", "キ", "ク", "ケ", "コ", "サ", "シ", "ス", "セ", "ソ", "タ", "チ", "ツ", "テ", "ト", "ナ", "ニ", "ヌ", "ネ", "ノ", "ハ", "ヒ", "フ", "ヘ", "ホ", "マ", "ミ", "ム", "メ", "モ", "ヤ", "ユ", "ヨ", "ラ", "リ", "ル", "レ", "ロ", "ワ", "ン"];
    var narrow = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "ｶﾞ", "ｷﾞ", "ｸﾞ", "ｹﾞ", "ｺﾞ", "ｻﾞ", "ｼﾞ", "ｽﾞ", "ｾﾞ", "ｿﾞ", "ﾀﾞ", "ﾁﾞ", "ﾂﾞ", "ﾃﾞ", "ﾄﾞ", "ﾊﾞ", "ﾋﾞ", "ﾌﾞ", "ﾍﾞ", "ﾎﾞ", "ﾊﾟ", "ﾋﾟ", "ﾌﾟ", "ﾍﾟ", "ﾎﾟ", "｡", "｢", "｣", "､", "ｦ", "ｧ", "ｨ", "ｩ", "ｪ", "ｫ", "ｬ", "ｭ", "ｮ", "ｯ", "ｰ", "ｱ", "ｲ", "ｳ", "ｴ", "ｵ", "ｶ", "ｷ", "ｸ", "ｹ", "ｺ", "ｻ", "ｼ", "ｽ", "ｾ", "ｿ", "ﾀ", "ﾁ", "ﾂ", "ﾃ", "ﾄ", "ﾅ", "ﾆ", "ﾇ", "ﾈ", "ﾉ", "ﾊ", "ﾋ", "ﾌ", "ﾍ", "ﾎ", "ﾏ", "ﾐ", "ﾑ", "ﾒ", "ﾓ", "ﾔ", "ﾕ", "ﾖ", "ﾗ", "ﾘ", "ﾙ", "ﾚ", "ﾛ", "ﾜ", "ﾝ"];
    var highlight = ["(?:０|0)", "(?:１|1)", "(?:２|2)", "(?:３|3)", "(?:４|4)", "(?:５|5)", "(?:６|6)", "(?:７|7)", "(?:８|8)", "(?:９|9)", "(?:ａ|a)", "(?:ｂ|b)", "(?:ｃ|c)", "(?:ｄ|d)", "(?:ｅ|e)", "(?:ｆ|f)", "(?:ｇ|g)", "(?:ｈ|h)", "(?:ｉ|i)", "(?:ｊ|j)", "(?:ｋ|k)", "(?:ｌ|l)", "(?:ｍ|m)", "(?:ｎ|n)", "(?:ｏ|o)", "(?:ｐ|p)", "(?:ｑ|q)", "(?:ｒ|r)", "(?:ｓ|s)", "(?:ｔ|t)", "(?:ｕ|u)", "(?:ｖ|v)", "(?:ｗ|w)", "(?:ｘ|x)", "(?:ｙ|y)", "(?:ｚ|z)", "(?:ガ|ｶﾞ)", "(?:ギ|ｷﾞ)", "(?:グ|ｸﾞ)", "(?:ゲ|ｹﾞ)", "(?:ゴ|ｺﾞ)", "(?:ザ|ｻﾞ)", "(?:ジ|ｼﾞ)", "(?:ズ|ｽﾞ)", "(?:ゼ|ｾﾞ)", "(?:ゾ|ｿﾞ)", "(?:ダ|ﾀﾞ)", "(?:ヂ|ﾁﾞ)", "(?:ヅ|ﾂﾞ)", "(?:デ|ﾃﾞ)", "(?:ド|ﾄﾞ)", "(?:バ|ﾊﾞ)", "(?:ビ|ﾋﾞ)", "(?:ブ|ﾌﾞ)", "(?:ベ|ﾍﾞ)", "(?:ボ|ﾎﾞ)", "(?:パ|ﾊﾟ)", "(?:ピ|ﾋﾟ)", "(?:プ|ﾌﾟ)", "(?:ペ|ﾍﾟ)", "(?:ポ|ﾎﾟ)", "(?:。|｡)", "(?:「|｢)", "(?:」|｣)", "(?:、|､)", "(?:ヲ|ｦ)", "(?:ァ|ｧ)", "(?:ィ|ｨ)", "(?:ゥ|ｩ)", "(?:ェ|ｪ)", "(?:ォ|ｫ)", "(?:ャ|ｬ)", "(?:ュ|ｭ)", "(?:ョ|ｮ)", "(?:ッ|ｯ)", "(?:ー|ｰ)", "(?:ア|ｱ)", "(?:イ|ｲ)", "(?:ウ|ｳ)", "(?:エ|ｴ)", "(?:オ|ｵ)", "(?:カ|ｶ)", "(?:キ|ｷ)", "(?:ク|ｸ)", "(?:ケ|ｹ)", "(?:コ|ｺ)", "(?:サ|ｻ)", "(?:シ|ｼ)", "(?:ス|ｽ)", "(?:セ|ｾ)", "(?:ソ|ｿ)", "(?:タ|ﾀ)", "(?:チ|ﾁ)", "(?:ツ|ﾂ)", "(?:テ|ﾃ)", "(?:ト|ﾄ)", "(?:ナ|ﾅ)", "(?:ニ|ﾆ)", "(?:ヌ|ﾇ)", "(?:ネ|ﾈ)", "(?:ノ|ﾉ)", "(?:ハ|ﾊ)", "(?:ヒ|ﾋ)", "(?:フ|ﾌ)", "(?:ヘ|ﾍ)", "(?:ホ|ﾎ)", "(?:マ|ﾏ)", "(?:ミ|ﾐ)", "(?:ム|ﾑ)", "(?:メ|ﾒ)", "(?:モ|ﾓ)", "(?:ヤ|ﾔ)", "(?:ユ|ﾕ)", "(?:ヨ|ﾖ)", "(?:ラ|ﾗ)", "(?:リ|ﾘ)", "(?:ル|ﾙ)", "(?:レ|ﾚ)", "(?:ロ|ﾛ)", "(?:ワ|ﾜ)", "(?:ン|ﾝ)"];

    // 全角→半角の変換マップを作成
    var wideToNarrowMap = {};
    var narrowToHighlightMap = {};

    for (var i = 0; i < wide.length; i++) {
        wideToNarrowMap[wide[i]] = narrow[i];
        // 半角文字をキーにしてハイライトパターンをマップ
        narrowToHighlightMap[narrow[i]] = highlight[i];
    }

    // 全角文字の正規表現パターンを作成（エスケープ処理を含む）
    var wideCharsPattern = wide.map(function (char) {
        return char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }).join('|');

    var wideToNarrowRegex = new RegExp(wideCharsPattern, 'g');

    return {
        wideToNarrowMap: wideToNarrowMap,
        narrowToHighlightMap: narrowToHighlightMap,
        wideToNarrowRegex: wideToNarrowRegex,
        // 効率的な変換関数
        convertWideToNarrow: function (text) {
            return text.replace(wideToNarrowRegex, function (match) {
                return wideToNarrowMap[match] || match;
            });
        }
    };
})();

// ========================================
// 基本ユーティリティ関数（依存なし）
// ========================================

// セレクタ用のエスケープ処理
function selectorEscape(val) {
    return val.replace(/[-\/\\^$*+?.()|[\]{}\!]/g, '\\$&');
}

// 文字列を正規化（全角→半角カナ変換、小文字化）
function normalizeForSearch(text) {
    var normalized = text.toLowerCase();
    return characterMappings.convertWideToNarrow(normalized);
}

// HTMLエンティティを復元
function decodeHtmlEntities(html) {
    return html
        .replace(htmlEntityRegexes.nbsp, "　")
        .replace(htmlEntityRegexes.gt, ">")
        .replace(htmlEntityRegexes.lt, "<")
        .replace(htmlEntityRegexes.quot, '"')
        .replace(htmlEntityRegexes.amp, "&");
}

// ========================================
// キャッシュ管理関数
// ========================================

// キャッシュを初期化
function initializeCachedElements() {
    for (var key in selectorMap) {
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
}

// キャッシュされた要素を取得（存在チェック付き）
function getCachedElement(key) {
    if (!$cachedElements[key] || $cachedElements[key].length === 0) {
        // キャッシュが無効な場合は再取得
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
    return $cachedElements[key];
}

// ========================================
// 検索処理関連関数（依存関係順）
// ========================================

// 検索語を正規化してエスケープ
function prepareSearchWords(searchValue) {
    // 全角・半角スペースを統一して連続スペースを1つにまとめる
    var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim().toLowerCase();
    searchWordTmp = characterMappings.convertWideToNarrow(searchWordTmp);

    var searchWord = searchWordTmp.split(" ");
    for (var i = 0; i < searchWord.length; i++) {
        searchWord[i] = selectorEscape(searchWord[i].replace(/>/g, "&gt;").replace(/</g, "&lt;"));
    }
    return searchWord;
}

// ハイライト用の正規表現パターンを生成
function createHighlightPattern(searchWords) {
    // 各検索ワードを全角・半角両対応のパターンに変換
    var patterns = searchWords.map(function(word) {
        var chars = word.split('');
        var highlightChars = chars.map(function(char) {
            // 半角文字を全角・半角両対応パターンに変換
            return characterMappings.narrowToHighlightMap[char] || char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        });
        return highlightChars.join('');
    });
    return patterns.join("|");
}

// iframeのbody要素を取得
function getIframeBody() {
    var $iframe = getCachedElement('iframe');
    if ($iframe.length === 0) return null;
    return $iframe.contents().find("body");
}

// iframeコンテンツにハイライトを適用
function applyHighlight(searchValue) {
    var $body = getIframeBody();
    if (!$body) return;

    var searchWords = prepareSearchWords(searchValue);
    var highlightPattern = createHighlightPattern(searchWords);
    var reg = new RegExp("(" + highlightPattern + ")(?=[^<>]*<)", "gmi");
    var html = $body.html();
    var decodedHtml = decodeHtmlEntities(html);
    var highlightedHtml = decodedHtml.replace(reg, "<font class='keyword' style='color:rgb(0, 0, 0); background-color:rgb(252, 255, 0);'>$1</font>");

    $body.html(highlightedHtml);
}

// キーワードのハイライトを削除
function removeHighlight() {
    var $body = getIframeBody();
    if (!$body) return;

    $body.find(".keyword").each(function () {
        var $this = $(this);
        $this.replaceWith($this.contents());
    });
}

// 検索結果をクリア
function clearSearchResults() {
    var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
    var $searchResultsEnd = getCachedElement('searchResultsEnd');
    var $searchMsg = getCachedElement('searchMsg');

    $searchResultItemsBlock.html("");
    $searchResultsEnd.addClass("rh-hide");
    $searchResultsEnd.attr("hidden", "");
    $searchMsg.html("2つ以上の語句を入力して検索する場合は、スペース（空白）で区切ります。");
    removeHighlight();
    currentSearchValue = "";
    disconnectMutationObserver();
}

// ========================================
// MutationObserver関連関数
// ========================================

// キーワード要素のみの追加かどうかを判定
function isOnlyKeywordAddition(mutation) {
    if (mutation.addedNodes.length !== 1) {
        return false;
    }
    
    var node = mutation.addedNodes[0];
    if (node.nodeType !== Node.ELEMENT_NODE) {
        return false;
    }
    
    // 追加されたノードがキーワード要素か、キーワード要素を含むか
    return (node.classList && node.classList.contains('keyword')) ||
           (node.querySelector && node.querySelector('.keyword') !== null);
}

// デバウンスされた再ハイライト処理
function debouncedReHighlight() {
    if (debounceTimer) {
        clearTimeout(debounceTimer);
    }

    debounceTimer = setTimeout(function () {
        reHighlightAfterDomChange();
    }, 500);
}

// DOM変更後の再ハイライト処理
function reHighlightAfterDomChange() {
    if (!currentSearchValue || currentSearchValue.trim() === "") {
        return;
    }

    try {
        disconnectMutationObserver();
        removeHighlight();
        applyHighlight(currentSearchValue);

        setTimeout(function () {
            setupMutationObserver();
        }, 100);

        console.debug("DOM変更後に検索語を再ハイライトしました");
    } catch (error) {
        console.warn("DOM変更後の再ハイライトに失敗しました:", error);
        setupMutationObserver();
    }
}

// iframeコンテンツ用のMutationObserverをセットアップ
function setupMutationObserver() {
    disconnectMutationObserver();

    try {
        var $iframe = getCachedElement('iframe');
        if ($iframe.length === 0) return;

        var iframeDocument = $iframe[0].contentDocument || $iframe[0].contentWindow.document;
        if (!iframeDocument || !iframeDocument.body) return;

        mutationObserver = new MutationObserver(function (mutations) {
            if (!currentSearchValue || currentSearchValue.trim() === "") {
                return;
            }

            var shouldReHighlight = mutations.some(function(mutation) {
                if (mutation.type === 'characterData') {
                    return true;
                }
                
                if (mutation.type === 'childList') {
                    // キーワード要素自身の追加は無視
                    if (isOnlyKeywordAddition(mutation)) {
                        return false;
                    }
                    
                    // ノードの追加または削除があれば再ハイライト
                    return mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0;
                }
                
                return false;
            });

            if (shouldReHighlight) {
                debouncedReHighlight();
            }
        });

        mutationObserver.observe(iframeDocument.body, {
            childList: true,
            subtree: true,
            characterData: true,
            attributes: false
        });

        console.debug("iframeコンテンツ用のMutationObserverをセットアップしました");
    } catch (error) {
        console.warn("MutationObserverのセットアップに失敗しました:", error);
    }
}

// MutationObserverを切断
function disconnectMutationObserver() {
    if (mutationObserver) {
        mutationObserver.disconnect();
        mutationObserver = null;
    }

    if (debounceTimer) {
        clearTimeout(debounceTimer);
        debounceTimer = null;
    }
}

// ========================================
// jQueryカスタムセレクタ
// ========================================

// カスタムの:contains()セレクタ（正規化された検索用）
$.expr[':'].containsNormalized = function (elem, index, match) {
    var normalizedElemText = normalizeForSearch($(elem).text());
    var normalizedSearchText = normalizeForSearch(match[3]);
    return normalizedElemText.indexOf(normalizedSearchText) >= 0;
};

// ========================================
// jQueryイベントハンドラー
// ========================================

$(function () {
    // 要素のキャッシュを初期化
    initializeCachedElements();

    $(document).on("click", "ul.toc li.book", function () {
        if ($(this).children("a[href='#'],a[href='javascript:void 0;']").length == 0) {
            $(this).children("a").each(function () {
                location.href = location.href.replace(location.hash, "") + "#t=" + $(this).attr("href");
            });
        }
    });

    getCachedElement('searchField').each(function () {
        $(this).off();
    });

    $(document).on("keyup", ".wSearchField", function () {
        var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
        var $searchResultsEnd = getCachedElement('searchResultsEnd');
        var $searchMsg = getCachedElement('searchMsg');
        var searchValue = $(this).val();

        // trim()を追加してスペースのみの入力も空として扱う
        if (searchValue.trim() === "") {
            clearSearchResults();
            return;
        }

        $searchMsg.html("");
        currentSearchValue = searchValue; // 現在の検索値を保存
        
        // スペースを正規化
        var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim();
        // 正規化（全角→半角カナ、小文字化）
        searchWordTmp = normalizeForSearch(searchWordTmp);

        // 正規化後も空文字列チェックを追加
        if (searchWordTmp === "") {
            clearSearchResults();
            return;
        }

        var searchWord = searchWordTmp.split(" ");
        var searchQuery = searchWord.map(function(word) {
            return ":containsNormalized(" + word + ")";
        }).join("");

        var findItems = searchWords.find(".search_word" + searchQuery);
        if (findItems.length !== 0) {
            $searchResultsEnd.removeClass("rh-hide");
            $searchResultsEnd.removeAttr("hidden");
            $searchResultItemsBlock.html("");
            findItems.each(function () {
                var displayText = $(this).parent().find(".displayText").text();
                var parentId = $(this).parent().attr("id");
                var searchTitle = $(this).parent().find(".search_title").html();
                
                var resultHtml = "<div class='wSearchResultItem'>" +
                    "<a class='nolink' href='./" + parentId + ".html'>" +
                    "<div class='wSearchResultTitle'>" + searchTitle + "</div>" +
                    "</a>" +
                    "<div class='wSearchContent'>" +
                    "<span class='wSearchContext'>" + displayText + "</span>" +
                    "</div></div>";
                
                $searchResultItemsBlock.append($(resultHtml));
            });
            removeHighlight();
            applyHighlight(currentSearchValue);
        }
        else {
            removeHighlight();
            $searchResultsEnd.addClass("rh-hide");
            $searchResultsEnd.attr("hidden", "");
            $searchResultItemsBlock.html("");
            var displayText = "検索条件に一致するトピックはありません。";
            $searchResultItemsBlock.append($("<div class='wSearchResultItem'><div class='wSearchContent'><span class='wSearchContext'>" + displayText + "</span></div></div>"));
        }
    });

    getCachedElement('iframe').on("load", function () {
        var $searchInput = getCachedElement('searchInput');
        var $searchField = getCachedElement('searchField');

        if ($searchInput.is(":not(.rh-hide)") && ($searchField.val() != "")) {
            var searchValue = $searchField.val();
            currentSearchValue = searchValue; // 現在の検索値を保存
            applyHighlight(searchValue);
        }

        // iframeコンテンツ変更用のMutationObserverをセットアップ
        setupMutationObserver();
    });
});
