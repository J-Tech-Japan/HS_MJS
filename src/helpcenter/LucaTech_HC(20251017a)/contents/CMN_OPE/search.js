var searchWords = $('<div class="search"><div id="CMN10001"><div class="search_breadcrumbs">LucaTech GXについて &gt; はじめに</div></div><div id="CMN10003"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ログインする</div><div class="search_title">ログインする</div><div class="displayText">ログインする『LucaTech GX』の起動方法と、ログインの手順について説明します。①　『LucaTech GX』を起動します。②　ログインIDとパスワードを入力します。③　会社 ...</div><div class="search_word">ログインする『LucaTech GX』の起動方法と、ログインの手順について説明します。①　『LucaTech GX』を起動します。②　ログインIDとパスワードを入力します。③　会社を選択し、［選択して次へ］をクリックします。会社が1社も存在しない場合や会社を削除する場合など、会社の選択が必要ない処理を行う場合は、［選択せず次へ］をクリックします。</div></div><div id="CMN10004"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ログインする &gt; LucaTech GXを初めて利用する場合</div><div class="search_title">LucaTech GXを初めて利用する場合</div><div class="displayText">LucaTech GXを初めて利用する場合ログイン方法には、次の2通りがあります。招待メールからログインする方法管理者が、登録したログインアカウントを招待すると、” LucaTec ...</div><div class="search_word">LucaTech GXを初めて利用する場合ログイン方法には、次の2通りがあります。招待メールからログインする方法管理者が、登録したログインアカウントを招待すると、” LucaTech GX”＜lucatechgx-info@mjs.co.jp＞から招待メールが届きます。記載されているURLにアクセスして『LucaTech GX』にログインします。なお、招待メールを受信するメールアドレスには、受信できるアドレスを利用します。ログイン情報が記載されたPDFファイルのURLからログインする方法管理者から［PDFファイル］が配布された場合は、記載されているURLにアクセスして『LucaTech GX』にログインします。   受信できるメールアドレスを使用してください『LucaTech   GX』で利用するアカウントの発行には、RFC（Request   For Comments）の定める規格に準拠しているメールアドレスが必要です。次のようなメールアドレスは、RFC規格に準拠していないため利用いただけません。①（　）　&lt;　&gt;　[　]　：　；　＠　,　‘　が含まれている場合（例）　a;aaa＠example.jp② @（アットマーク）の直前や先頭に「.」（ドット）を使用している場合（例）　.aaaa＠example.jp　　　　aaaa.＠example.jp③ @（アットマーク）より前で「.」（ドット）や「_」（アンダーバー）を2文字以上連続して使用している場合（例）　aa..a＠example.jp     　　　aa__a＠example.jp④スペースが含まれる場合（例） aa aa＠example.jp 日本語ドメインのメールアドレスは対応していないため、ご利用できません。（例）aaa@ミロク.jp ①　招待メールまたは配布されたPDFファイルに記載されているログインIDと仮パスワードを入力します。②　仮パスワードを変更するか確認メッセージが表示されます。［今すぐ変更する］をクリックします。③　設定するパスワードを入力し、［変更する］をクリックします。パスワードは次の３つの条件を満たしてください。・半角8文字以上・英字（大文字と小文字どちらも）が1文字以上含まれている・数字が0～9のいずれか1文字以上含まれているなお、パスワードには半角の記号も使用できます。④　変更したパスワードでログインします。⑤　ログイン後に会社を選択します。ホーム画面が表示されます。URLは、お気に入りやブックマークに登録しておくと、次回以降『LucaTech GX』を起動する際に便利です。   迷惑メール設定・ドメイン指定受信設定を行っている場合あらかじめ『LucaTech   GX』から送信されるメールのドメイン「bizsky.jp」を受信できるようにメールの指定受信設定をしてください。もしメールが届いていないようであれば、［迷惑メールフォルダー］等をご確認いただくか、お使いのサービス、ソフトウェアの設定を確認してください。主な無料メールサービスの設定方法については、次のURLを参考にしてください。Yahoo!メール：＞ヘルプ＞届くはずのメールが届いていないGmail：Gmailヘルプ＞問題を解決する＞Gmail のメールが見つからないOutlook：Outlookヘルプ＞メール＞Outlook.com でメールの送信または受信ができない</div></div><div id="CMN10005"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; パスワードを再設定する</div><div class="search_title">パスワードを再設定する</div><div class="displayText">パスワードを再設定する管理者から発行される仮パスワードの有効期限は24時間です。初回ログイン時にパスワードを変更しないと有効期限が切れます。有効期限が切れたときや、設定したパスワー ...</div><div class="search_word">パスワードを再設定する管理者から発行される仮パスワードの有効期限は24時間です。初回ログイン時にパスワードを変更しないと有効期限が切れます。有効期限が切れたときや、設定したパスワードを忘れてしまったときは、次の手順でパスワードを再設定します。なお、 PDFファイルを配布された場合は、ユーザー自身でパスワードの再設定ができないため、管理者にパスワードの再発行を依頼します。①　ログイン画面の「パスワード再設定」をクリックします。②　［登録済みのログインID］を入力して［送信］をクリックします。確認メールが送信されます。③　受信したメールの［次へ進む］をクリックします。④　表示された画面から、［再設定を始める］をクリックします。⑤　［新しいパスワード］に、設定する新しいパスワードを入力後、確認用欄にも、新しいパスワードを入力して［再設定］をクリックします。パスワードの変更が完了します。⑥　［戻る］をクリックして、ログイン画面に戻ります。</div></div><div id="CMN10006"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; パスワードを変更する</div><div class="search_title">パスワードを変更する</div><div class="displayText">パスワードを変更するパスワードの変更は、ホーム画面の右上のユーザーアイコンから行います。①　ユーザーアイコンをクリックし、［パスワード変更］をクリックします。②　表示されたパスワー ...</div><div class="search_word">パスワードを変更するパスワードの変更は、ホーム画面の右上のユーザーアイコンから行います。①　ユーザーアイコンをクリックし、［パスワード変更］をクリックします。②　表示されたパスワード変更画面で、［現在のパスワード］と［新しいパスワード］、［新しいパスワード（確認）］を入力して、［更新］をクリックします。</div></div><div id="CMN10007"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ログアウトする</div><div class="search_title">ログアウトする</div><div class="displayText">ログアウトする『LucaTech GX』からのログアウトは、次の手順で行います。①　画面右上のユーザーアイコンをクリックし、表示されたメニューから「ログアウト」をクリックします。② ...</div><div class="search_word">ログアウトする『LucaTech GX』からのログアウトは、次の手順で行います。①　画面右上のユーザーアイコンをクリックし、表示されたメニューから「ログアウト」をクリックします。②　表示されたメッセージで［OK］をクリックします。</div></div><div id="CMN10008"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ホーム画面の構成について</div><div class="search_title">ホーム画面の構成について</div><div class="displayText">ホーム画面の構成についてホーム画面の構成は次のとおりです。 1 メインメニュー表示切替メインメニューの表示・非表示を切り替えます。 会社名選択している会社名が表示されます。会社を変 ...</div><div class="search_word">ホーム画面の構成についてホーム画面の構成は次のとおりです。 1 メインメニュー表示切替メインメニューの表示・非表示を切り替えます。 会社名選択している会社名が表示されます。会社を変更するには、クリックして会社を切り替えます。 ファイル出力一覧各処理で出力されたファイル名が一覧表示され、ダウンロードできます。ファイルが出力されると、のように数字が表示されます。 通知履歴『LucaTech GX』からの通知を確認できます。通知が届くと、のように数字が表示されます。 へルプ各処理について説明したヘルプが表示されます。へルプの使い方については、次を参照してください。⇒『ヘルプを活用する』参照ホーム画面でをクリックすると、へルプセンターが表示されます。処理画面でをクリックすると、その処理のへルプページが表示されます。 ユーザーアイコンアイコンをクリックすると、次の処理が行えます。［パスワード変更］パスワードを変更します。［メニューパターン切替］ログインしているユーザーに複数のメニューパターンの表示権限が与えられている場合は、表示するメニューを切り替えることができます。メニューパターンは、『メニューパターン登録』で設定します。［通知設定］処理が終了したことを通知します。設定すると、画面の右下にお知らせが表示されます。［バージョン情報］『LucaTech   GX』のバージョンが表示されます。［ログアウト］ログアウトします。2メインメニュー利用可能なシステムのメニューが表示されます。3ポータルエリアホーム画面（ポータル）には、会社で一元管理する「標準用ポータル」とユーザーごとに設定できる「個人ポータル」の2種類があります。個人ポータルが登録されている場合は、［…］から［標準ポータル］［個人ポータル］をクリックして表示を切り替えることができます。ポータルの登録方法については次を参照してください。⇒『ポータルを設定する』参照ポータルに表示する「お知らせ」や「スケジュール」などの各種機能（ポートレット）については次を参照してください。⇒『ポートレットについて』参照利用したい処理を検索します。に文字を入力後、をクリックすると、該当の処理名が表示されます。『メニューパターン   登録』で処理に対してキーワードが設定されている場合、そのキーワードでも処理を検索することができます。</div></div><div id="CMN10009"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ホーム画面の構成について &gt; ポートレットについて</div><div class="search_title">ポートレットについて</div><div class="displayText">ポートレットについてホーム画面（ポータル）に表示する「お知らせ」などの各種機能をポートレットと言います。ポータルに表示できるポートレットは次のとおりです。 システムからのお知らせシ ...</div><div class="search_word">ポートレットについてホーム画面（ポータル）に表示する「お知らせ」などの各種機能をポートレットと言います。ポータルに表示できるポートレットは次のとおりです。 システムからのお知らせシステムからのお知らせが表示されます。 使用履歴使用した処理の履歴が表示されます。クリックすると処理に移動します。 よく使う処理［…］をクリックして、よく使う処理や外部サイトを登録します。［内部サイト処理設定］では『LucaTech GX』の処理を登録できます。処理名を入力して［検索］をクリックし、追加する処理を選択します。［更新］をクリックして設定を保存します。［外部ショートカット設定］では外部サイトを登録できます。［ショートカット名］と［URL］を入力し、［更新］をクリックして設定を保存します。追加した処理や外部サイトの移動や編集・削除は、［…］をクリックして行います。 外部サイトプレビュー設定した外部サイトのプレビューを表示します。なお以下のサイトはプレビューを表示できません。「http」で始まる暗号化されていないサイトサイト側で「プレビューを禁止する設定」がされているサイト（検索サイトなど）［…］の［URL設定］をクリックして外部サイトを登録します。［サイト名］と［URL］を入力し、［更新］をクリックして設定を保存します。 カウントダウン一覧設定したタスクの期日までの残日数やステータスを確認できます。登録したタスクは、設定した表示期間を過ぎた場合やステータスが完了になった場合は非表示になります。［…］の［カウントダウン設定］をクリックしてタスクを登録します。［タスク名称］［期日］［表示期間］［ステータス］を設定し［更新］をクリックして設定を保存します。</div></div><div id="CMN10010"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; 各処理に共通する機能と操作方法</div><div class="search_title">各処理に共通する機能と操作方法</div><div class="displayText">各処理に共通する機能と操作方法各処理に共通する機能と操作方法について説明します。 項目の入力方法について各処理で項目を入力した後は、［Enter］または［Tab］で内容を確定し、次 ...</div><div class="search_word">各処理に共通する機能と操作方法各処理に共通する機能と操作方法について説明します。 項目の入力方法について各処理で項目を入力した後は、［Enter］または［Tab］で内容を確定し、次の項目に移動します。 項目の入力中にスクロール操作を行うと、未確定の入力内容が破棄されることがあります。必ず、入力中の項目を確定（他のセルをクリックまたは［Enter］を押下）してから、スクロール操作を行ってください。 メニューの表示方法の変更について各処理の選択画面の赤枠部分をクリックすると、メニューの表示方法を切り替えることができます。▼ツリー表示▼リスト表示 各処理内の上部のアイコンについて各処理内の上部のアイコンについて説明します。画面の表示内容をCSVファイルまたはPDFファイルに出力します。出力したファイルはで確認できます。各処理によって出力設定画面が異なります。 再読込画面の表示内容を最新の状態に更新します。 クイックメニュー開いている処理に関連する処理が表示されます。クリックするとその処理が別ウィンドウで開きます。 各処理の出力条件の指定方法について各処理における出力条件の指定方法について説明します。『取引先登録』など『科目登録』など</div></div><div id="CMN10011"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ヘルプを活用する</div><div class="search_title">ヘルプを活用する</div><div class="displayText">ヘルプを活用する画面右上に表示されるをクリックするとLucaTech GXヘルプセンターや、各処理の説明が記載されているヘルプページが表示されます。 『LucaTech GX』のホ ...</div><div class="search_word">ヘルプを活用する画面右上に表示されるをクリックするとLucaTech GXヘルプセンターや、各処理の説明が記載されているヘルプページが表示されます。 『LucaTech GX』のホーム画面や、各システムのトップページでをクリックした場合LucaTech GXヘルプセンターが表示されます。ヘルプセンターでは、メニュー名、操作を行う目的などからページを探すことができます。また、キーワード検索ですべての業務システムを横断して検索することができます。ヘルプセンターの見方や操作方法については次を参照してください。⇒『ヘルプセンターについて』参照 各処理でをクリックした場合各処理の説明が記載されているヘルプページが表示されます。実際の処理を進めながら、各システムの操作方法の説明などの情報が参照できます。ヘルプページの見方や操作方法については次を参照してください。⇒『ヘルプページについて』参照</div></div><div id="CMN10012"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ヘルプを活用する &gt; ヘルプセンターについて</div><div class="search_title">ヘルプセンターについて</div><div class="displayText">ヘルプセンターについてヘルプセンターの見方や操作方法について説明します。 1キーワード検索ウィンドウ検索したいキーワードを入力後、または［Enter］キーをクリックすると、入力した ...</div><div class="search_word">ヘルプセンターについてヘルプセンターの見方や操作方法について説明します。 1キーワード検索ウィンドウ検索したいキーワードを入力後、または［Enter］キーをクリックすると、入力したキーワードを含むヘルプページの見出しが一覧で表示されます。なお、キーワード検索はAND条件で行われます。［絞り込み項目］でをクリックすると、検索結果を処理ごとに絞り込みできます。✔をはずした処理のページは、検索結果に表示されません。2業務システムから探す契約中のサービスのヘルプが一覧で表示されます。確認したいページをクリックすると次の画面が表示されるので、検索方法を指定します。操作を行う目的から探す場合は、［目的から探す］を選択します。メニュー名や処理名から探す場合は、［メニューから探す］を選択します。</div></div><div id="CMN10015"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ヘルプを活用する &gt; ヘルプページについて</div><div class="search_title">ヘルプページについて</div><div class="displayText">ヘルプページについてヘルプページの見方や操作方法について説明します。1つ前のページへ戻る、または進む場合はブラウザーの［戻る］［進む］をクリックして移動します。1目次ヘルプの目次が ...</div><div class="search_word">ヘルプページについてヘルプページの見方や操作方法について説明します。1つ前のページへ戻る、または進む場合はブラウザーの［戻る］［進む］をクリックして移動します。1目次ヘルプの目次が表示されます。参照したい見出しをクリックすると、ページが開きます。をクリックすると、下の階層の見出しが開きます。目次の幅は変更できません。2目次の表示検索画面から目次の一覧に戻ります。3検索検索したい文字を入力すると、入力した文字を含む目次が表示されます。スペースで区切ることで複数の語句を検索できます。⇒『文字検索を行う』参照4目次の表示・非表示 をクリックすると目次の表示または非表示を切り替えることができます。5ページ印刷ヘルプ画面に表示されているページを出力します。この場合、出力時に［背景のグラフィックス］に✔をつける必要があります。文字サイズヘルプ内の文字サイズを［小］［中］［大］から選択します。6表示されているページのパス表示しているヘルプのページの開き方が表示されます。クリックするとページを移動できます。7参照先下線付きで青く表示されている個所をクリックすると、該当ページに移動できます。8ページトップへジャンプクリックすると、表示しているページの先頭に移動できます。9LucaTech GXヘルプTOPクリックするとLucaTech GXヘルプセンターに移動できます。 文字検索を行う目次検索機能を使って、調べたい語句が記載されているページを特定します。全半角や小文字大文字を区別せずに検索します。検索語句には、英数字、漢字、ひらがなおよびカタカナを使用できます。①　虫眼鏡  をクリックします。②　検索文字列を入力します。スペースで区切ることで複数の語句を検索できます。③　検索文字を含むページタイトルが目次順に表示されます。④　検索結果のページタイトルをクリックすると、ページが表示され、検索文字に黄色のハイライトが付きます。</div></div><div id="CMN10017"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; 処理権限について</div><div class="search_title">処理権限について</div><div class="displayText">処理権限について処理権限とは、ユーザーがシステムでどこまで操作できるかを決めるルールのことです。処理権限を設定することにより、不要な操作や誤操作を防ぐことができます。 『LucaT ...</div><div class="search_word">処理権限について処理権限とは、ユーザーがシステムでどこまで操作できるかを決めるルールのことです。処理権限を設定することにより、不要な操作や誤操作を防ぐことができます。 『LucaTech GX』の処理権限では、次の表の制限を組み合わせて管理を行います。必要最低限の権限管理だけで十分な場合は、①と②のみで処理権限を管理します。部門や役職ごとに異なる処理権限を付与したいなど、さらに細かい権限管理を行う場合は、①〜⑤すべての制限を組み合わせます。 権限の種類設定可能な処理説　　明①担当者区分（管理者・オペレーター）『ログインアカウント設定』『処理権限登録』『処理権限付与』［管理者］または［オペレーター］で操作の範囲を管理します。管理者は、すべての処理が操作可能ですが、オペレーターは、『LucaTech GX』で決められた制限内でのみ操作できます。オペレーターが操作できる範囲は次を参照してください。⇒『オペレーターの操作範囲』参照②個人番号区分『ログインアカウント設定』『処理権限付与』個人番号の操作に関して、「参照のみ」「印刷可」などの制限を設定します。③メニューの表示制限『メニューパターン登録』表示するメニューを設定します。④処理の操作の制限『ロール登録』処理内の表示・印刷などの操作の範囲を設定します。⑤処理可能部門『処理権限付与』操作できる部門を設定します。 オペレーターの操作範囲担当者区分のオペレーターの操作可能範囲は次のとおりです。財務大将処理名オペレーターの操作条件付きの操作伝票入力（処理可能部門／全部門の切替）［F6 全部門］のファンクション表示が制限される。『会社基本情報』-「会計情報」で制限したとき伝票入力（期日未定）期日未定の入力が制限される。『会社基本情報』-「会計情報」で制限したとき伝票入力（税率変更）税率変更が制限される。『会社基本情報』-「会計情報」で制限したとき伝票入力（修正時 行削除）伝票修正時に行削除が制限される。『会社基本情報』-「会計情報」で制限したとき伝票入力（定型一括削除）一括削除が制限される。『会社基本情報』-「会計情報」で制限したとき</div></div><div id="CMN10018"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; 処理権限について &gt; 共通マスターとシステム別マスターの違い</div><div class="search_title">共通マスターとシステム別マスターの違い</div><div class="displayText">共通マスターとシステム別マスターの違い『LucaTech GX』では、会社作成時に［共通マスター］または［システム別マスター］のいずれかを選択します。どちらを選択したかによって、処 ...</div><div class="search_word">共通マスターとシステム別マスターの違い『LucaTech GX』では、会社作成時に［共通マスター］または［システム別マスター］のいずれかを選択します。どちらを選択したかによって、処理権限の設定やマスターの管理方法が異なります。共通マスター（推奨）共通マスターは、複数の業務システム間で社員・部門・役職などのマスター情報を一括で管理する仕組みです。各マスター（社員・役職・部門）単位で処理権限を付与できます。役職や部門単位で処理権限を付与することで、社員の異動があった場合などに処理権限を見直す手間を省くことができます。社員マスターに登録しない社外のユーザーなどに制限を設けるには、「担当者」の登録が必要です。『ログイン基本設定』で［担当者同時作成設定］を［担当者として作成する］に設定します。 システム別マスターシステム別マスターは、業務システムごとに独立したマスター情報を管理する仕組みです。『MJSLINK』および『ACELINK NX-CE』から『LucaTech GX』へ移行する場合は、基本的にこちらを使用します。［個人番号区分］［処理可能部門］などと組み合わせて処理権限を細かく設定する場合は、「担当者」の登録が必要です。『ログイン基本設定』で［担当者同時作成設定］を［担当者として作成する］に設定します。</div></div><div id="CMN10019"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; 処理権限について &gt; 処理権限の適用ルール</div><div class="search_title">処理権限の適用ルール</div><div class="displayText">処理権限の適用ルール1人の社員に対して複数の処理権限が設定されている場合、基本的にすべての処理権限が合算されて適用されます。たとえば、所属部門とその上位部門の両方に処理権限が設定さ ...</div><div class="search_word">処理権限の適用ルール1人の社員に対して複数の処理権限が設定されている場合、基本的にすべての処理権限が合算されて適用されます。たとえば、所属部門とその上位部門の両方に処理権限が設定されている場合、両方の処理権限が適用されます。（例）所属が「営業部」、上位部門が「大阪支社」の場合 → 「営業部」の処理権限が適用されます。 なお、複数の部門の権限を併せて適用したい場合は、『社員登録』で兼務部門を設定します。 権限設定例 次の表は、設定例の社員（A～E）に適用される処理権限のパターン例です。パターン社員権限役職権限部門権限付与される処理権限社員A個人番号処理権限なし人事総務処理権限個人番号処理権限人事総務処理権限社員Bなし人事部長権限人事総務処理権限人事部長権限人事総務処理権限社員Cなしなし人事総務処理権限人事総務処理権限社員Dなしなし所属部門：営業部権限上位部門：大阪支社権限兼務設定：あり営業部権限大阪支社権限社員E個人番号処理権限なし所属部門：営業部権限上位部門：大阪支社権限兼務設定：なし個人番号処理権限営業部権限大阪支社処理権限</div></div><div id="CMN10021"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; 排他制御について</div><div class="search_title">排他制御について</div><div class="displayText">排他制御についてデータの整合性を保つために、特定の処理の実行中には他の処理が実行できないように排他制御が行われます（他の処理の起動自体は可能です）。排他制御の種類とその内容について ...</div><div class="search_word">排他制御についてデータの整合性を保つために、特定の処理の実行中には他の処理が実行できないように排他制御が行われます（他の処理の起動自体は可能です）。排他制御の種類とその内容について説明します。排他制御には大きく分けて、処理に対する排他制御と伝票に対する排他制御があります。</div></div><div id="CMN10022"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; 排他制御について &gt; 排他制御の種類</div><div class="search_title">排他制御の種類</div><div class="displayText">排他制御の種類特定の処理を実行すると、他の処理の実行ができないように排他制御が行われます。排他制御が行われている処理の確認や排他制御の解除は、『ログイン状況・動作解除』で行います。 ...</div><div class="search_word">排他制御の種類特定の処理を実行すると、他の処理の実行ができないように排他制御が行われます。排他制御が行われている処理の確認や排他制御の解除は、『ログイン状況・動作解除』で行います。『ログイン状況・動作解除』については、次を参照してください。⇒『ログイン状況を解除する』参照排他制御の種類制御される内容システム別処理排他すべての会社で特定の処理を実行できません。（例）『ログインアカウント設定』の更新中は、すべての会社の『ログインアカウント設定』が更新できない。会社排他同じ会社内で処理を実行できません。（例）『決算更新』の実行中は、実行中の会社のすべての年度の処理が実行できない。年度別会社排他同じ年度・同じ会社内で処理を実行できません。（例）『決算確定』の実行中は、実行中の年度の会社の処理が実行できない。また、他の処理の実行中は、使用中の年度の会社で『決算確定』が実行できない。業務システム別会社排他同じ年度・同じ会社・同じシステム内で処理を実行できません。（例）『マスター再計算』の実行中は、実行中の年度の会社で他の『財務大将』の処理が実行できない。また、他の『財務大将』の処理の実行中は、使用中の年度の会社で『マスター再計算』が実行できない。会社別処理排他同じ年度・同じ会社・特定の処理内で処理を実行できません。（例）『会社基本情報登録』の登録中は、登録中の年度の会社で『会社基本情報登録』が実行できない。 次の処理の実行中に上記の排他制御がかかります。システム共通の処理排他制御の要因となる処理排他制御の種類［設定］＞［システム管理］＞［ログイン・権限付与］＞［ログインアカウント設定］システム別処理排他［データ関係処理］＞［会社データ管理］＞［決算更新］会社排他【体系の予約情報があるとき】［設定］＞［マスター登録処理］＞［組織更新］＞［組織更新］会社排他［設定］＞［システム管理］＞［データ関係］＞［利用システム設定］会社排他［データ関係処理］＞［会社データ管理］＞［決算確定］年度別会社排他［データ関係処理］＞［会社データ管理］＞［残高再移送］年度別会社排他［設定］＞［導入処理］＞［会社情報］＞［マスター採用情報登録］年度別会社排他［設定］＞［システム管理］＞［データ関係］＞［会社データ削除］年度別会社排他［データ関係処理］＞［データ交換］＞［設定］＞［データ変換パターン登録］会社別処理排他［データ関係処理］＞［データ交換］＞［設定］＞［コード変換パターン登録］会社別処理排他［設定］＞［導入処理］＞［会社情報］＞［会社基本情報登録］会社別処理排他［設定］＞［導入処理］＞［会社情報］＞［休日登録］会社別処理排他［設定］＞［マスター登録処理］＞［科目関係］＞［科目登録］会社別処理排他［設定］＞［マスター登録処理］＞［科目関係］＞［科目別補助登録］会社別処理排他［設定］＞［マスター登録処理］＞［部門関係］＞［部門所属体系登録］会社別処理排他［設定］＞［マスター登録処理］＞［部門関係］＞［部門出力順序設定］会社別処理排他［設定］＞［マスター登録処理］＞［銀行関係］＞［銀行登録］会社別処理排他［設定］＞［マスター登録処理］＞［取引先関係］＞［取引先登録］会社別処理排他［設定］＞［マスター登録処理］＞［汎用補助関係］＞［汎用補助登録］会社別処理排他［設定］＞［マスター登録処理］＞［社員関係］＞［社員登録］会社別処理排他［設定］＞［マスター登録処理］＞［社員関係］＞［所属人員登録］会社別処理排他［設定］＞［マスター登録処理］＞［役職登録］＞［役職登録］会社別処理排他［設定］＞［マスター登録処理］＞［役職登録］＞［役職体系登録］会社別処理排他［設定］＞［マスター登録処理］＞［摘要関係］＞［固定摘要登録］会社別処理排他［設定］＞［マスター登録処理］＞［組織更新］＞［部門所属体系登録（予約）］会社別処理排他［設定］＞［マスター登録処理］＞［組織更新］＞［所属人員登録（予約）］会社別処理排他【体系の予約情報がないとき】［設定］＞［マスター登録処理］＞［組織更新］＞［組織更新］会社別処理排他［設定］＞［マスター登録処理］＞［その他］＞［分類登録］会社別処理排他［設定］＞［マスター登録処理］＞［その他］＞［システム別表示設定］会社別処理排他［設定］＞［マスター登録処理］＞［その他］＞［各種コード変更］会社別処理排他［設定］＞［システム管理］＞［データ関係］＞［会社作成処理］会社別処理排他［設定］＞［システム管理］＞［ログイン・権限付与］＞［メニューパターン登録］会社別処理排他［設定］＞［システム管理］＞［ログイン・権限付与］＞［ロール登録］会社別処理排他［設定］＞［システム管理］＞［ログイン・権限付与］＞［ポリシー設定］会社別処理排他［設定］＞［システム管理］＞［ログイン・権限付与］＞［CSサポート招待］会社別処理排他［設定］＞［システム管理］＞［ユーティリティ］＞［ログイン状況・動作解除］会社別処理排他 財務大将の処理排他制御の対象となる処理排他制御の種類［設定］＞［導入処理］＞［財務］＞［共通補助出力順序設定］会社別処理排他［財務大将］＞［日常処理］＞［マスター］＞［マスター更新］会社別処理排他（※）［財務大将］＞［日常処理］＞［会計データ確定］＞［データ確定］業務システム別会社排他［財務大将］＞［日常処理］＞［復旧関係処理］＞［マスター再計算］業務システム別会社排他（※）マスター更新中は、仕訳入力もできなくなります。 固定資産管理の処理排他制御の対象となる処理排他制御の種類［設定］＞［導入処理］＞［資産管理］＞［資産基本情報設定］業務システム別会社排他［設定］＞［導入処理］＞［資産管理］＞［資産種類登録］業務システム別会社排他［固定資産管理］＞［資産管理］＞［資産異動］＞［償却方法変更登録］業務システム別会社排他［固定資産管理］＞［資産管理］＞［翌期関係処理］＞［処理年度切替］業務システム別会社排他［固定資産管理］＞［資産管理］＞［翌期関係処理］＞［翌期情報作成］業務システム別会社排他［固定資産管理］＞［資産管理］＞［翌期関係処理］＞［翌期情報削除］業務システム別会社排他［固定資産管理］＞［資産管理］＞［復旧関係処理］＞［資産マスター再計算］業務システム別会社排他</div></div><div id="CMN10023"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; 排他制御について &gt; 伝票の修正による排他制御</div><div class="search_title">伝票の修正による排他制御</div><div class="displayText">伝票の修正による排他制御更新済みの伝票を修正すると、その伝票の編集や他の処理の実行ができないように排他制御が行われます。排他制御が行われている伝票の確認や排他制御の解除は、『伝票排 ...</div><div class="search_word">伝票の修正による排他制御更新済みの伝票を修正すると、その伝票の編集や他の処理の実行ができないように排他制御が行われます。排他制御が行われている伝票の確認や排他制御の解除は、『伝票排他情報解除』で行います。『伝票排他情報解除』については、次を参照してください。⇒『伝票の排他情報を解除する』参照排他制御により次の影響があります。修正中の伝票を編集できません。『データ確定』を実行した結果、修正中の伝票に対するデータ確定ができずエラーが発生します。『マスター再計算』を実行した結果、修正中の伝票に更新が行われずエラーが発生します。</div></div><div id="CMN10024"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; マスターの登録可能件数と制限</div><div class="search_title">マスターの登録可能件数と制限</div><div class="displayText">マスターの登録可能件数と制限『LucaTech GX』で登録できるマスターの件数や文字数などの制限は次のとおりです。 共通分類項目名桁数・文字数・件数備考会社関係会社数1社ライセン ...</div><div class="search_word">マスターの登録可能件数と制限『LucaTech GX』で登録できるマスターの件数や文字数などの制限は次のとおりです。 共通分類項目名桁数・文字数・件数備考会社関係会社数1社ライセンス契約数が上限となる会社コード8桁 科目関係実在科目2,000件 合計科目1,000件 科目コード桁数10桁 科目コード属性数字のみ、数字（前ゼロあり）、フリー 正式名称全半角20文字（全半角混在可） 簡略名称全半角10文字（全半角混在可） 資金繰科目桁数数字2～4桁 科目別補助科目別補助1科目につき9,999件 科目別補助コード桁数1～10桁 科目別補助コード属性数字のみ、数字（前ゼロあり）、フリー 正式名称全半角30文字（全半角混在可） 簡略名称全半角10文字（全半角混在可） 部門部門件数（実在・合計）1,000件 部門コード桁数1～20桁 部門コード属性数字のみ、数字（前ゼロあり）、フリー 正式名称全半角30文字（全半角混在可） 簡略名称全半角15文字（全半角混在可） 組織組織パターン件数99パターンうち1種類は実在組織として使用社員社員数500人 社員コード数字のみ、数字（前ゼロあり）、フリー1～20桁 社員名称姓：全半角20文字名：全半角20文字 得意先得意先件数10,000件仕入先も同様得意先コード桁数1～20桁仕入先も同様正式名称全半角60文字仕入先も同様簡略名称全半角40文字仕入先も同様銀行件数（実在・合計）100,000件　コード1～20桁　名称全半角30文字　銀行銀行件数（実在・合計）100,000件 コード1～20桁 名称全半角30文字 役職役職件数999,999件 コード桁数1～10桁 コード属性数字のみ・フリー  財務大将分類項目名桁数・文字数・件数備考科目関係予算管理予算4種類 仕訳仕訳件数／１年60,000件 明細行数／１伝票999行 金額桁数13桁 伝票No.桁数15桁 伝票No.属性数字 摘要文字全半角64文字（全半角混在可） 固定摘要固定摘要10,000件 摘要コード桁数10桁 文字数全半角20文字（全半角混在可） 摘要コード属性数字 摘要分類1,000件 摘要残高10,000件 科目別補助予算管理予算4種類 部門部門配賦パターン2,000件 部門配賦基準2,000件 予算管理予算4種類  固定資産管理分類項目名桁数・文字数・件数備考実在資産種類コード桁数4桁 コード属性数字 件数9,999件 文字数正式：全半角10文字簡略：全半角4文字 合計資産種類コード桁数5桁 コード属性数字 件数9,999件 文字数正式：全半角10文字 コード範囲10000～99999の範囲 所在地コード桁数7桁 コード属性数字 件数999,999件 文字数正式：全半角25文字簡略：全半角10文字 償却資産税コード桁数6桁 コード属性数字 件数999,999件 文字数正式：全半角15文字簡略：全半角10文字 構造・細目コード桁数4桁 コード属性数字 件数無制限 文字数正式：全半角25文字 メモ管理コード桁数4桁 コード属性数字 件数無制限 文字数正式：全半角8文字 メモ辞書コード桁数6桁 コード属性数字 件数無制限 文字数正式：全半角10文字 配賦パターンコード桁数4桁 コード属性数字 件数無制限 文字数正式：全半角12文字 物件コード桁数15桁（枝番4桁は除く） コード属性数字のみ、数字（前ゼロあり）、フリー 件数2,000件 文字数正式：全半角40文字簡略：全半角20文字  ワークフロー分類項目名桁数・文字数・件数備考承認ルート基本情報承認ルート件数無制限 承認ルート名称全半角40文字 申請部門数無制限 管理部門数無制限 承認ルート処理者数無制限 承認段階数無制限 承認階層数99 分岐先数999 並列先数999 申請・承認申請件数無制限 添付ファイル容量200MB（1申請書あたり。1ファイルあたり最大20MB、最大20ファイルまで添付可。） 添付ファイル名称510文字（拡張子含む） </div></div><div id="CMN10025"><div class="search_breadcrumbs">LucaTech GXについて &gt; LucaTech GXについて &gt; ドメインの追加について</div><div class="search_title">ドメインの追加について</div><div class="displayText">ドメインの追加についてユーザーの環境でプロキシなどによるアクセス制限を行っている場合は、以下のドメインを許可リストに追加してください。ドメイン名用途mjscloud.mjsdx.m ...</div><div class="search_word">ドメインの追加についてユーザーの環境でプロキシなどによるアクセス制限を行っている場合は、以下のドメインを許可リストに追加してください。ドメイン名用途mjscloud.mjsdx.mjs.co.jp『LucaTech GX』mjscloudhelp.mjsdx.mjs.co.jp『LucaTech GX』ヘルプgoodwill.mjs.co.jpFAQMJSからのお知らせmsupport50.mjs.co.jpmsupport50dm.mjs.co.jp遠隔サポートサービスinfo.support.mjs.co.jpMJS障害・メンテナンス情報mjs-genius-prod.service.signalr.netバッチジョブ監視auth.bizsky.jpbizskyの認証</div></div></div>');
// ========================================
// グローバル変数定義
// ========================================

// MutationObserver機能用のグローバル変数
var currentSearchValue = ""; // 現在の検索キーワード
var mutationObserver = null; // MutationObserverインスタンス
var debounceTimer = null; // DOM変更用のデバウンスタイマー

// jQueryセレクタキャッシュ
var $cachedElements = {
    iframe: null,
    searchField: null,
    searchResultItemsBlock: null,
    searchResultsEnd: null,
    searchMsg: null,
    searchInput: null
};

// セレクタマップ（キャッシュ機構の効率化）
var selectorMap = {
    iframe: "iframe.topic",
    searchField: ".wSearchField",
    searchResultItemsBlock: ".wSearchResultItemsBlock",
    searchResultsEnd: ".wSearchResultsEnd",
    searchMsg: "#searchMsg",
    searchInput: ".search-input"
};

// HTMLエンティティ復元用の正規表現（効率化のためグローバル定義）
var htmlEntityRegexes = {
    nbsp: /&nbsp;(?=[^<>]*<)/gm,
    gt: /&gt;(?=[^<>]*<)/gm,
    lt: /&lt;(?=[^<>]*<)/gm,
    quot: /&quot;(?=[^<>]*<)/gm,
    amp: /&amp;(?=[^<>]*<)/gm
};

// 文字変換マップ（効率化のため初期化時に正規表現を構築）
var characterMappings = (function () {
    // 文字変換用の配列定義（配列リテラルに変更）
    var wide = ["０", "１", "２", "３", "４", "５", "６", "７", "８", "９", "ａ", "ｂ", "ｃ", "ｄ", "ｅ", "ｆ", "ｇ", "ｈ", "ｉ", "ｊ", "ｋ", "ｌ", "ｍ", "ｎ", "ｏ", "ｐ", "ｑ", "ｒ", "ｓ", "ｔ", "ｕ", "ｖ", "ｗ", "ｘ", "ｙ", "ｚ", "ガ", "ギ", "グ", "ゲ", "ゴ", "ザ", "ジ", "ズ", "ゼ", "ゾ", "ダ", "ヂ", "ヅ", "デ", "ド", "バ", "ビ", "ブ", "ベ", "ボ", "パ", "ピ", "プ", "ペ", "ポ", "。", "「", "」", "、", "ヲ", "ァ", "ィ", "ゥ", "ェ", "ォ", "ャ", "ュ", "ョ", "ッ", "ー", "ア", "イ", "ウ", "エ", "オ", "カ", "キ", "ク", "ケ", "コ", "サ", "シ", "ス", "セ", "ソ", "タ", "チ", "ツ", "テ", "ト", "ナ", "ニ", "ヌ", "ネ", "ノ", "ハ", "ヒ", "フ", "ヘ", "ホ", "マ", "ミ", "ム", "メ", "モ", "ヤ", "ユ", "ヨ", "ラ", "リ", "ル", "レ", "ロ", "ワ", "ン"];
    var narrow = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "ｶﾞ", "ｷﾞ", "ｸﾞ", "ｹﾞ", "ｺﾞ", "ｻﾞ", "ｼﾞ", "ｽﾞ", "ｾﾞ", "ｿﾞ", "ﾀﾞ", "ﾁﾞ", "ﾂﾞ", "ﾃﾞ", "ﾄﾞ", "ﾊﾞ", "ﾋﾞ", "ﾌﾞ", "ﾍﾞ", "ﾎﾞ", "ﾊﾟ", "ﾋﾟ", "ﾌﾟ", "ﾍﾟ", "ﾎﾟ", "｡", "｢", "｣", "､", "ｦ", "ｧ", "ｨ", "ｩ", "ｪ", "ｫ", "ｬ", "ｭ", "ｮ", "ｯ", "ｰ", "ｱ", "ｲ", "ｳ", "ｴ", "ｵ", "ｶ", "ｷ", "ｸ", "ｹ", "ｺ", "ｻ", "ｼ", "ｽ", "ｾ", "ｿ", "ﾀ", "ﾁ", "ﾂ", "ﾃ", "ﾄ", "ﾅ", "ﾆ", "ﾇ", "ﾈ", "ﾉ", "ﾊ", "ﾋ", "ﾌ", "ﾍ", "ﾎ", "ﾏ", "ﾐ", "ﾑ", "ﾒ", "ﾓ", "ﾔ", "ﾕ", "ﾖ", "ﾗ", "ﾘ", "ﾙ", "ﾚ", "ﾛ", "ﾜ", "ﾝ"];
    var highlight = ["(?:０|0)", "(?:１|1)", "(?:２|2)", "(?:３|3)", "(?:４|4)", "(?:５|5)", "(?:６|6)", "(?:７|7)", "(?:８|8)", "(?:９|9)", "(?:ａ|a)", "(?:ｂ|b)", "(?:ｃ|c)", "(?:ｄ|d)", "(?:ｅ|e)", "(?:ｆ|f)", "(?:ｇ|g)", "(?:ｈ|h)", "(?:ｉ|i)", "(?:ｊ|j)", "(?:ｋ|k)", "(?:ｌ|l)", "(?:ｍ|m)", "(?:ｎ|n)", "(?:ｏ|o)", "(?:ｐ|p)", "(?:ｑ|q)", "(?:ｒ|r)", "(?:ｓ|s)", "(?:ｔ|t)", "(?:ｕ|u)", "(?:ｖ|v)", "(?:ｗ|w)", "(?:ｘ|x)", "(?:ｙ|y)", "(?:ｚ|z)", "(?:ガ|ｶﾞ)", "(?:ギ|ｷﾞ)", "(?:グ|ｸﾞ)", "(?:ゲ|ｹﾞ)", "(?:ゴ|ｺﾞ)", "(?:ザ|ｻﾞ)", "(?:ジ|ｼﾞ)", "(?:ズ|ｽﾞ)", "(?:ゼ|ｾﾞ)", "(?:ゾ|ｿﾞ)", "(?:ダ|ﾀﾞ)", "(?:ヂ|ﾁﾞ)", "(?:ヅ|ﾂﾞ)", "(?:デ|ﾃﾞ)", "(?:ド|ﾄﾞ)", "(?:バ|ﾊﾞ)", "(?:ビ|ﾋﾞ)", "(?:ブ|ﾌﾞ)", "(?:ベ|ﾍﾞ)", "(?:ボ|ﾎﾞ)", "(?:パ|ﾊﾟ)", "(?:ピ|ﾋﾟ)", "(?:プ|ﾌﾟ)", "(?:ペ|ﾍﾟ)", "(?:ポ|ﾎﾟ)", "(?:。|｡)", "(?:「|｢)", "(?:」|｣)", "(?:、|､)", "(?:ヲ|ｦ)", "(?:ァ|ｧ)", "(?:ィ|ｨ)", "(?:ゥ|ｩ)", "(?:ェ|ｪ)", "(?:ォ|ｫ)", "(?:ャ|ｬ)", "(?:ュ|ｭ)", "(?:ョ|ｮ)", "(?:ッ|ｯ)", "(?:ー|ｰ)", "(?:ア|ｱ)", "(?:イ|ｲ)", "(?:ウ|ｳ)", "(?:エ|ｴ)", "(?:オ|ｵ)", "(?:カ|ｶ)", "(?:キ|ｷ)", "(?:ク|ｸ)", "(?:ケ|ｹ)", "(?:コ|ｺ)", "(?:サ|ｻ)", "(?:シ|ｼ)", "(?:ス|ｽ)", "(?:セ|ｾ)", "(?:ソ|ｿ)", "(?:タ|ﾀ)", "(?:チ|ﾁ)", "(?:ツ|ﾂ)", "(?:テ|ﾃ)", "(?:ト|ﾄ)", "(?:ナ|ﾅ)", "(?:ニ|ﾆ)", "(?:ヌ|ﾇ)", "(?:ネ|ﾈ)", "(?:ノ|ﾉ)", "(?:ハ|ﾊ)", "(?:ヒ|ﾋ)", "(?:フ|ﾌ)", "(?:ヘ|ﾍ)", "(?:ホ|ﾎ)", "(?:マ|ﾏ)", "(?:ミ|ﾐ)", "(?:ム|ﾑ)", "(?:メ|ﾒ)", "(?:モ|ﾓ)", "(?:ヤ|ﾔ)", "(?:ユ|ﾕ)", "(?:ヨ|ﾖ)", "(?:ラ|ﾗ)", "(?:リ|ﾘ)", "(?:ル|ﾙ)", "(?:レ|ﾚ)", "(?:ロ|ﾛ)", "(?:ワ|ﾜ)", "(?:ン|ﾝ)"];

    // 全角→半角の変換マップを作成
    var wideToNarrowMap = {};
    var narrowToHighlightMap = {};

    for (var i = 0; i < wide.length; i++) {
        wideToNarrowMap[wide[i]] = narrow[i];
        // 半角文字をキーにしてハイライトパターンをマップ
        narrowToHighlightMap[narrow[i]] = highlight[i];
    }

    // 全角文字の正規表現パターンを作成（エスケープ処理を含む）
    var wideCharsPattern = wide.map(function (char) {
        return char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }).join('|');

    var wideToNarrowRegex = new RegExp(wideCharsPattern, 'g');

    return {
        wideToNarrowMap: wideToNarrowMap,
        narrowToHighlightMap: narrowToHighlightMap,
        wideToNarrowRegex: wideToNarrowRegex,
        // 効率的な変換関数
        convertWideToNarrow: function (text) {
            return text.replace(wideToNarrowRegex, function (match) {
                return wideToNarrowMap[match] || match;
            });
        }
    };
})();

// ========================================
// 基本ユーティリティ関数（依存なし）
// ========================================

// セレクタ用のエスケープ処理
function selectorEscape(val) {
    return val.replace(/[-\/\\^$*+?.()|[\]{}\!]/g, '\\$&');
}

// 文字列を正規化（全角→半角カナ変換、小文字化）
function normalizeForSearch(text) {
    var normalized = text.toLowerCase();
    return characterMappings.convertWideToNarrow(normalized);
}

// HTMLエンティティを復元
function decodeHtmlEntities(html) {
    return html
        .replace(htmlEntityRegexes.nbsp, "　")
        .replace(htmlEntityRegexes.gt, ">")
        .replace(htmlEntityRegexes.lt, "<")
        .replace(htmlEntityRegexes.quot, '"')
        .replace(htmlEntityRegexes.amp, "&");
}

// ========================================
// キャッシュ管理関数
// ========================================

// キャッシュを初期化
function initializeCachedElements() {
    for (var key in selectorMap) {
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
}

// キャッシュされた要素を取得（存在チェック付き）
function getCachedElement(key) {
    if (!$cachedElements[key] || $cachedElements[key].length === 0) {
        // キャッシュが無効な場合は再取得
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
    return $cachedElements[key];
}

// ========================================
// 検索処理関連関数（依存関係順）
// ========================================

// 検索語を正規化してエスケープ
function prepareSearchWords(searchValue) {
    // 全角・半角スペースを統一して連続スペースを1つにまとめる
    var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim().toLowerCase();
    searchWordTmp = characterMappings.convertWideToNarrow(searchWordTmp);

    var searchWord = searchWordTmp.split(" ");
    for (var i = 0; i < searchWord.length; i++) {
        searchWord[i] = selectorEscape(searchWord[i].replace(/>/g, "&gt;").replace(/</g, "&lt;"));
    }
    return searchWord;
}

// ハイライト用の正規表現パターンを生成
function createHighlightPattern(searchWords) {
    // 各検索ワードを全角・半角両対応のパターンに変換
    var patterns = searchWords.map(function(word) {
        // 2文字パターンを優先的にマッチさせる正規表現を作成
        var result = '';
        var pos = 0;
        
        while (pos < word.length) {
            var matched = false;
            
            // 2文字の組み合わせを試行
            if (pos + 1 < word.length) {
                var twoChar = word.substring(pos, pos + 2);
                var pattern = characterMappings.narrowToHighlightMap[twoChar];
                if (pattern) {
                    result += pattern;
                    pos += 2;
                    matched = true;
                }
            }
            
            // 1文字で処理
            if (!matched) {
                var char = word.charAt(pos);
                var pattern = characterMappings.narrowToHighlightMap[char];
                result += pattern || char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                pos++;
            }
        }
        
        return result;
    });
    return patterns.join("|");
}

// iframeのbody要素を取得
function getIframeBody() {
    var $iframe = getCachedElement('iframe');
    if ($iframe.length === 0) return null;
    return $iframe.contents().find("body");
}

// iframeコンテンツにハイライトを適用
function applyHighlight(searchValue) {
    var $body = getIframeBody();
    if (!$body) return;

    var searchWords = prepareSearchWords(searchValue);
    var highlightPattern = createHighlightPattern(searchWords);
    var reg = new RegExp("(" + highlightPattern + ")(?=[^<>]*<)", "gmi");
    var html = $body.html();
    var decodedHtml = decodeHtmlEntities(html);
    var highlightedHtml = decodedHtml.replace(reg, "<font class='keyword' style='color:rgb(0, 0, 0); background-color:rgb(252, 255, 0);'>$1</font>");

    $body.html(highlightedHtml);
}

// キーワードのハイライトを削除
function removeHighlight() {
    var $body = getIframeBody();
    if (!$body) return;

    $body.find(".keyword").each(function () {
        var $this = $(this);
        $this.replaceWith($this.contents());
    });
}

// 検索結果をクリア
function clearSearchResults() {
    var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
    var $searchResultsEnd = getCachedElement('searchResultsEnd');
    var $searchMsg = getCachedElement('searchMsg');

    $searchResultItemsBlock.html("");
    $searchResultsEnd.addClass("rh-hide");
    $searchResultsEnd.attr("hidden", "");
    $searchMsg.html("2つ以上の語句を入力して検索する場合は、スペース（空白）で区切ります。");
    removeHighlight();
    currentSearchValue = "";
    disconnectMutationObserver();
}

// ========================================
// MutationObserver関連関数
// ========================================

// キーワード要素のみの追加かどうかを判定
function isOnlyKeywordAddition(mutation) {
    if (mutation.addedNodes.length !== 1) {
        return false;
    }
    
    var node = mutation.addedNodes[0];
    if (node.nodeType !== Node.ELEMENT_NODE) {
        return false;
    }
    
    // 追加されたノードがキーワード要素か、キーワード要素を含むか
    return (node.classList && node.classList.contains('keyword')) ||
           (node.querySelector && node.querySelector('.keyword') !== null);
}

// デバウンスされた再ハイライト処理
function debouncedReHighlight() {
    if (debounceTimer) {
        clearTimeout(debounceTimer);
    }

    debounceTimer = setTimeout(function () {
        reHighlightAfterDomChange();
    }, 500);
}

// DOM変更後の再ハイライト処理
function reHighlightAfterDomChange() {
    if (!currentSearchValue || currentSearchValue.trim() === "") {
        return;
    }

    try {
        disconnectMutationObserver();
        removeHighlight();
        applyHighlight(currentSearchValue);

        setTimeout(function () {
            setupMutationObserver();
        }, 100);

        console.debug("DOM変更後に検索語を再ハイライトしました");
    } catch (error) {
        console.warn("DOM変更後の再ハイライトに失敗しました:", error);
        setupMutationObserver();
    }
}

// iframeコンテンツ用のMutationObserverをセットアップ
function setupMutationObserver() {
    disconnectMutationObserver();

    try {
        var $iframe = getCachedElement('iframe');
        if ($iframe.length === 0) return;

        var iframeDocument = $iframe[0].contentDocument || $iframe[0].contentWindow.document;
        if (!iframeDocument || !iframeDocument.body) return;

        mutationObserver = new MutationObserver(function (mutations) {
            if (!currentSearchValue || currentSearchValue.trim() === "") {
                return;
            }

            var shouldReHighlight = mutations.some(function(mutation) {
                if (mutation.type === 'characterData') {
                    return true;
                }
                
                if (mutation.type === 'childList') {
                    // キーワード要素自身の追加は無視
                    if (isOnlyKeywordAddition(mutation)) {
                        return false;
                    }
                    
                    // ノードの追加または削除があれば再ハイライト
                    return mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0;
                }
                
                return false;
            });

            if (shouldReHighlight) {
                debouncedReHighlight();
            }
        });

        mutationObserver.observe(iframeDocument.body, {
            childList: true,
            subtree: true,
            characterData: true,
            attributes: false
        });

        console.debug("iframeコンテンツ用のMutationObserverをセットアップしました");
    } catch (error) {
        console.warn("MutationObserverのセットアップに失敗しました:", error);
    }
}

// MutationObserverを切断
function disconnectMutationObserver() {
    if (mutationObserver) {
        mutationObserver.disconnect();
        mutationObserver = null;
    }

    if (debounceTimer) {
        clearTimeout(debounceTimer);
        debounceTimer = null;
    }
}

// ========================================
// jQueryカスタムセレクタ
// ========================================

// カスタムの:contains()セレクタ（正規化された検索用）
$.expr[':'].containsNormalized = function (elem, index, match) {
    var normalizedElemText = normalizeForSearch($(elem).text());
    var normalizedSearchText = normalizeForSearch(match[3]);
    return normalizedElemText.indexOf(normalizedSearchText) >= 0;
};

// ========================================
// jQueryイベントハンドラー
// ========================================

$(function () {
    // 要素のキャッシュを初期化
    initializeCachedElements();

    $(document).on("click", "ul.toc li.book", function () {
        if ($(this).children("a[href='#'],a[href='javascript:void 0;']").length == 0) {
            $(this).children("a").each(function () {
                location.href = location.href.replace(location.hash, "") + "#t=" + $(this).attr("href");
            });
        }
    });

    getCachedElement('searchField').each(function () {
        $(this).off();
    });

    $(document).on("keyup", ".wSearchField", function () {
        var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
        var $searchResultsEnd = getCachedElement('searchResultsEnd');
        var $searchMsg = getCachedElement('searchMsg');
        var searchValue = $(this).val();

        // trim()を追加してスペースのみの入力も空として扱う
        if (searchValue.trim() === "") {
            clearSearchResults();
            return;
        }

        $searchMsg.html("");
        currentSearchValue = searchValue; // 現在の検索値を保存
        
        // スペースを正規化
        var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim();
        // 正規化（全角→半角カナ、小文字化）
        searchWordTmp = normalizeForSearch(searchWordTmp);

        // 正規化後も空文字列チェックを追加
        if (searchWordTmp === "") {
            clearSearchResults();
            return;
        }

        var searchWord = searchWordTmp.split(" ");
        var searchQuery = searchWord.map(function(word) {
            return ":containsNormalized(" + word + ")";
        }).join("");

        var findItems = searchWords.find(".search_word" + searchQuery);
        if (findItems.length !== 0) {
            $searchResultsEnd.removeClass("rh-hide");
            $searchResultsEnd.removeAttr("hidden");
            $searchResultItemsBlock.html("");
            findItems.each(function () {
                var displayText = $(this).parent().find(".displayText").text();
                var parentId = $(this).parent().attr("id");
                var searchTitle = $(this).parent().find(".search_title").html();
                
                var resultHtml = "<div class='wSearchResultItem'>" +
                    "<a class='nolink' href='./" + parentId + ".html'>" +
                    "<div class='wSearchResultTitle'>" + searchTitle + "</div>" +
                    "</a>" +
                    "<div class='wSearchContent'>" +
                    "<span class='wSearchContext'>" + displayText + "</span>" +
                    "</div></div>";
                
                $searchResultItemsBlock.append($(resultHtml));
            });
            removeHighlight();
            applyHighlight(currentSearchValue);
        }
        else {
            removeHighlight();
            $searchResultsEnd.addClass("rh-hide");
            $searchResultsEnd.attr("hidden", "");
            $searchResultItemsBlock.html("");
            var displayText = "検索条件に一致するトピックはありません。";
            $searchResultItemsBlock.append($("<div class='wSearchResultItem'><div class='wSearchContent'><span class='wSearchContext'>" + displayText + "</span></div></div>"));
        }
    });

    getCachedElement('iframe').on("load", function () {
        var $searchInput = getCachedElement('searchInput');
        var $searchField = getCachedElement('searchField');

        if ($searchInput.is(":not(.rh-hide)") && ($searchField.val() != "")) {
            var searchValue = $searchField.val();
            currentSearchValue = searchValue; // 現在の検索値を保存
            applyHighlight(searchValue);
        }

        // iframeコンテンツ変更用のMutationObserverをセットアップ
        setupMutationObserver();
    });
});
