var searchWords = $('<div class="search"><div id="MAS16001"><div class="search_breadcrumbs">電子帳簿 &gt; はじめに</div></div><div id="MAS16003"><div class="search_breadcrumbs">電子帳簿 &gt; ●　電子帳簿について &gt; 電子帳簿保存法について</div><div class="search_title">電子帳簿保存法について</div><div class="displayText">電子帳簿保存法について電子帳簿保存法の対象となる帳簿について『LucaTech GX』の『財務大将』では、「電子帳簿保存法」に定める「優良な電子帳簿」の要件を満たした、次の国税関係 ...</div><div class="search_word">電子帳簿保存法について電子帳簿保存法の対象となる帳簿について『LucaTech GX』の『財務大将』では、「電子帳簿保存法」に定める「優良な電子帳簿」の要件を満たした、次の国税関係帳簿書類を保存できます。帳簿仕訳帳 その他書類決算報告書消費税精算表 電子帳簿保存法第4条第1項（電磁的記録による備付及び保存）に関する事項「訂正又は削除の事実及び内容の確認に関する措置」（施行規則第2条第6項第2号ニ関係）については、「データを直接に訂正し又は削除することができるが、その事実及び内容が自動的に記録されるシステムを使用する。」に該当しています。また、内部規定がある場合は、入力日から7日以内であれば訂正・削除の事実および内容を残さない設定も可能です。「追加入力した事実の確認に関する措置」（施行規則第5条第5項第1号イ関係）については、「入力データに入力年月日の情報を自動的に付加する（付加した情報を訂正し又は削除することができない）システムを使用する。」に該当しています。「国税関係帳簿間の記録事項の関連性の確認に関する措置」（施行規則第5条第5項第1号イ関係）については、「一連番号により国税関係帳簿間の関連性を確認することができるようにする。」に該当しています。「システム関係書類及び事務手続関係書類の備付に関する措置」（施行規則第2条第6項第4号関係）のシステム操作説明書については「システムの操作説明書」（本書）に該当しています。「ディスプレイ及びプリンタの備付け並びに出力に関する措置」（施行規則第2条第2項第2号関係）については、「電磁的記録の備付け及び保存をする場所に出力のための電子計算機、プログラム、ディスプレイ及びプリンタを備え付けて、電磁的記録をディスプレイの画面及び書面に、整然とした形式及び明瞭な状態で出力することができるようにする。」に対応するシステム設計をしています。「検索機能の確保に関する措置」（施行規則第2条第2項第6号関係）については、「主要な記録項目を検索の条件として設定することができる。」の項目に関して次のとおり対応しています。仕訳帳については、取引年月日・勘定科目・取引金額による条件を設定できます。総勘定元帳・売掛金元帳・買掛金元帳については、取引年月日・勘定科目・取引金額・相手方勘定科目の検索条件を設定できます。日付または金額に係る記録項目は、その範囲を指定して条件を設定できます。2つ以上の任意の記録項目を組み合わせて条件を設定できます。</div></div><div id="MAS16004"><div class="search_breadcrumbs">電子帳簿 &gt; ●　電子帳簿について &gt; LucaTech GXにおける電子帳簿への対応について</div><div class="search_title">LucaTech GXにおける電子帳簿への対応について</div><div class="displayText">LucaTech GXにおける電子帳簿への対応について『LucaTech GX』における電子帳簿に関する機能は次のとおりです。 導入設定について電子帳簿を利用するには、あらかじめ［ ...</div><div class="search_word">LucaTech GXにおける電子帳簿への対応について『LucaTech GX』における電子帳簿に関する機能は次のとおりです。 導入設定について電子帳簿を利用するには、あらかじめ［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］で電子帳簿を採用する必要があります。電子帳簿の採用については、次を参照してください。⇒『電子帳簿の導入設定を行う』参照 電子帳簿の表示・印刷、履歴の確認について電子帳簿として帳票類を確認・出力したり、履歴を確認する場合は、［財務大将］＞［帳簿］＞［電子帳簿］［その他書類］［履歴］から行います。   『帳簿』では、仕訳帳や決算報告書などの帳票を表示・出力できます。また、仕訳の修正履歴・削除履歴の表示・出力もできます。『帳簿』で表示・出力できる内容は、『LucaTech GX』で入力したデータと同一です。仕訳の各項目は、日付や数値情報として保持されます。 各処理の操作方法は『日常処理』のメニューと同様です。ただし、電子帳簿保存法に対応して一部の項目の表示が異なる場合があります。各処理の説明については、次を参照してください。 メニュー名参照先仕訳帳⇒『仕訳帳形式で仕訳を確認する』参照決算報告書⇒『決算書の出力について』参照消費税精算表⇒『消費税精算表を出力する』参照仕訳削除修正履歴⇒『仕訳の削除・修正履歴を表示する』参照 帳簿書類の保存について『LucaTech GX』では、クラウド上にデータが自動保存されるため手動でのバックアップは不要です。データの保存期間は11年度分（当年＋過去10年度分）です。ライセンスを購入することで、保存期間を12年度分以上に延長することもできます。   「優良な電子帳簿」を保存するための前提条件最初から電子計算機（主にパソコン）を使用して帳簿書類を作成する必要があります。この帳簿書類にはすべての取引データを保存する必要があります。『LucaTech   GX』に期首からすべての仕訳データを保存しておく必要があります。</div></div><div id="MAS16006"><div class="search_breadcrumbs">電子帳簿 &gt; ●　電子帳簿の導入設定 &gt; 電子帳簿の導入設定を行う</div><div class="search_title">電子帳簿の導入設定を行う</div><div class="displayText">電子帳簿の導入設定を行う電子帳簿を使い始めるための設定を行います。   設定は仕訳データ入力前に行います電子帳簿の採用および設定は、課税期間の初日のデータを入力する前に行います。設 ...</div><div class="search_word">電子帳簿の導入設定を行う電子帳簿を使い始めるための設定を行います。   設定は仕訳データ入力前に行います電子帳簿の採用および設定は、課税期間の初日のデータを入力する前に行います。設定前に入力した仕訳データ等の履歴は管理されません。</div></div><div id="MAS16007"><div class="search_breadcrumbs">電子帳簿 &gt; ●　電子帳簿の導入設定 &gt; 電子帳簿の導入設定を行う &gt; 電子帳簿基本情報を登録する</div><div class="search_title">電子帳簿基本情報を登録する</div><div class="displayText">電子帳簿基本情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［基本情報］タブ電子帳簿で使用する各機能の採用と、履歴を残すまでの猶予日数を登録します。 採用区 ...</div><div class="search_word">電子帳簿基本情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［基本情報］タブ電子帳簿で使用する各機能の採用と、履歴を残すまでの猶予日数を登録します。 採用区分電子帳簿採用区分選択中の会社データで電子帳簿を使用する場合は［採用する］を選択します。この設定により、電子帳簿の表示・印刷が可能になります。スキャナ保存『スキャナ保存対応』のライセンスを購入している場合に表示されます。スキャナ保存制度の要件を満たしているかのチェックを行う場合は［採用する］を選択します。タイムスタンプ採用区分『スキャナ保存対応』のライセンスを購入している場合に表示されます。『財務大将』におけるタイムスタンプの自動付与および改ざん検知を行う場合は［採用する］を選択します。なお、タイムスタンプの付与を行うには『タイムスタンプ』のライセンスも必要です。『ワークフロー』を使用している場合は、併せて、自動仕訳を作成する申請書に対して、［設定］＞［導入］＞［ワークフロー］＞［申請書登録］＞［基本情報設定］タブの［タイムスタンプ採用設定］でも［採用する］を選択します。 補助採用区分設定採用電子帳簿として元帳を保存・出力または検索対象にする補助を8つまで採用します。採用後は、各勘定科目に対して補助の採用方法を［補助採用情報］タブで設定します。［得意先］［仕入先］の両方で電子帳簿を採用する場合は、［取引先］のみを選択します。 帳簿採用情報仕訳帳総勘定元帳補助元帳電子帳簿として保存・出力する帳票に対して、［採用する］を選択します。 その他情報決算書電子帳簿として決算書を保存・出力できるようにする場合は、［採用する］を選択します。消費税精算表電子帳簿として消費税精算表を保存・出力できるようにする場合は、［採用する］を選択します。『財務基本情報登録』の［処理区分：基本情報］の［消費税区分］が［免税］の場合は選択できません。 履歴情報履歴猶予日数履歴を残し始めるまでの猶予日数を「0」～「7」の範囲で入力します。「7」にすると、たとえば「2025年4月1日　23：59：59」に入力した仕訳は、「2025年4月7日　23：59：59」までに修正すれば履歴管理の対象外となります。ここで登録した猶予日数は、『財務基本情報登録』の［処理区分：基本情報］の［仕訳修正履歴］にも反映されます。なお、『電子帳簿基本情報登録』で猶予日数を登録すると、電子帳簿の採用中は、『財務基本情報登録』からは猶予日数を変更できなくなります。</div></div><div id="MAS16008"><div class="search_breadcrumbs">電子帳簿 &gt; ●　電子帳簿の導入設定 &gt; 電子帳簿の導入設定を行う &gt; 補助情報を登録する</div><div class="search_title">補助情報を登録する</div><div class="displayText">補助情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［補助採用情報］タブ科目に対してどの補助を電子帳簿で使用するか、設定します。  管理する科目・補助に対し ...</div><div class="search_word">補助情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［補助採用情報］タブ科目に対してどの補助を電子帳簿で使用するか、設定します。  管理する科目・補助に対してのみ設定を行い、管理が不要な科目・補助に対しては［なし］を選択します。 空欄その科目でその補助を採用していません。なしその科目でその補助を採用していますが、電子帳簿や検索の対象とはしません。検索対象元帳出力時などの相手科目の検索用として使用できるようにします。この補助の電子帳簿を保存・出力することはできません。電子帳簿対象電子帳簿の対象とし、補助元帳として保存・出力できるようにします。1つの勘定科目につき、2種類以上の補助を電子帳簿対象にすることはできません。</div></div><div id="MAS16010"><div class="search_breadcrumbs">電子帳簿 &gt; ●　証憑の確認 &gt; 証憑情報を確認する</div><div class="search_title">証憑情報を確認する</div><div class="displayText">証憑情報を確認する　［財務大将］＞［文書］＞［e文書］＞［証憑確認］伝票や申請書に添付されたレシートや領収書などの証憑情報を確認します。また、申請・承認時にタイムスタンプが付与され ...</div><div class="search_word">証憑情報を確認する　［財務大将］＞［文書］＞［e文書］＞［証憑確認］伝票や申請書に添付されたレシートや領収書などの証憑情報を確認します。また、申請・承認時にタイムスタンプが付与されなかった証憑については、ここでタイムスタンプを付与できます。タイムスタンプが付与された証憑については、改ざんの有無を確認できます。タイムスタンプの付与・改ざんの確認を行うには、あらかじめ『電子帳簿基本登録』の［基本情報］タブで、［タイムスタンプ採用区分］を［採用する］に設定する必要があります。なお、『証憑確認』を使用するには『スキャナ保存対応』のライセンスが必要です。タイムスタンプの付与には『タイムスタンプ』のライセンスが必要です。 なお、タイムスタンプが付与される条件とタイミングは次のとおりです。証憑の種類タイムスタンプの付与条件付与タイミング伝票入力時に添付された証憑［電子帳簿基本登録］＞［基本情報］タブで［タイムスタンプ採用区分］が［採用する］になっていること添付ファイルの形式がPDF・JPG・JPEGであること更新時申請時（『ワークフロー』を使用している場合）申請書に添付された証憑［設定］＞［導入］＞［ワークフロー］＞［申請書登録］＞［基本情報設定］タブで［タイムスタンプ採用設定］が［採用する］になっていること添付ファイルの形式がPDF・JPG・JPEGであること最終承認時  取引日付［証憑登録］画面で入力した［取引日付］を指定します。取引先［証憑登録］画面で入力した［取引先］を指定します。登録番号［証憑登録］画面で入力した［登録番号］を指定します。取引金額［証憑登録］画面で入力した［取引金額］を指定します。メモ［証憑登録］画面で入力した［メモ］を指定します。タイムスタンプタイムスタンプの付与状況を指定します。改ざんの有無改ざんの有無を指定します。削除済み証憑削除された証憑を表示対象に含めるかどうかを指定します。 表示条件を指定して、［条件で出力］をクリックすると、証憑データが表示されます。［操作］の［…］の［伝票表示］［申請書表示］をクリックすると、証憑が添付された伝票・申請書を確認できます。［操作］の［…］の［証憑表示］または［ファイル名］をクリックすると、証憑情報を確認できます。</div></div><div id="MAS16011"><div class="search_breadcrumbs">電子帳簿 &gt; ●　証憑の確認 &gt; 証憑情報を確認する &gt; タイムスタンプを付与する</div><div class="search_title">タイムスタンプを付与する</div><div class="displayText">タイムスタンプを付与する申請・承認時にタイムスタンプが付与されなかった証憑に対して、タイムスタンプを付与します。ただし、申請書の証憑の場合は、最終承認されたデータでないと付与できま ...</div><div class="search_word">タイムスタンプを付与する申請・承認時にタイムスタンプが付与されなかった証憑に対して、タイムスタンプを付与します。ただし、申請書の証憑の場合は、最終承認されたデータでないと付与できません。 任意の証憑データにタイムスタンプを付与する場合は、証憑データに✔をつけ、右上の［スタンプ付与］をクリックします。表示した証憑すべてにタイムスタンプを付与する場合は、［一括スタンプ付与］をクリックします。 をクリックしてタイムスタンプの結果の通知を確認します。 タイムスタンプが付与されると、［スタンプ付与実施日］［タイムスタンプ有効期限］が次のように表示されます。［スタンプ付与実施日］：本日の日付［タイムスタンプ有効期限］：タイムスタンプの有効期限（10年後） タイムスタンプが付与できなかった場合は、［タイムスタンプ有効期限］が「×」で表示されます。出力条件を［タイムスタンプなし］に設定し、「×」となっているデータを確認します。 タイムスタンプを再度付与する場合は、証憑のファイル形式がPDF・JPG・JPEGであること、ファイルにパスワードがかかっていないことを確認のうえ、タイムスタンプの付与を実行します。</div></div><div id="MAS16012"><div class="search_breadcrumbs">電子帳簿 &gt; ●　証憑の確認 &gt; 証憑情報を確認する &gt; 改ざん検知を行う</div><div class="search_title">改ざん検知を行う</div><div class="displayText">改ざん検知を行うタイムスタンプを付与した証憑に対して改ざんされたかの確認（改ざん検知）を行います。任意の証憑データに改ざん検知を行う場合は、証憑データに✔をつけ、右上の［改ざん検知 ...</div><div class="search_word">改ざん検知を行うタイムスタンプを付与した証憑に対して改ざんされたかの確認（改ざん検知）を行います。任意の証憑データに改ざん検知を行う場合は、証憑データに✔をつけ、右上の［改ざん検知］をクリックします。表示した証憑すべてに改ざん検知を行う場合は、［一括改ざん検知］をクリックします。  をクリックして改ざん検知の結果を確認します。通知される改ざん検知の内容は次のとおりです。通知内容説明改ざん検知処理は正常に終了しました。選択した証憑すべてに改ざんがなかった場合に表示されます。証憑に改ざんが検知されました、詳細を確認してください。選択した証憑のいずれかに改ざんがあった場合に表示されます。改ざんされた証憑を確認する場合は、『証憑確認』で［改ざんの有無］を［改ざんが検知された証憑のみ］を選択します。改ざん検知処理を行えない証憑がありました、詳細を確認してください。検知できない証憑があった場合に表示されます。『証憑確認』でタイムスタンプが付与されているかを確認してください。付与されている場合は、再度改ざん検知を行ってください。 改ざん検知が行われると、［改ざん検知/実施日］と［改ざん検知/結果］が次のように表示されます。［改ざん検知/実施日］：本日の日付［改ざん検知/結果］：改ざんされていない証憑データの場合は「改ざん検知なし」、改ざんされていた証憑データは「有」</div></div></div>');
// ========================================
// グローバル変数定義
// ========================================

// MutationObserver機能用のグローバル変数
var currentSearchValue = ""; // 現在の検索キーワード
var mutationObserver = null; // MutationObserverインスタンス
var debounceTimer = null; // DOM変更用のデバウンスタイマー

// jQueryセレクタキャッシュ
var $cachedElements = {
    iframe: null,
    searchField: null,
    searchResultItemsBlock: null,
    searchResultsEnd: null,
    searchMsg: null,
    searchInput: null
};

// セレクタマップ（キャッシュ機構の効率化）
var selectorMap = {
    iframe: "iframe.topic",
    searchField: ".wSearchField",
    searchResultItemsBlock: ".wSearchResultItemsBlock",
    searchResultsEnd: ".wSearchResultsEnd",
    searchMsg: "#searchMsg",
    searchInput: ".search-input"
};

// HTMLエンティティ復元用の正規表現（効率化のためグローバル定義）
var htmlEntityRegexes = {
    nbsp: /&nbsp;(?=[^<>]*<)/gm,
    gt: /&gt;(?=[^<>]*<)/gm,
    lt: /&lt;(?=[^<>]*<)/gm,
    quot: /&quot;(?=[^<>]*<)/gm,
    amp: /&amp;(?=[^<>]*<)/gm
};

// 文字変換マップ（効率化のため初期化時に正規表現を構築）
var characterMappings = (function () {
    // 文字変換用の配列定義（配列リテラルに変更）
    var wide = ["０", "１", "２", "３", "４", "５", "６", "７", "８", "９", "ａ", "ｂ", "ｃ", "ｄ", "ｅ", "ｆ", "ｇ", "ｈ", "ｉ", "ｊ", "ｋ", "ｌ", "ｍ", "ｎ", "ｏ", "ｐ", "ｑ", "ｒ", "ｓ", "ｔ", "ｕ", "ｖ", "ｗ", "ｘ", "ｙ", "ｚ", "ガ", "ギ", "グ", "ゲ", "ゴ", "ザ", "ジ", "ズ", "ゼ", "ゾ", "ダ", "ヂ", "ヅ", "デ", "ド", "バ", "ビ", "ブ", "ベ", "ボ", "パ", "ピ", "プ", "ペ", "ポ", "。", "「", "」", "、", "ヲ", "ァ", "ィ", "ゥ", "ェ", "ォ", "ャ", "ュ", "ョ", "ッ", "ー", "ア", "イ", "ウ", "エ", "オ", "カ", "キ", "ク", "ケ", "コ", "サ", "シ", "ス", "セ", "ソ", "タ", "チ", "ツ", "テ", "ト", "ナ", "ニ", "ヌ", "ネ", "ノ", "ハ", "ヒ", "フ", "ヘ", "ホ", "マ", "ミ", "ム", "メ", "モ", "ヤ", "ユ", "ヨ", "ラ", "リ", "ル", "レ", "ロ", "ワ", "ン"];
    var narrow = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "ｶﾞ", "ｷﾞ", "ｸﾞ", "ｹﾞ", "ｺﾞ", "ｻﾞ", "ｼﾞ", "ｽﾞ", "ｾﾞ", "ｿﾞ", "ﾀﾞ", "ﾁﾞ", "ﾂﾞ", "ﾃﾞ", "ﾄﾞ", "ﾊﾞ", "ﾋﾞ", "ﾌﾞ", "ﾍﾞ", "ﾎﾞ", "ﾊﾟ", "ﾋﾟ", "ﾌﾟ", "ﾍﾟ", "ﾎﾟ", "｡", "｢", "｣", "､", "ｦ", "ｧ", "ｨ", "ｩ", "ｪ", "ｫ", "ｬ", "ｭ", "ｮ", "ｯ", "ｰ", "ｱ", "ｲ", "ｳ", "ｴ", "ｵ", "ｶ", "ｷ", "ｸ", "ｹ", "ｺ", "ｻ", "ｼ", "ｽ", "ｾ", "ｿ", "ﾀ", "ﾁ", "ﾂ", "ﾃ", "ﾄ", "ﾅ", "ﾆ", "ﾇ", "ﾈ", "ﾉ", "ﾊ", "ﾋ", "ﾌ", "ﾍ", "ﾎ", "ﾏ", "ﾐ", "ﾑ", "ﾒ", "ﾓ", "ﾔ", "ﾕ", "ﾖ", "ﾗ", "ﾘ", "ﾙ", "ﾚ", "ﾛ", "ﾜ", "ﾝ"];
    var highlight = ["(?:０|0)", "(?:１|1)", "(?:２|2)", "(?:３|3)", "(?:４|4)", "(?:５|5)", "(?:６|6)", "(?:７|7)", "(?:８|8)", "(?:９|9)", "(?:ａ|a)", "(?:ｂ|b)", "(?:ｃ|c)", "(?:ｄ|d)", "(?:ｅ|e)", "(?:ｆ|f)", "(?:ｇ|g)", "(?:ｈ|h)", "(?:ｉ|i)", "(?:ｊ|j)", "(?:ｋ|k)", "(?:ｌ|l)", "(?:ｍ|m)", "(?:ｎ|n)", "(?:ｏ|o)", "(?:ｐ|p)", "(?:ｑ|q)", "(?:ｒ|r)", "(?:ｓ|s)", "(?:ｔ|t)", "(?:ｕ|u)", "(?:ｖ|v)", "(?:ｗ|w)", "(?:ｘ|x)", "(?:ｙ|y)", "(?:ｚ|z)", "(?:ガ|ｶﾞ)", "(?:ギ|ｷﾞ)", "(?:グ|ｸﾞ)", "(?:ゲ|ｹﾞ)", "(?:ゴ|ｺﾞ)", "(?:ザ|ｻﾞ)", "(?:ジ|ｼﾞ)", "(?:ズ|ｽﾞ)", "(?:ゼ|ｾﾞ)", "(?:ゾ|ｿﾞ)", "(?:ダ|ﾀﾞ)", "(?:ヂ|ﾁﾞ)", "(?:ヅ|ﾂﾞ)", "(?:デ|ﾃﾞ)", "(?:ド|ﾄﾞ)", "(?:バ|ﾊﾞ)", "(?:ビ|ﾋﾞ)", "(?:ブ|ﾌﾞ)", "(?:ベ|ﾍﾞ)", "(?:ボ|ﾎﾞ)", "(?:パ|ﾊﾟ)", "(?:ピ|ﾋﾟ)", "(?:プ|ﾌﾟ)", "(?:ペ|ﾍﾟ)", "(?:ポ|ﾎﾟ)", "(?:。|｡)", "(?:「|｢)", "(?:」|｣)", "(?:、|､)", "(?:ヲ|ｦ)", "(?:ァ|ｧ)", "(?:ィ|ｨ)", "(?:ゥ|ｩ)", "(?:ェ|ｪ)", "(?:ォ|ｫ)", "(?:ャ|ｬ)", "(?:ュ|ｭ)", "(?:ョ|ｮ)", "(?:ッ|ｯ)", "(?:ー|ｰ)", "(?:ア|ｱ)", "(?:イ|ｲ)", "(?:ウ|ｳ)", "(?:エ|ｴ)", "(?:オ|ｵ)", "(?:カ|ｶ)", "(?:キ|ｷ)", "(?:ク|ｸ)", "(?:ケ|ｹ)", "(?:コ|ｺ)", "(?:サ|ｻ)", "(?:シ|ｼ)", "(?:ス|ｽ)", "(?:セ|ｾ)", "(?:ソ|ｿ)", "(?:タ|ﾀ)", "(?:チ|ﾁ)", "(?:ツ|ﾂ)", "(?:テ|ﾃ)", "(?:ト|ﾄ)", "(?:ナ|ﾅ)", "(?:ニ|ﾆ)", "(?:ヌ|ﾇ)", "(?:ネ|ﾈ)", "(?:ノ|ﾉ)", "(?:ハ|ﾊ)", "(?:ヒ|ﾋ)", "(?:フ|ﾌ)", "(?:ヘ|ﾍ)", "(?:ホ|ﾎ)", "(?:マ|ﾏ)", "(?:ミ|ﾐ)", "(?:ム|ﾑ)", "(?:メ|ﾒ)", "(?:モ|ﾓ)", "(?:ヤ|ﾔ)", "(?:ユ|ﾕ)", "(?:ヨ|ﾖ)", "(?:ラ|ﾗ)", "(?:リ|ﾘ)", "(?:ル|ﾙ)", "(?:レ|ﾚ)", "(?:ロ|ﾛ)", "(?:ワ|ﾜ)", "(?:ン|ﾝ)"];

    // 全角→半角の変換マップを作成
    var wideToNarrowMap = {};
    var narrowToHighlightMap = {};

    for (var i = 0; i < wide.length; i++) {
        wideToNarrowMap[wide[i]] = narrow[i];
        // 半角文字をキーにしてハイライトパターンをマップ
        narrowToHighlightMap[narrow[i]] = highlight[i];
    }

    // 全角文字の正規表現パターンを作成（エスケープ処理を含む）
    var wideCharsPattern = wide.map(function (char) {
        return char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }).join('|');

    var wideToNarrowRegex = new RegExp(wideCharsPattern, 'g');

    return {
        wideToNarrowMap: wideToNarrowMap,
        narrowToHighlightMap: narrowToHighlightMap,
        wideToNarrowRegex: wideToNarrowRegex,
        // 効率的な変換関数
        convertWideToNarrow: function (text) {
            return text.replace(wideToNarrowRegex, function (match) {
                return wideToNarrowMap[match] || match;
            });
        }
    };
})();

// ========================================
// 基本ユーティリティ関数（依存なし）
// ========================================

// セレクタ用のエスケープ処理
function selectorEscape(val) {
    return val.replace(/[-\/\\^$*+?.()|[\]{}\!]/g, '\\$&');
}

// 文字列を正規化（全角→半角カナ変換、小文字化）
function normalizeForSearch(text) {
    var normalized = text.toLowerCase();
    return characterMappings.convertWideToNarrow(normalized);
}

// HTMLエンティティを復元
function decodeHtmlEntities(html) {
    return html
        .replace(htmlEntityRegexes.nbsp, "　")
        .replace(htmlEntityRegexes.gt, ">")
        .replace(htmlEntityRegexes.lt, "<")
        .replace(htmlEntityRegexes.quot, '"')
        .replace(htmlEntityRegexes.amp, "&");
}

// ========================================
// キャッシュ管理関数
// ========================================

// キャッシュを初期化
function initializeCachedElements() {
    for (var key in selectorMap) {
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
}

// キャッシュされた要素を取得（存在チェック付き）
function getCachedElement(key) {
    if (!$cachedElements[key] || $cachedElements[key].length === 0) {
        // キャッシュが無効な場合は再取得
        if (selectorMap.hasOwnProperty(key)) {
            if (key === 'searchInput') {
                $cachedElements[key] = $(selectorMap[key], document);
            } else {
                $cachedElements[key] = $(selectorMap[key]);
            }
        }
    }
    return $cachedElements[key];
}

// ========================================
// 検索処理関連関数（依存関係順）
// ========================================

// 検索語を正規化してエスケープ
function prepareSearchWords(searchValue) {
    // 全角・半角スペースを統一して連続スペースを1つにまとめる
    var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim().toLowerCase();
    searchWordTmp = characterMappings.convertWideToNarrow(searchWordTmp);

    var searchWord = searchWordTmp.split(" ");
    for (var i = 0; i < searchWord.length; i++) {
        searchWord[i] = selectorEscape(searchWord[i].replace(/>/g, "&gt;").replace(/</g, "&lt;"));
    }
    return searchWord;
}

// ハイライト用の正規表現パターンを生成
function createHighlightPattern(searchWords) {
    // 各検索ワードを全角・半角両対応のパターンに変換
    var patterns = searchWords.map(function(word) {
        // 2文字パターンを優先的にマッチさせる正規表現を作成
        var result = '';
        var pos = 0;
        
        while (pos < word.length) {
            var matched = false;
            
            // 2文字の組み合わせを試行
            if (pos + 1 < word.length) {
                var twoChar = word.substring(pos, pos + 2);
                var pattern = characterMappings.narrowToHighlightMap[twoChar];
                if (pattern) {
                    result += pattern;
                    pos += 2;
                    matched = true;
                }
            }
            
            // 1文字で処理
            if (!matched) {
                var char = word.charAt(pos);
                var pattern = characterMappings.narrowToHighlightMap[char];
                result += pattern || char.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                pos++;
            }
        }
        
        return result;
    });
    return patterns.join("|");
}

// iframeのbody要素を取得
function getIframeBody() {
    var $iframe = getCachedElement('iframe');
    if ($iframe.length === 0) return null;
    return $iframe.contents().find("body");
}

// iframeコンテンツにハイライトを適用
function applyHighlight(searchValue) {
    var $body = getIframeBody();
    if (!$body) return;

    var searchWords = prepareSearchWords(searchValue);
    var highlightPattern = createHighlightPattern(searchWords);
    var reg = new RegExp("(" + highlightPattern + ")(?=[^<>]*<)", "gmi");
    var html = $body.html();
    var decodedHtml = decodeHtmlEntities(html);
    var highlightedHtml = decodedHtml.replace(reg, "<font class='keyword' style='color:rgb(0, 0, 0); background-color:rgb(252, 255, 0);'>$1</font>");

    $body.html(highlightedHtml);
}

// キーワードのハイライトを削除
function removeHighlight() {
    var $body = getIframeBody();
    if (!$body) return;

    $body.find(".keyword").each(function () {
        var $this = $(this);
        $this.replaceWith($this.contents());
    });
}

// 検索結果をクリア
function clearSearchResults() {
    var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
    var $searchResultsEnd = getCachedElement('searchResultsEnd');
    var $searchMsg = getCachedElement('searchMsg');

    $searchResultItemsBlock.html("");
    $searchResultsEnd.addClass("rh-hide");
    $searchResultsEnd.attr("hidden", "");
    $searchMsg.html("2つ以上の語句を入力して検索する場合は、スペース（空白）で区切ります。");
    removeHighlight();
    currentSearchValue = "";
    disconnectMutationObserver();
}

// ========================================
// MutationObserver関連関数
// ========================================

// キーワード要素のみの追加かどうかを判定
function isOnlyKeywordAddition(mutation) {
    if (mutation.addedNodes.length !== 1) {
        return false;
    }
    
    var node = mutation.addedNodes[0];
    if (node.nodeType !== Node.ELEMENT_NODE) {
        return false;
    }
    
    // 追加されたノードがキーワード要素か、キーワード要素を含むか
    return (node.classList && node.classList.contains('keyword')) ||
           (node.querySelector && node.querySelector('.keyword') !== null);
}

// デバウンスされた再ハイライト処理
function debouncedReHighlight() {
    if (debounceTimer) {
        clearTimeout(debounceTimer);
    }

    debounceTimer = setTimeout(function () {
        reHighlightAfterDomChange();
    }, 500);
}

// DOM変更後の再ハイライト処理
function reHighlightAfterDomChange() {
    if (!currentSearchValue || currentSearchValue.trim() === "") {
        return;
    }

    try {
        disconnectMutationObserver();
        removeHighlight();
        applyHighlight(currentSearchValue);

        setTimeout(function () {
            setupMutationObserver();
        }, 100);

        console.debug("DOM変更後に検索語を再ハイライトしました");
    } catch (error) {
        console.warn("DOM変更後の再ハイライトに失敗しました:", error);
        setupMutationObserver();
    }
}

// iframeコンテンツ用のMutationObserverをセットアップ
function setupMutationObserver() {
    disconnectMutationObserver();

    try {
        var $iframe = getCachedElement('iframe');
        if ($iframe.length === 0) return;

        var iframeDocument = $iframe[0].contentDocument || $iframe[0].contentWindow.document;
        if (!iframeDocument || !iframeDocument.body) return;

        mutationObserver = new MutationObserver(function (mutations) {
            if (!currentSearchValue || currentSearchValue.trim() === "") {
                return;
            }

            var shouldReHighlight = mutations.some(function(mutation) {
                if (mutation.type === 'characterData') {
                    return true;
                }
                
                if (mutation.type === 'childList') {
                    // キーワード要素自身の追加は無視
                    if (isOnlyKeywordAddition(mutation)) {
                        return false;
                    }
                    
                    // ノードの追加または削除があれば再ハイライト
                    return mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0;
                }
                
                return false;
            });

            if (shouldReHighlight) {
                debouncedReHighlight();
            }
        });

        mutationObserver.observe(iframeDocument.body, {
            childList: true,
            subtree: true,
            characterData: true,
            attributes: false
        });

        console.debug("iframeコンテンツ用のMutationObserverをセットアップしました");
    } catch (error) {
        console.warn("MutationObserverのセットアップに失敗しました:", error);
    }
}

// MutationObserverを切断
function disconnectMutationObserver() {
    if (mutationObserver) {
        mutationObserver.disconnect();
        mutationObserver = null;
    }

    if (debounceTimer) {
        clearTimeout(debounceTimer);
        debounceTimer = null;
    }
}

// ========================================
// jQueryカスタムセレクタ
// ========================================

// カスタムの:contains()セレクタ（正規化された検索用）
$.expr[':'].containsNormalized = function (elem, index, match) {
    var normalizedElemText = normalizeForSearch($(elem).text());
    var normalizedSearchText = normalizeForSearch(match[3]);
    return normalizedElemText.indexOf(normalizedSearchText) >= 0;
};

// ========================================
// jQueryイベントハンドラー
// ========================================

$(function () {
    // 要素のキャッシュを初期化
    initializeCachedElements();

    $(document).on("click", "ul.toc li.book", function () {
        if ($(this).children("a[href='#'],a[href='javascript:void 0;']").length == 0) {
            $(this).children("a").each(function () {
                location.href = location.href.replace(location.hash, "") + "#t=" + $(this).attr("href");
            });
        }
    });

    getCachedElement('searchField').each(function () {
        $(this).off();
    });

    $(document).on("keyup", ".wSearchField", function () {
        var $searchResultItemsBlock = getCachedElement('searchResultItemsBlock');
        var $searchResultsEnd = getCachedElement('searchResultsEnd');
        var $searchMsg = getCachedElement('searchMsg');
        var searchValue = $(this).val();

        // trim()を追加してスペースのみの入力も空として扱う
        if (searchValue.trim() === "") {
            clearSearchResults();
            return;
        }

        $searchMsg.html("");
        currentSearchValue = searchValue; // 現在の検索値を保存
        
        // スペースを正規化
        var searchWordTmp = searchValue.replace(/[　\s]+/g, " ").trim();
        // 正規化（全角→半角カナ、小文字化）
        searchWordTmp = normalizeForSearch(searchWordTmp);

        // 正規化後も空文字列チェックを追加
        if (searchWordTmp === "") {
            clearSearchResults();
            return;
        }

        var searchWord = searchWordTmp.split(" ");
        var searchQuery = searchWord.map(function(word) {
            return ":containsNormalized(" + word + ")";
        }).join("");

        var findItems = searchWords.find(".search_word" + searchQuery);
        if (findItems.length !== 0) {
            $searchResultsEnd.removeClass("rh-hide");
            $searchResultsEnd.removeAttr("hidden");
            $searchResultItemsBlock.html("");
            findItems.each(function () {
                var displayText = $(this).parent().find(".displayText").text();
                var parentId = $(this).parent().attr("id");
                var searchTitle = $(this).parent().find(".search_title").html();
                
                var resultHtml = "<div class='wSearchResultItem'>" +
                    "<a class='nolink' href='./" + parentId + ".html'>" +
                    "<div class='wSearchResultTitle'>" + searchTitle + "</div>" +
                    "</a>" +
                    "<div class='wSearchContent'>" +
                    "<span class='wSearchContext'>" + displayText + "</span>" +
                    "</div></div>";
                
                $searchResultItemsBlock.append($(resultHtml));
            });
            removeHighlight();
            applyHighlight(currentSearchValue);
        }
        else {
            removeHighlight();
            $searchResultsEnd.addClass("rh-hide");
            $searchResultsEnd.attr("hidden", "");
            $searchResultItemsBlock.html("");
            var displayText = "検索条件に一致するトピックはありません。";
            $searchResultItemsBlock.append($("<div class='wSearchResultItem'><div class='wSearchContent'><span class='wSearchContext'>" + displayText + "</span></div></div>"));
        }
    });

    getCachedElement('iframe').on("load", function () {
        var $searchInput = getCachedElement('searchInput');
        var $searchField = getCachedElement('searchField');

        if ($searchInput.is(":not(.rh-hide)") && ($searchField.val() != "")) {
            var searchValue = $searchField.val();
            currentSearchValue = searchValue; // 現在の検索値を保存
            applyHighlight(searchValue);
        }

        // iframeコンテンツ変更用のMutationObserverをセットアップ
        setupMutationObserver();
    });
});
