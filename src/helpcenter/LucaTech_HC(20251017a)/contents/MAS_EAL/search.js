var searchWords = $('<div class="search"><div id="MAS16001"><div class="search_breadcrumbs">電子帳簿 &gt; はじめに</div></div><div id="MAS16003"><div class="search_breadcrumbs">電子帳簿 &gt; 電子帳簿について &gt; 電子帳簿保存法について</div><div class="search_title">電子帳簿保存法について</div><div class="displayText">電子帳簿保存法について電子帳簿保存法の対象となる帳簿について『Galileopt』『LucaTech GX』の財務会計システムでは、「電子帳簿保存法」に定める「優良な電子帳簿」の要 ...</div><div class="search_word">電子帳簿保存法について電子帳簿保存法の対象となる帳簿について『galileopt』『lucatech gx』の財務会計ｼｽﾃﾑでは､｢電子帳簿保存法｣に定める｢優良な電子帳簿｣の要件を満たした､次の国税関係帳簿書類を保存できます｡帳簿仕訳帳総勘定元帳売掛金元帳・買掛金元帳などの補助元帳 その他書類決算報告書消費税精算表 電子帳簿保存法第4条第1項（電磁的記録による備付及び保存）に関する事項｢訂正又は削除の事実及び内容の確認に関する措置｣（施行規則第2条第6項第2号ﾆ関係）については､｢ﾃﾞｰﾀを直接に訂正し又は削除することができるが､その事実及び内容が自動的に記録されるｼｽﾃﾑを使用する｡｣に該当しています｡また､内部規定がある場合は､入力日から7日以内であれば訂正・削除の事実および内容を残さない設定も可能です｡｢追加入力した事実の確認に関する措置｣（施行規則第5条第5項第1号ｲ関係）については､｢入力ﾃﾞｰﾀに入力年月日の情報を自動的に付加する（付加した情報を訂正し又は削除することができない）ｼｽﾃﾑを使用する｡｣に該当しています｡｢国税関係帳簿間の記録事項の関連性の確認に関する措置｣（施行規則第5条第5項第1号ｲ関係）については､｢一連番号により国税関係帳簿間の関連性を確認することができるようにする｡｣に該当しています｡｢ｼｽﾃﾑ関係書類及び事務手続関係書類の備付に関する措置｣（施行規則第2条第6項第4号関係）のｼｽﾃﾑ操作説明書については｢ｼｽﾃﾑの操作説明書｣（本書）に該当しています｡｢ﾃﾞｨｽﾌﾟﾚｲ及びﾌﾟﾘﾝﾀの備付け並びに出力に関する措置｣（施行規則第2条第2項第2号関係）については､｢電磁的記録の備付け及び保存をする場所に出力のための電子計算機､ﾌﾟﾛｸﾞﾗﾑ､ﾃﾞｨｽﾌﾟﾚｲ及びﾌﾟﾘﾝﾀを備え付けて､電磁的記録をﾃﾞｨｽﾌﾟﾚｲの画面及び書面に､整然とした形式及び明瞭な状態で出力することができるようにする｡｣に対応するｼｽﾃﾑ設計をしています｡｢検索機能の確保に関する措置｣（施行規則第2条第2項第6号関係）については､｢主要な記録項目を検索の条件として設定することができる｡｣の項目に関して次のとおり対応しています｡仕訳帳については､取引年月日・勘定科目・取引金額による条件を設定できます｡総勘定元帳・売掛金元帳・買掛金元帳については､取引年月日・勘定科目・取引金額・相手方勘定科目の検索条件を設定できます｡日付または金額に係る記録項目は､その範囲を指定して条件を設定できます｡2つ以上の任意の記録項目を組み合わせて条件を設定できます｡</div></div><div id="MAS16004"><div class="search_breadcrumbs">電子帳簿 &gt; 電子帳簿について &gt; LucaTech GXにおける電子帳簿への対応について</div><div class="search_title">LucaTech GXにおける電子帳簿への対応について</div><div class="displayText">LucaTech GXにおける電子帳簿への対応について『電子帳簿』では、仕訳帳・総勘定元帳・補助元帳および工事管理表・決算報告書などの帳票を表示・出力できます。また、仕訳およびマス ...</div><div class="search_word">lucatech gxにおける電子帳簿への対応について『電子帳簿』では､仕訳帳・総勘定元帳・補助元帳および工事管理表・決算報告書などの帳票を表示・出力できます｡また､仕訳およびﾏｽﾀｰﾃﾞｰﾀの修正履歴・削除履歴の表示・出力もできます｡『電子帳簿』で表示・出力できる内容は､『lucatech gx』で入力したﾃﾞｰﾀと同一です｡仕訳の各項目は､日付や数値情報として保持されます｡ocr入力を行った場合､画像は参考情報として摘要欄に表示されます｡ 各処理の操作方法は『日常処理』のﾒﾆｭｰと同様です｡ただし､電子帳簿保存法に対応して一部の項目の表示が異なる場合があります｡各処理の説明については､次を参照してください｡ ﾒﾆｭｰ名参照先仕訳帳⇒『別冊 日常処理 仕訳帳』参照決算報告書⇒『別冊 決算報告書』参照消費税精算表⇒『別冊 消費税精算表』参照仕訳削除修正履歴⇒『別冊 仕訳削除修正履歴』参照   ｢優良な電子帳簿｣を保存するための前提条件最初から電子計算機（主にﾊﾟｿｺﾝ）を使用して帳簿書類を作成する必要があります｡この帳簿書類にはすべての取引ﾃﾞｰﾀを保存する必要があります｡『lucatech gx』に期首からすべての仕訳ﾃﾞｰﾀを保存しておく必要があります｡ 導入設定について『電子帳簿』を使用するには､あらかじめ［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］で電子帳簿を採用する必要があります｡電子帳簿の採用については､次を参照してください｡⇒『設定編 導入処理 財務大将編』＞『2.4 電子帳簿の導入設定』参照⇒『1.3電子帳簿の導入設定を行う』参照 電子帳簿の表示・印刷､履歴の確認について電子帳簿として帳票類を確認・出力したり､履歴を確認する場合は､［財務］＞［帳簿］＞［電子帳簿］や［その他書類］から行います｡  帳簿書類の保存について帳簿書類の保存期間は最長10年です｡『lucatech gx』でﾊﾞｯｸｱｯﾌﾟを実行することで､会社ﾃﾞｰﾀの電磁的記録として保存されます｡ 記載案：『lucatech gx』では､ｸﾗｳﾄﾞ上に最高11年間ﾃﾞｰﾀが自動保存されるため､手動でのﾊﾞｯｸｱｯﾌﾟは不要です｡ﾗｲｾﾝｽを購入することで､保存期間を延長することもできます｡</div></div><div id="MAS16006"><div class="search_breadcrumbs">電子帳簿 &gt; 電子帳簿の導入設定 &gt; 電子帳簿の導入設定を行う</div><div class="search_title">電子帳簿の導入設定を行う</div><div class="displayText">電子帳簿の導入設定を行う電子帳簿を使い始めるための設定を行います。   設定は仕訳データ入力前に行います設定は、電子帳簿承認申請書により承認を受けた「電子帳簿の備付けを開始する日」 ...</div><div class="search_word">電子帳簿の導入設定を行う電子帳簿を使い始めるための設定を行います｡   設定は仕訳ﾃﾞｰﾀ入力前に行います設定は､電子帳簿承認申請書により承認を受けた｢電子帳簿の備付けを開始する日｣（課税期間の初日）のﾃﾞｰﾀを入力する前に行います｡電子帳簿の採用および設定は､課税期間の初日のﾃﾞｰﾀを入力する前に行います｡設定前に入力した仕訳ﾃﾞｰﾀ等の履歴は管理されません｡</div></div><div id="MAS16007"><div class="search_breadcrumbs">電子帳簿 &gt; 電子帳簿の導入設定 &gt; 電子帳簿の導入設定を行う &gt; 電子帳簿基本情報を登録する</div><div class="search_title">電子帳簿基本情報を登録する</div><div class="displayText">電子帳簿基本情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［基本情報］タブ電子帳簿で使用する各機能の採用と、履歴を残すまでの猶予日数を登録します。  採用 ...</div><div class="search_word">電子帳簿基本情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［基本情報］ﾀﾌﾞ電子帳簿で使用する各機能の採用と､履歴を残すまでの猶予日数を登録します｡  採用区分電子帳簿採用区分選択中の会社ﾃﾞｰﾀで電子帳簿を使用する場合は［採用する］を選択します｡この設定により､電子帳簿の表示・印刷が可能になります｡ｽｷｬﾅｰ保存採用区分e文書対応のﾗｲｾﾝｽを購入している場合に表示されます｡ｽｷｬﾅ保存制度の要件を満たしているかﾁｪｯｸを行う場合は［採用する］を選択します｡ﾀｲﾑｽﾀﾝﾌﾟ採用区分e文書対応のﾗｲｾﾝｽを購入している場合に表示されます｡財務会計ｼｽﾃﾑにおけるﾀｲﾑｽﾀﾝﾌﾟの自動付与および改ざん検知を行う場合は［採用する］を選択します｡ﾜｰｸﾌﾛｰｼｽﾃﾑを使用している場合は､併せて､自動仕訳を作成する申請書に対して､［設定］＞［導入］＞［ﾜｰｸﾌﾛｰ］＞［申請書登録］＞［基本情報設定］ﾀﾌﾞの［ﾀｲﾑｽﾀﾝﾌﾟ採用設定］でも［採用する］を選択します｡ 補助採用区分設定採用電子帳簿として元帳を表示・印刷保存・出力または検索対象にする補助を8つまで採用します｡採用後は､各勘定科目に対して補助の採用方法を［補助採用情報］ﾀﾌﾞで設定します｡［得意先］［仕入先］の両方で電子帳簿を採用する場合は､［取引先］のみを選択します｡  電子帳簿の採用後に､補助自体の採用をなしにすると､入力済みの補助元帳も表示・印刷できなくなります｡また､補助の採用をやめた履歴も残りません｡ 帳簿採用情報仕訳帳総勘定元帳補助元帳電子帳簿として表示・印刷保存・出力する帳票に対して､［採用する］を選択します｡ その他情報決算書電子帳簿として決算書を保存・出力できるようにする場合は､［採用する］を選択します｡消費税精算表電子帳簿として消費税精算表を保存・出力できるようにする場合は､［採用する］を選択します｡［設定］＞［導入処理］＞［財務基本情報登録］＞［処理区分：消費税情報］＞［基本情報］の［消費税区分］が［免税］の場合は選択できません｡ 履歴情報履歴猶予日数履歴を残し始めるまでの猶予日数を｢0｣～｢7｣の範囲で入力します｡｢7｣にすると､例えば｢2025年4月1日　23：59：59｣に入力した仕訳は､｢2025年4月7日　23：59：59｣までに修正すれば履歴管理の対象外となります｡ここで登録した猶予日数は､『財務基本情報登録』の［処理区分：基本情報］の［仕訳修正履歴］にも反映されます｡なお､『電子帳簿基本情報登録』で猶予日数を登録すると､電子帳簿の採用中は､『財務基本情報登録』からは猶予日数を変更できなくなります｡</div></div><div id="MAS16008"><div class="search_breadcrumbs">電子帳簿 &gt; 電子帳簿の導入設定 &gt; 電子帳簿の導入設定を行う &gt; 補助情報を登録する</div><div class="search_title">補助情報を登録する</div><div class="displayText">補助情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［補助採用情報］タブ科目に対してどの補助を電子帳簿で使用するか、設定します。  管理する科目・補助に対し ...</div><div class="search_word">補助情報を登録する　［設定］＞［導入処理］＞［財務］＞［電子帳簿基本登録］＞［補助採用情報］ﾀﾌﾞ科目に対してどの補助を電子帳簿で使用するか､設定します｡  管理する科目・補助に対してのみ設定を行い､管理が不要な科目・補助に対しては［なし］を選択します｡ 空欄その科目でその補助を採用していません｡なしその科目でその補助を採用していますが､電子帳簿や検索の対象とはしません｡検索対象元帳出力時などの相手科目の検索用として使用できるようにします｡この補助の電子帳簿を出力保存・出力することはできません｡電子帳簿対象電子帳簿の対象とし､補助元帳として出力保存・出力できるようにします｡1つの勘定科目につき､2種類以上の補助を電子帳簿対象にすることはできません｡</div></div><div id="MAS16010"><div class="search_breadcrumbs">電子帳簿 &gt; 証憑の確認 &gt; 証憑情報を確認する</div><div class="search_title">証憑情報を確認する</div><div class="displayText">証憑情報を確認する　［財務］＞［文書］＞［e文書］＞［証憑確認］伝票や申請書に添付されたレシートや領収書などの証憑情報を確認します。また、申請・承認時にタイムスタンプが付与されなか ...</div><div class="search_word">証憑情報を確認する　［財務］＞［文書］＞［e文書］＞［証憑確認］伝票や申請書に添付されたﾚｼｰﾄや領収書などの証憑情報を確認します｡また､申請・承認時にﾀｲﾑｽﾀﾝﾌﾟが付与されなかった証憑については､ここでﾀｲﾑｽﾀﾝﾌﾟを付与できます｡ﾀｲﾑｽﾀﾝﾌﾟが付与された証憑については､改ざんの有無を確認できます｡ﾀｲﾑｽﾀﾝﾌﾟの付与・改ざんの確認を行うには､あらかじめ『電子帳簿基本登録』の［基本情報］ﾀﾌﾞで､［ﾀｲﾑｽﾀﾝﾌﾟ採用区分］を［採用する］に設定する必要があります｡なお､『証憑確認』を使用するには『e文書対応』のﾗｲｾﾝｽが必要です｡ﾀｲﾑｽﾀﾝﾌﾟの付与には『ﾀｲﾑｽﾀﾝﾌﾟ』のﾗｲｾﾝｽが必要です｡ なお､ﾀｲﾑｽﾀﾝﾌﾟが付与される条件とﾀｲﾐﾝｸﾞは次のとおりです｡証憑の種類ﾀｲﾑｽﾀﾝﾌﾟの付与条件付与ﾀｲﾐﾝｸﾞ伝票入力時に添付された証憑［電子帳簿基本登録］＞［基本情報］ﾀﾌﾞで［ﾀｲﾑｽﾀﾝﾌﾟ採用区分］が［採用する］になっていること添付ﾌｧｲﾙの形式がpdf・jpg・jpegであること更新時申請時（ﾜｰｸﾌﾛｰｼｽﾃﾑを使用している場合）申請書に添付された証憑［設定］＞［導入］＞［ﾜｰｸﾌﾛｰ］＞［申請書登録］＞［基本情報設定］ﾀﾌﾞで［ﾀｲﾑｽﾀﾝﾌﾟ採用設定］が［採用する］になっていること添付ﾌｧｲﾙの形式がpdf・jpg・jpegであること最終承認時  取引日付［証憑登録］画面で入力した［取引日付］を指定します｡取引先［証憑登録］画面で入力した［取引先］を指定します｡登録番号［証憑登録］画面で入力した［登録番号］を指定します｡取引金額［証憑登録］画面で入力した［取引金額］を指定します｡ﾒﾓ［証憑登録］画面で入力した［ﾒﾓ］を指定します｡ﾀｲﾑｽﾀﾝﾌﾟﾀｲﾑｽﾀﾝﾌﾟの付与状況を指定します｡改ざんの有無改ざんの有無を指定します｡削除済み証憑削除された証憑を表示対象に含めるかどうかを指定します｡ 表示条件を指定して､［条件で出力］をｸﾘｯｸすると､証憑ﾃﾞｰﾀが表示されます｡［操作］の［…］の［伝票表示］［申請書表示］をｸﾘｯｸすると､証憑が添付された伝票・申請書を確認できます｡［操作］の［…］の［証憑表示］または［ﾌｧｲﾙ名］をｸﾘｯｸすると､証憑情報を確認できます｡</div></div><div id="MAS16011"><div class="search_breadcrumbs">電子帳簿 &gt; 証憑の確認 &gt; 証憑情報を確認する &gt; タイムスタンプを付与する</div><div class="search_title">タイムスタンプを付与する</div><div class="displayText">タイムスタンプを付与する申請・承認時にタイムスタンプが付与されなかった証憑に対して、一括でタイムスタンプを付与します。ただし、申請書の証憑の場合は、最終承認されたデータでないと付与 ...</div><div class="search_word">ﾀｲﾑｽﾀﾝﾌﾟを付与する申請・承認時にﾀｲﾑｽﾀﾝﾌﾟが付与されなかった証憑に対して､一括でﾀｲﾑｽﾀﾝﾌﾟを付与します｡ただし､申請書の証憑の場合は､最終承認されたﾃﾞｰﾀでないと付与できません｡ ﾀｲﾑｽﾀﾝﾌﾟを付与する証憑ﾃﾞｰﾀに✔をつけ､［一括ｽﾀﾝﾌﾟ付与］または［ｽﾀﾝﾌﾟ付与］をｸﾘｯｸします｡ をｸﾘｯｸしてﾀｲﾑｽﾀﾝﾌﾟの結果の通知を確認します｡ ﾀｲﾑｽﾀﾝﾌﾟが付与されると､［ｽﾀﾝﾌﾟ付与実施日］［ﾀｲﾑｽﾀﾝﾌﾟ有効期限］が次のように表示されます｡［ｽﾀﾝﾌﾟ付与実施日］：本日の日付［ﾀｲﾑｽﾀﾝﾌﾟ有効期限］：ﾀｲﾑｽﾀﾝﾌﾟの有効期限（10年後） ﾀｲﾑｽﾀﾝﾌﾟが付与できなかった場合は､［ﾀｲﾑｽﾀﾝﾌﾟ有効期限］が｢×｣で表示されます｡出力条件を［ﾀｲﾑｽﾀﾝﾌﾟなし］に設定し､｢×｣となっているﾃﾞｰﾀを確認します｡ ﾀｲﾑｽﾀﾝﾌﾟを再度付与する場合は､証憑のﾌｧｲﾙ形式がpdf・jpg・jpegであること､ﾌｧｲﾙにﾊﾟｽﾜｰﾄﾞがかかっていないことを確認のうえ､ﾀｲﾑｽﾀﾝﾌﾟの付与を実行します｡</div></div><div id="MAS16012"><div class="search_breadcrumbs">電子帳簿 &gt; 証憑の確認 &gt; 証憑情報を確認する &gt; 改ざん検知を行う</div><div class="search_title">改ざん検知を行う</div><div class="displayText">改ざん検知を行うタイムスタンプを付与した証憑に対して改ざんされたかの確認（改ざん検知）を行います。改ざん検知を行う証憑データに✔をつけ、［一括改ざん検知］または［改ざん検知］をクリ ...</div><div class="search_word">改ざん検知を行うﾀｲﾑｽﾀﾝﾌﾟを付与した証憑に対して改ざんされたかの確認（改ざん検知）を行います｡改ざん検知を行う証憑ﾃﾞｰﾀに✔をつけ､［一括改ざん検知］または［改ざん検知］をｸﾘｯｸします｡ をｸﾘｯｸして改ざん検知の結果を確認します｡通知される改ざん検知の内容は次のとおりです｡通知内容説明改ざん検知処理は正常に終了しました｡選択した証憑すべてに改ざんがなかった場合に表示されます｡証憑に改ざんが検知されました､詳細を確認してください｡選択した証憑のいずれかに改ざんがあった場合に表示されます｡改ざんされた証憑を確認する場合は､『証憑確認』で［改ざんの有無］を［改ざんが検知された証憑のみ］を選択します｡改ざん検知処理を行えない証憑がありました､詳細を確認してください｡検知できない証憑があった場合に表示されます｡『証憑確認』でﾀｲﾑｽﾀﾝﾌﾟが付与されているかを確認してください｡付与されている場合は､再度改ざん検知を行ってください｡ 改ざん検知が行われると､［改ざん検知/実施日］と［改ざん検知/結果］が次のように表示されます｡［改ざん検知/実施日］：本日の日付［改ざん検知/結果］：改ざんされていない証憑ﾃﾞｰﾀの場合は｢改ざん検知なし｣､改ざんされていた証憑ﾃﾞｰﾀは｢有｣</div></div></div>');

var wide = Array("０","１","２","３","４","５","６","７","８","９","Ａ","Ｂ","Ｃ","Ｄ","Ｅ","Ｆ","Ｇ","Ｈ","Ｉ","Ｊ","Ｋ","Ｌ","Ｍ","Ｎ","Ｏ","Ｐ","Ｑ","Ｒ","Ｓ","Ｔ","Ｕ","Ｖ","Ｗ","Ｘ","Ｙ","Ｚ","ａ","ｂ","ｃ","ｄ","ｅ","ｆ","ｇ","ｈ","ｉ","ｊ","ｋ","ｌ","ｍ","ｎ","ｏ","ｐ","ｑ","ｒ","ｓ","ｔ","ｕ","ｖ","ｗ","ｘ","ｙ","ｚ","ガ","ギ","グ","ゲ","ゴ","ザ","ジ","ズ","ゼ","ゾ","ダ","ヂ","ヅ","デ","ド","バ","ビ","ブ","ベ","ボ","パ","ピ","プ","ペ","ポ","。","「","」","、","ヲ","ァ","ィ","ゥ","ェ","ォ","ャ","ュ","ョ","ッ","ー","ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ン");
var narrow = Array("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","ｶﾞ","ｷﾞ","ｸﾞ","ｹﾞ","ｺﾞ","ｻﾞ","ｼﾞ","ｽﾞ","ｾﾞ","ｿﾞ","ﾀﾞ","ﾁﾞ","ﾂﾞ","ﾃﾞ","ﾄﾞ","ﾊﾞ","ﾋﾞ","ﾌﾞ","ﾍﾞ","ﾎﾞ","ﾊﾟ","ﾋﾟ","ﾌﾟ","ﾍﾟ","ﾎﾟ","｡","｢","｣","､","ｦ","ｧ","ｨ","ｩ","ｪ","ｫ","ｬ","ｭ","ｮ","ｯ","ｰ","ｱ","ｲ","ｳ","ｴ","ｵ","ｶ","ｷ","ｸ","ｹ","ｺ","ｻ","ｼ","ｽ","ｾ","ｿ","ﾀ","ﾁ","ﾂ","ﾃ","ﾄ","ﾅ","ﾆ","ﾇ","ﾈ","ﾉ","ﾊ","ﾋ","ﾌ","ﾍ","ﾎ","ﾏ","ﾐ","ﾑ","ﾒ","ﾓ","ﾔ","ﾕ","ﾖ","ﾗ","ﾘ","ﾙ","ﾚ","ﾛ","ﾜ","ﾝ");
var hilight = Array("(?:０|0)","(?:１|1)","(?:２|2)","(?:３|3)","(?:４|4)","(?:５|5)","(?:６|6)","(?:７|7)","(?:８|8)","(?:９|9)","(?:Ａ|A|ａ|a)","(?:Ｂ|B|ｂ|b)","(?:Ｃ|C|ｃ|c)","(?:Ｄ|D|ｄ|d)","(?:Ｅ|E|ｅ|e)","(?:Ｆ|F|ｆ|f)","(?:Ｇ|G|ｇ|g)","(?:Ｈ|H|ｈ|h)","(?:Ｉ|I|ｉ|i)","(?:Ｊ|J|ｊ|j)","(?:Ｋ|K|ｋ|k)","(?:Ｌ|L|ｌ|l)","(?:Ｍ|M|ｍ|m)","(?:Ｎ|N|ｎ|n)","(?:Ｏ|O|ｏ|o)","(?:Ｐ|P|ｐ|p)","(?:Ｑ|Q|ｑ|q)","(?:Ｒ|R|ｒ|r)","(?:Ｓ|S|ｓ|s)","(?:Ｔ|T|ｔ|t)","(?:Ｕ|U|ｕ|u)","(?:Ｖ|V|ｖ|v)","(?:Ｗ|W|ｗ|w)","(?:Ｘ|X|ｘ|x)","(?:Ｙ|Y|ｙ|y)","(?:Ｚ|Z|ｚ|z)","(?:ガ|ｶﾞ)","(?:ギ|ｷﾞ)","(?:グ|ｸﾞ)","(?:ゲ|ｹﾞ)","(?:ゴ|ｺﾞ)","(?:ザ|ｻﾞ)","(?:ジ|ｼﾞ)","(?:ズ|ｽﾞ)","(?:ゼ|ｾﾞ)","(?:ゾ|ｿﾞ)","(?:ダ|ﾀﾞ)","(?:ヂ|ﾁﾞ)","(?:ヅ|ﾂﾞ)","(?:デ|ﾃﾞ)","(?:ド|ﾄﾞ)","(?:バ|ﾊﾞ)","(?:ビ|ﾋﾞ)","(?:ブ|ﾌﾞ)","(?:ベ|ﾍﾞ)","(?:ボ|ﾎﾞ)","(?:パ|ﾊﾟ)","(?:ピ|ﾋﾟ)","(?:プ|ﾌﾟ)","(?:ペ|ﾍﾟ)","(?:ポ|ﾎﾟ)","(?:。|｡)","(?:「|｢)","(?:」|｣)","(?:、|､)","(?:ヲ|ｦ)","(?:ァ|ｧ)","(?:ィ|ｨ)","(?:ゥ|ｩ)","(?:ェ|ｪ)","(?:ォ|ｫ)","(?:ャ|ｬ)","(?:ュ|ｭ)","(?:ョ|ｮ)","(?:ッ|ｯ)","(?:ー|ｰ)","(?:ア|ｱ)","(?:イ|ｲ)","(?:ウ|ｳ)","(?:エ|ｴ)","(?:オ|ｵ)","(?:カ|ｶ)","(?:キ|ｷ)","(?:ク|ｸ)","(?:ケ|ｹ)","(?:コ|ｺ)","(?:サ|ｻ)","(?:シ|ｼ)","(?:ス|ｽ)","(?:セ|ｾ)","(?:ソ|ｿ)","(?:タ|ﾀ)","(?:チ|ﾁ)","(?:ツ|ﾂ)","(?:テ|ﾃ)","(?:ト|ﾄ)","(?:ナ|ﾅ)","(?:ニ|ﾆ)","(?:ヌ|ﾇ)","(?:ネ|ﾈ)","(?:ノ|ﾉ)","(?:ハ|ﾊ)","(?:ヒ|ﾋ)","(?:フ|ﾌ)","(?:ヘ|ﾍ)","(?:ホ|ﾎ)","(?:マ|ﾏ)","(?:ミ|ﾐ)","(?:ム|ﾑ)","(?:メ|ﾒ)","(?:モ|ﾓ)","(?:ヤ|ﾔ)","(?:ユ|ﾕ)","(?:ヨ|ﾖ)","(?:ラ|ﾗ)","(?:リ|ﾘ)","(?:ル|ﾙ)","(?:レ|ﾚ)","(?:ロ|ﾛ)","(?:ワ|ﾜ)","(?:ン|ﾝ)");

// Global variables for MutationObserver feature
var currentSearchValue = ""; // Current search keyword
var mutationObserver = null; // MutationObserver instance
var debounceTimer = null; // Debounce timer for DOM changes

function selectorEscape(val){
  return val.replace(/[-\/\\^$*+?.()|[\]{}\!]/g, '\\$&');
}

// Apply highlight to iframe content
function applyHighlight(searchValue) {
  var searchWordTmp = searchValue.split("　").join(" ").trim();
  searchWordTmp = searchWordTmp.split("  ").join(" ");
  for(var i = 0; i < wide.length; i++) {
    searchWordTmp = searchWordTmp.replace(wide[i], narrow[i]);
  }
  var searchWord = searchWordTmp.split(" ");
  for(var i = 0; i < searchWord.length; i++) {
    searchWord[i] = selectorEscape(searchWord[i].replace(">", "&gt;").replace("<", "&lt;"));
  }
  var hilightWord = searchWord.join("|");
  for(var i = 0; i < hilight.length; i++) {
    var reg = new RegExp(hilight[i], "gm");
    hilightWord = hilightWord.replace(reg, hilight[i]);
  }

  var reg = new RegExp("("+hilightWord+")(?=[^<>]*<)", "gm");
  var regnbsp = new RegExp("&nbsp;(?=[^<>]*<)", "gm");
  var reggt = new RegExp("&gt;(?=[^<>]*<)", "gm");
  var reglt = new RegExp("&lt;(?=[^<>]*<)", "gm");
  var regquot = new RegExp("&quot;(?=[^<>]*<)", "gm");
  var regamp = new RegExp("&amp;(?=[^<>]*<)", "gm");
  $("iframe.topic").contents().find("body").html($("iframe.topic").contents().find("body").html().replace(regnbsp, "　").replace(reggt, ">").replace(reglt, "<").replace(regquot, '"').replace(regamp, "&").replace(reg, "<font class='keyword' style='color:rgb(0, 0, 0); background-color:rgb(252, 255, 0);'>$1</font>"));
}

// Remove keyword highlights
function removeHighlight() {
  $("iframe.topic").contents().find(".keyword").each(function() {
    for(var i = 0; i < $(this)[0].childNodes.length; i++) {
      this.parentNode.insertBefore($(this)[0].childNodes[i], this);
    }
    $(this).remove();
  });
}

// Setup MutationObserver for iframe content
function setupMutationObserver() {
  disconnectMutationObserver();
  
  try {
    var $iframe = $("iframe.topic");
    if ($iframe.length === 0) return;
    
    var iframeDocument = $iframe[0].contentDocument || $iframe[0].contentWindow.document;
    if (!iframeDocument || !iframeDocument.body) return;
    
    mutationObserver = new MutationObserver(function(mutations) {
      if (!currentSearchValue || currentSearchValue.trim() === "") {
        return;
      }
      
      var shouldReHighlight = false;
      for (var i = 0; i < mutations.length; i++) {
        var mutation = mutations[i];
        if (mutation.type === 'childList') {
          var addedKeywords = false;
          for (var j = 0; j < mutation.addedNodes.length; j++) {
            var node = mutation.addedNodes[j];
            if (node.nodeType === Node.ELEMENT_NODE) {
              if (node.classList && node.classList.contains('keyword')) {
                addedKeywords = true;
                break;
              }
              if (node.querySelector && node.querySelector('.keyword')) {
                addedKeywords = true;
                break;
              }
            }
          }
          
          if (addedKeywords && mutation.addedNodes.length === 1) {
            continue;
          }
          
          if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
            shouldReHighlight = true;
            break;
          }
        } else if (mutation.type === 'characterData') {
          shouldReHighlight = true;
          break;
        }
      }
      
      if (shouldReHighlight) {
        debouncedReHighlight();
      }
    });
    
    mutationObserver.observe(iframeDocument.body, {
      childList: true,
      subtree: true,
      characterData: true,
      attributes: false
    });
    
    console.debug("MutationObserver setup for iframe content");
  } catch (error) {
    console.warn("Failed to setup MutationObserver:", error);
  }
}

// Debounced re-highlighting
function debouncedReHighlight() {
  if (debounceTimer) {
    clearTimeout(debounceTimer);
  }
  
  debounceTimer = setTimeout(function() {
    reHighlightAfterDomChange();
  }, 500);
}

// Re-highlight after DOM change
function reHighlightAfterDomChange() {
  if (!currentSearchValue || currentSearchValue.trim() === "") {
    return;
  }
  
  try {
    disconnectMutationObserver();
    removeHighlight();
    applyHighlight(currentSearchValue);
    
    setTimeout(function() {
      setupMutationObserver();
    }, 100);
    
    console.debug("Re-highlighted search terms after DOM change");
  } catch (error) {
    console.warn("Failed to re-highlight after DOM change:", error);
    setupMutationObserver();
  }
}

// Disconnect MutationObserver
function disconnectMutationObserver() {
  if (mutationObserver) {
    mutationObserver.disconnect();
    mutationObserver = null;
  }
  
  if (debounceTimer) {
    clearTimeout(debounceTimer);
    debounceTimer = null;
  }
}

$(function(){
  $(document).on("click", "ul.toc li.book", function() {
    if($(this).children("a[href='#'],a[href='javascript:void 0;']").length == 0)
    {
      $(this).children("a").each(function(){
        location.href=location.href.replace(location.hash,"")+"#t="+$(this).attr("href");
      });
    }
  });
  $(".wSearchField").each(function() {
    $(this).off();
  });
  $(document).on("keyup", ".wSearchField", function(){
    if($(this).val() == "")
    {
      $(".wSearchResultItemsBlock").html("");
      $(".wSearchResultsEnd").addClass("rh-hide");
      $(".wSearchResultsEnd").attr("hidden", "");
      $("#searchMsg").html("2つ以上の語句を入力して検索する場合は、スペース（空白）で区切ります。");
      removeHighlight();
      currentSearchValue = ""; // Clear current search value
      disconnectMutationObserver(); // Disconnect observer when clearing
    }
    else
    {
      $("#searchMsg").html("");
      currentSearchValue = $(this).val(); // Store current search value
      var searchWordTmp = $(this).val().replace(/(.*?)(?:　| )+(.*?)/g, "$1 $2").trim().toLowerCase();
      for(i = 0; i < wide.length; i ++)
      {
        searchWordTmp = searchWordTmp.split(wide[i]).join(narrow[i]);
      }
      var searchWord = searchWordTmp.split(" ");
      var searchQuery = "";
      for(i = 0; i < searchWord.length; i ++)
      {
        searchQuery += ":contains(" + searchWord[i] + ")";
      }
      
      var findItems = searchWords.find(".search_word"+searchQuery);
      if(findItems.length != 0)
      {
        $(".wSearchResultsEnd").removeClass("rh-hide");
        $(".wSearchResultsEnd").removeAttr("hidden");
        $(".wSearchResultItemsBlock").html("");
        findItems.each(function() {
          var displayText = $(this).parent().find(".displayText").text();
          $(".wSearchResultItemsBlock").append($("<div class='wSearchResultItem'><a class='nolink' href='./"+$(this).parent().attr("id")+".html'><div class='wSearchResultTitle'>"+$(this).parent().find(".search_title").html()+"</div></a><div class='wSearchContent'><span class='wSearchContext'>"+displayText+"</span></div></div>"));
        });
        removeHighlight();
        applyHighlight(currentSearchValue);
      }
      else
      {
        removeHighlight();
        $(".wSearchResultsEnd").addClass("rh-hide");
        $(".wSearchResultsEnd").attr("hidden", "");
        $(".wSearchResultItemsBlock").html("");
        displayText = "検索条件に一致するトピックはありません。";
        $(".wSearchResultItemsBlock").append($("<div class='wSearchResultItem'><div class='wSearchContent'><span class='wSearchContext'>"+displayText+"</span></div></div>"));
      }
    }
  });
  $("iframe.topic").on("load", function(){
    if($(".search-input", document).is(":not(.rh-hide)") && ($(".wSearchField", document).val() != ""))
    {
      var searchValue = $(".wSearchField", document).val();
      currentSearchValue = searchValue; // Store current search value
      applyHighlight(searchValue);
    }
    
    // Setup MutationObserver for iframe content changes
    setupMutationObserver();
  });
});
