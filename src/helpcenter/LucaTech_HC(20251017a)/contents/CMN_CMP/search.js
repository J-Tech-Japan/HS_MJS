var searchWords = $('<div class="search"><div id="CMN13001"><div class="search_breadcrumbs">会社データ管理 &gt; はじめに</div></div><div id="CMN13003"><div class="search_breadcrumbs">会社データ管理 &gt; 決算処理 &gt; 決算を確定する</div><div class="search_title">決算を確定する</div><div class="displayText">決算を確定する　［データ関係処理］＞［会社データ管理］＞［更新処理］＞［決算確定］当期のすべての月次処理が確定したら、『決算確定』を行って会社データを締めます。決算確定をすると、仕 ...</div><div class="search_word">決算を確定する　［ﾃﾞｰﾀ関係処理］＞［会社ﾃﾞｰﾀ管理］＞［更新処理］＞［決算確定］当期のすべての月次処理が確定したら､『決算確定』を行って会社ﾃﾞｰﾀを締めます｡決算確定をすると､仕訳の入力や登録内容の変更ができません｡確定後に会社ﾃﾞｰﾀを修正する場合は､決算確定の解除を行います｡解除方法については､次を参照してください｡⇒『決算確定を解除する』参照①　［決算確定／解除］で［決算確定］を選択し､必要に応じて決算確定時の状況などを［変更理由］に入力します｡［開始］をｸﾘｯｸします｡②　次のﾒｯｾｰｼﾞで［開始］をｸﾘｯｸします｡利用している業務ｼｽﾃﾑに未確定の処理がある場合､ﾁｪｯｸ結果に［失敗］または［警告］と表示されます｡ﾁｪｯｸ結果が［失敗］の場合は､［確認］をｸﾘｯｸして処理を開き､必要な対応を行います｡具体的な処理方法については､次を参照してください｡⇒『月次確定を行う』参照ﾁｪｯｸ結果が［警告］の場合は､状況を確認して内容に問題がなければ［警告を無視して決算を確定する］に✔をつけて［決算確定］をｸﾘｯｸします｡処理が完了したら手順①に戻ります｡利用している業務ｼｽﾃﾑに未確定の処理がない場合は､決算確定が完了するとﾒｯｾｰｼﾞが表示されます｡また､［決算確定履歴］に､処理日時などが表示されます｡</div></div><div id="CMN13004"><div class="search_breadcrumbs">会社データ管理 &gt; 決算処理 &gt; 決算を確定する &gt; 決算確定を解除する</div><div class="search_title">決算確定を解除する</div><div class="displayText">決算確定を解除する決算確定後の会社データに対して、仕訳の入力や登録内容の変更が必要な場合は、決算確定を解除します。①　［決算確定／解除］で［決算解除］を選択し、［変更理由］に理由を ...</div><div class="search_word">決算確定を解除する決算確定後の会社ﾃﾞｰﾀに対して､仕訳の入力や登録内容の変更が必要な場合は､決算確定を解除します｡①　［決算確定／解除］で［決算解除］を選択し､［変更理由］に理由を入力して､［開始］をｸﾘｯｸします｡②　次のﾒｯｾｰｼﾞで［開始］をｸﾘｯｸします｡［決算確定履歴］に解除の履歴が表示されます｡ 決算確定を解除した会社ﾃﾞｰﾀの修正が終わったら､改めて『決算確定』を行います｡</div></div><div id="CMN13005"><div class="search_breadcrumbs">会社データ管理 &gt; 決算処理 &gt; 決算を更新する</div><div class="search_title">決算を更新する</div><div class="displayText">決算を更新する　［データ関係処理］＞［会社データ管理］＞［更新処理］＞［決算更新］『決算更新』をすると、『LucaTech GX』に同じ会社名の次期会社データが作成されます。当期会 ...</div><div class="search_word">決算を更新する　［ﾃﾞｰﾀ関係処理］＞［会社ﾃﾞｰﾀ管理］＞［更新処理］＞［決算更新］『決算更新』をすると､『lucatech gx』に同じ会社名の次期会社ﾃﾞｰﾀが作成されます｡当期会社ﾃﾞｰﾀの設定や科目の残高､当期会社ﾃﾞｰﾀへ入力されていた翌期3か月分の仕訳が､次期会社ﾃﾞｰﾀへ移送されます｡新しい年度の仕訳入力やﾃﾞｰﾀの取込は､次期会社ﾃﾞｰﾀで行います｡次期会社ﾃﾞｰﾀを作成すると､当期会社ﾃﾞｰﾀの当年実績は次期会社ﾃﾞｰﾀの前年実績に､前年実績は前々年実績に移送されます｡ 基本的には､『決算確定』で当期会社ﾃﾞｰﾀを締めた後に『決算更新』を行い､期首残高が確定した次期会社ﾃﾞｰﾀを作成します｡決算確定前に『決算更新』を行うこともできます｡決算確定前に『決算更新』した場合は､当期会社ﾃﾞｰﾀを『決算確定』した後に､『残高再移送』で当期実績を次期会社ﾃﾞｰﾀの期首残高にｺﾋﾟｰします｡『残高再移送』については､次を参照してください｡⇒『残高を再移送する』参照 決算更新に関する留意事項『決算更新』前後の会社ﾃﾞｰﾀには､いくつか留意事項があります｡ 『決算更新』後は､当期会社ﾃﾞｰﾀの変更内容は､次期会社ﾃﾞｰﾀに反映されません｡逆も同様です｡『決算更新』を行うと､当期会社ﾃﾞｰﾀに入力された翌期3か月分のﾃﾞｰﾀは､自動的に月次確定されます｡『決算更新』後の翌期3か月分の入力は､次期会社ﾃﾞｰﾀで行います｡月次確定された翌期3か月分のﾃﾞｰﾀを修正する場合は､［財務大将］＞［日常処理］＞［会計ﾃﾞｰﾀ確定］＞［ﾃﾞｰﾀ確定］で［未確定］に戻して修正した後､『残高再移送』を行って次期会社ﾃﾞｰﾀに反映します｡『決算確定』している状態で『決算更新』を行うと､次期会社ﾃﾞｰﾀの期首残高は自動的に月次確定されます｡  決算を更新する①　次期会社ﾃﾞｰﾀ作成時の設定を確認し､必要に応じて修正します｡会計期間月次開始日次期会社ﾃﾞｰﾀの会計期間と月次開始日が表示されます｡会社の精算や合併などで会計期間や月次開始日を変更する場合は､画面左下の［次期ﾃﾞｰﾀ会計期間変更］をｸﾘｯｸして変更します｡変更した会計期間で次期会社ﾃﾞｰﾀが作成されます｡会計期間変更時に移送されるﾃﾞｰﾀについては､次を参照してください｡⇒『会計期間の変更時に移送されるﾃﾞｰﾀ』参照適用期間終了情報当期で適用期間が終了したﾏｽﾀｰなどのﾃﾞｰﾀを､次期会社ﾃﾞｰﾀに作成しない場合は､✔をつけます｡②　次期会社ﾃﾞｰﾀへの移送方法を設定します｡予算移送当期会社ﾃﾞｰﾀに予算を設定している場合に表示されます｡『財務大将』の科目（部門､補助）別予算の移送方法に✔をつけます｡［予算なし］予算は移送されません｡［来期予算を移送］当期会社ﾃﾞｰﾀで登録した来期予算が､次期会社ﾃﾞｰﾀの当期予算に移送されます｡［当期予算を移送］当期会社ﾃﾞｰﾀで登録した当期予算が､次期会社ﾃﾞｰﾀの当期予算に移送されます｡伝票no.初期値移送『財務大将』を利用している場合に表示されます｡［設定］＞［導入処理］＞［財務］＞［財務基本情報登録］＞［伝票no.情報］で､月ごとに伝票no.初期値を設定している場合は､伝票no.初期値の移送方法に✔をつけます｡［翌期3か月のみ］当期会社ﾃﾞｰﾀで登録した翌期3か月の伝票no.初期値が､次期会社ﾃﾞｰﾀの開始3か月に移送されます｡［翌期3か月+当期］当期会社ﾃﾞｰﾀで登録した伝票no.初期値が､次期会社ﾃﾞｰﾀに移送されます｡ただし､次期会社ﾃﾞｰﾀの開始3ヶ月については､移送される内容が次のように異なります｡当期会社ﾃﾞｰﾀに翌期3か月の伝票no.初期値が登録されている場合：登録されている伝票no.初期値未登録の場合：当期会社ﾃﾞｰﾀの開始3か月の伝票no.初期値配賦基準値移送『財務大将』を利用している場合に表示されます｡［設定］＞［ﾏｽﾀｰ登録処理］＞［部門関係］＞［部門配賦情報］で､月ごとに配賦基準値を設定している場合は､配賦基準値の移送方法に✔をつけます｡［翌期3か月のみ］当期会社ﾃﾞｰﾀで登録した翌期3か月の配賦基準値が､次期会社ﾃﾞｰﾀの開始3か月に移送されます｡［翌期3か月+当期］当期会社ﾃﾞｰﾀで登録した配賦基準値が､次期会社ﾃﾞｰﾀに移送されます｡ただし､次期会社ﾃﾞｰﾀの開始3か月については､当期会社ﾃﾞｰﾀの翌期3か月に登録されている配賦基準値が移送されます｡［当期基準値を移送］当期会社ﾃﾞｰﾀで登録した配賦基準値が次期会社ﾃﾞｰﾀに移送されます｡任意償却繰越区分『固定資産管理』を利用している場合に表示されます｡［固定資産管理］＞［資産管理］＞［資産登録］＞［物件登録］で設定した［当期任意普通償却額］の内容を引き継ぐ場合に✔をつけます｡当期普通償却限度額､当期特別償却限度額､当期任意特別償却額については引き継がれません｡③　［開始］をｸﾘｯｸします｡④　次のﾒｯｾｰｼﾞで［開始］をｸﾘｯｸします｡会社ﾃﾞｰﾀの保存年数が上限に達した場合は､会社削除確認の画面が表示されます｡会社ﾃﾞｰﾀの保存年度については､次を参照してください｡⇒『会社ﾃﾞｰﾀの保存年度が上限になる場合』参照⑤　『決算確定』を行っていない場合は､次の画面が表示されます｡決算確定しないまま更新する場合は､［警告を無視して決算を更新する］に✔をつけて［決算更新］をｸﾘｯｸします｡⑥　次のﾒｯｾｰｼﾞが表示されるので､決算更新の完了を待ちます｡『lucatech gx』の利用環境や会社ﾃﾞｰﾀの規模によって異なりますが､決算更新にはある程度の時間が必要です｡他の処理を操作したり､『lucatech gx』からﾛｸﾞｱｳﾄしても問題ありません｡⑦　決算更新が完了すると､ﾍｯﾀﾞｰに通知履歴が届きます｡通知履歴をｸﾘｯｸして結果を確認します｡⑧　ﾍｯﾀﾞｰの会社選択をｸﾘｯｸして表示された［会社選択］画面で､会計期間を確認して次期の会社をｸﾘｯｸし､［選択して次へ］をｸﾘｯｸすると､次期会社ﾃﾞｰﾀが表示されます｡   『決算更新』を行い､次期会社ﾃﾞｰﾀを作成した直後に削除した場合ｼｽﾃﾑの都合上､削除してから7～14日経過するまでは次期会社ﾃﾞｰﾀを作成できません｡急ぎで作成する必要がある場合は､mjs担当者にお問い合わせください｡ 決算が未確定の状態で『決算更新』をした場合は､当期会社ﾃﾞｰﾀの決算確定後に『残高再移送』を行って､当期の実績を翌期の期首残高に移送されます｡『残高再移送』の手順は､次を参照してください｡⇒『1.3残高を再移送する』参照 次期会社ﾃﾞｰﾀへ移送されるﾃﾞｰﾀ『決算更新』を実行して､次期会社ﾃﾞｰﾀへ移送される内容は次のとおりです｡ ｼｽﾃﾑ移送内容共通『会社基本情報登録』の設定内容登録されているすべてのﾏｽﾀｰ　 次期会社ﾃﾞｰﾀ作成時の設定項目である［適用期間終了情報］に✔をつけて『決算更新』を実行した場合､当期で適用期間が終了したﾏｽﾀｰは､次期会社ﾃﾞｰﾀに移送されません｡財務大将当期会社ﾃﾞｰﾀの翌期3か月分の仕訳（次期会社ﾃﾞｰﾀの同一月に移送されます）期日が翌期の仕訳（次期会社ﾃﾞｰﾀの0月に移送されます）当期の実績（次期会社ﾃﾞｰﾀの過年度実績および期首残高としてｾｯﾄされます）固定資産管理登録されているすべての固定資産管理関連のﾏｽﾀｰ任意耐用年数を基準に計算された期首簿価（任意耐用年数を入力済みの物件）当期任意普通償却額（［任意償却繰越区分］に✔をつけた場合）［当期任意特別償却額］に特別償却限度額未満の金額が入力されている場合は､不足額が翌期に特別償却繰越不足額として繰り越されます｡償却限度額と任意耐用年数の償却率による償却額との差額､または償却限度額と当期任意普通償却額との差額が､翌期に普通償却繰越超過額として繰り越されます｡自動仕訳の伝票noの設定値（初期値）ﾜｰｸﾌﾛｰ伝票日付が翌期以降の未承認ﾃﾞｰﾀ当期会社ﾃﾞｰﾀの翌期3か月分の申請ﾃﾞｰﾀ 会計期間の変更時に移送されるﾃﾞｰﾀ会計期間を変更するときは､［設定］＞［導入処理］＞［財務］＞［財務基本情報登録］で設定する［中間決算月の集計方法］によって､移送されるﾃﾞｰﾀが異なります｡［下期の集計に含まない］のとき当期会社ﾃﾞｰﾀの第一四半期決算月(21月～23月)､中間決算月(81月～83月)､第三四半期決算月(31月～33月)の実績は､移送されません｡翌期ﾃﾞｰﾀの0月に､21月（第一四半期決算）に入力した仕訳は移送されません｡［下期の集計に含む］のとき次期会社ﾃﾞｰﾀの当年期首残高には､当期会社ﾃﾞｰﾀの第一四半期決算月(21月～23月)､中間決算月(81月～83月)､第三四半期決算月(31月～33月)､決算月(91月～93月)の実績を含めて移送されます｡翌期ﾃﾞｰﾀの0月に､21月（第一四半期決算）に入力した仕訳も移送されます｡次期会社ﾃﾞｰﾀの過年度実績には､第一四半期決算月(21月～23月)､中間決算月(81月～83月)､第三四半期決算月(31月～33月)､決算月(91月～93月)の実績は､各決算月の直前の月に加算し移送されます｡ なお､［中間決算月の集計方法］に関わらず､翌期ﾃﾞｰﾀの決算開始日以降の仕訳､および実績には､決算月ﾃﾞｰﾀ（21月・81月・31月・91月）は移送されません｡通常月のﾃﾞｰﾀは翌期ﾃﾞｰﾀに移送されます｡ たとえば､決算開始年月日を1月1日から4月1日に変更して決算更新を行った場合に移送されるﾃﾞｰﾀは､次のとおりです｡［仕訳・期首残・当期実績の移送］○：移送対象×：移送対象外△：中間決算月の集計方法が［下期の集計に含む］の場合のみ移送対象当期期首残1月2月3月21月4月5月6月81月7月8月9月31月10月11月12月91月翌1月翌2月翌3月翌21月 ○△○○○×○○○×○○○×○○○×翌期期首残／0月4月5月6月21月7月8月9月81月10月11月12月31月1月2月3月91月 ［過年度実績（当期実績→翌期の過年度実績）の移送］○：移送対象●：中間決算月の集計方法が［下期の集計に含む］の場合は､通常月と決算月を加算して翌期の通常月へ移送し､［下期の集計に含まない］の場合は､通常月の値のみを翌期の通常月へ移送当期1月2月3月21月 ○○●翌期1月2月3月  会社ﾃﾞｰﾀの保存年度が上限になる場合『lucatech gx』では､会社ﾃﾞｰﾀを11年度分（当年＋過去10年度分）保存します｡ｵﾌﾟｼｮﾝ契約の状況によっては､12年度分以上の保存が可能です｡決算更新によって会社ﾃﾞｰﾀの保存年度が上限を超えた場合､最も古い年度の会社ﾃﾞｰﾀを削除するか､ﾃﾞｰﾀ保存延長ｵﾌﾟｼｮﾝに加入して保存できる年度を増やすかを選択します｡ 最も古い会社ﾃﾞｰﾀを削除する［上記の注意事項を確認しました］に✔をつけて､［削除］をｸﾘｯｸします｡削除後は､その年度の会社ﾃﾞｰﾀ､および該当期間のﾊﾞｯｸｱｯﾌﾟﾃﾞｰﾀを復旧できません｡ ﾃﾞｰﾀ保存延長ｵﾌﾟｼｮﾝに加入する①　［契約変更］をｸﾘｯｸします｡②　次のﾒｯｾｰｼﾞで［ok］をｸﾘｯｸします｡③　別ｳｨﾝﾄﾞｳに表示された『ﾗｲｾﾝｽ確認』で､［ﾗｲｾﾝｽ数変更］をｸﾘｯｸします｡④　表示された［ﾗｲｾﾝｽ数変更］画面で､［ｵﾌﾟｼｮﾝｻｰﾋﾞｽ］の［変更後ﾗｲｾﾝｽ数］に､任意の数を入力して［更新］をｸﾘｯｸします｡たとえば､保存期間を5年延長したい場合は､｢5｣と入力します｡</div></div><div id="CMN13006"><div class="search_breadcrumbs">会社データ管理 &gt; 決算処理 &gt; 残高を再移送する</div><div class="search_title">残高を再移送する</div><div class="displayText">残高を再移送する　［データ関係処理］＞［会社データ管理］＞［更新処理］＞［残高再移送］『残高再移送』は、移送した次期会社データの期首残高、過年度実績残高、予算残高を上書きする機能で ...</div><div class="search_word">残高を再移送する　［ﾃﾞｰﾀ関係処理］＞［会社ﾃﾞｰﾀ管理］＞［更新処理］＞［残高再移送］『残高再移送』は､移送した次期会社ﾃﾞｰﾀの期首残高､過年度実績残高､予算残高を上書きする機能です｡たとえば､残高の繰越処理に誤りがあった場合や､ﾃﾞｰﾀの修正や設定変更後に再度正しい残高を反映させたい場合などに行います｡ 残高再移送に関する留意事項当期会社ﾃﾞｰﾀと次期会社ﾃﾞｰﾀで､科目ｺｰﾄﾞ・補助ｺｰﾄﾞ・部門ｺｰﾄﾞ（部門は適用開始日・終了日も一致）が異なる場合は､相違のある項目の残高は移送されません｡決算更新後に当期会社ﾃﾞｰﾀでｺｰﾄﾞを追加・修正した場合は､次期会社ﾃﾞｰﾀにもそのｺｰﾄﾞを追加・修正します｡  残高を再移送する①　次期会社ﾃﾞｰﾀへ移送しない残高がある場合は､［期首残高］または［過年度実績］の✔をはずします｡摘要残高は､［期首残高］のみが移送対象です｡なお､会計期間を変更している場合は､✔をはずせません｡②　次期会社ﾃﾞｰﾀへ予算を移送する場合は､予算移送で､移送する予算を選択します｡ 当期予算当期会社ﾃﾞｰﾀで登録した当期予算が､次期会社ﾃﾞｰﾀの当期予算に移送されます｡来期予算当期会社ﾃﾞｰﾀで登録した来期予算が､次期会社ﾃﾞｰﾀの当期予算に移送されます｡移送なし予算は移送されません｡ ③　［残高再移送］をｸﾘｯｸします｡次期会社ﾃﾞｰﾀに残高が移送されます｡利用しているｼｽﾃﾑの残高を確認します｡</div></div></div>');

// Global variables for MutationObserver feature
var currentSearchValue = ""; // Current search keyword
var mutationObserver = null; // MutationObserver instance
var debounceTimer = null; // Debounce timer for DOM changes

function selectorEscape(val){
  return val.replace(/[-\/\\^$*+?.()|[\]{}\!]/g, '\\$&');
}

// Apply highlight to iframe content
function applyHighlight(searchValue) {
  var searchWordTmp = searchValue.split("　").join(" ").trim();
  searchWordTmp = searchWordTmp.split("  ").join(" ");
  for(var i = 0; i < wide.length; i++) {
    searchWordTmp = searchWordTmp.replace(wide[i], narrow[i]);
  }
  var searchWord = searchWordTmp.split(" ");
  for(var i = 0; i < searchWord.length; i++) {
    searchWord[i] = selectorEscape(searchWord[i].replace(">", "&gt;").replace("<", "&lt;"));
  }
  var hilightWord = searchWord.join("|");
  for(var i = 0; i < hilight.length; i++) {
    var reg = new RegExp(hilight[i], "gm");
    hilightWord = hilightWord.replace(reg, hilight[i]);
  }

  var reg = new RegExp("("+hilightWord+")(?=[^<>]*<)", "gm");
  var regnbsp = new RegExp("&nbsp;(?=[^<>]*<)", "gm");
  var reggt = new RegExp("&gt;(?=[^<>]*<)", "gm");
  var reglt = new RegExp("&lt;(?=[^<>]*<)", "gm");
  var regquot = new RegExp("&quot;(?=[^<>]*<)", "gm");
  var regamp = new RegExp("&amp;(?=[^<>]*<)", "gm");
  $("iframe.topic").contents().find("body").html($("iframe.topic").contents().find("body").html().replace(regnbsp, "　").replace(reggt, ">").replace(reglt, "<").replace(regquot, '"').replace(regamp, "&").replace(reg, "<font class='keyword' style='color:rgb(0, 0, 0); background-color:rgb(252, 255, 0);'>$1</font>"));
}

// Remove keyword highlights
function removeHighlight() {
  $("iframe.topic").contents().find(".keyword").each(function() {
    for(var i = 0; i < $(this)[0].childNodes.length; i++) {
      this.parentNode.insertBefore($(this)[0].childNodes[i], this);
    }
    $(this).remove();
  });
}

// Setup MutationObserver for iframe content
function setupMutationObserver() {
  disconnectMutationObserver();
  
  try {
    var $iframe = $("iframe.topic");
    if ($iframe.length === 0) return;
    
    var iframeDocument = $iframe[0].contentDocument || $iframe[0].contentWindow.document;
    if (!iframeDocument || !iframeDocument.body) return;
    
    mutationObserver = new MutationObserver(function(mutations) {
      if (!currentSearchValue || currentSearchValue.trim() === "") {
        return;
      }
      
      var shouldReHighlight = false;
      for (var i = 0; i < mutations.length; i++) {
        var mutation = mutations[i];
        if (mutation.type === 'childList') {
          var addedKeywords = false;
          for (var j = 0; j < mutation.addedNodes.length; j++) {
            var node = mutation.addedNodes[j];
            if (node.nodeType === Node.ELEMENT_NODE) {
              if (node.classList && node.classList.contains('keyword')) {
                addedKeywords = true;
                break;
              }
              if (node.querySelector && node.querySelector('.keyword')) {
                addedKeywords = true;
                break;
              }
            }
          }
          
          if (addedKeywords && mutation.addedNodes.length === 1) {
            continue;
          }
          
          if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
            shouldReHighlight = true;
            break;
          }
        } else if (mutation.type === 'characterData') {
          shouldReHighlight = true;
          break;
        }
      }
      
      if (shouldReHighlight) {
        debouncedReHighlight();
      }
    });
    
    mutationObserver.observe(iframeDocument.body, {
      childList: true,
      subtree: true,
      characterData: true,
      attributes: false
    });
    
    console.debug("MutationObserver setup for iframe content");
  } catch (error) {
    console.warn("Failed to setup MutationObserver:", error);
  }
}

// Debounced re-highlighting
function debouncedReHighlight() {
  if (debounceTimer) {
    clearTimeout(debounceTimer);
  }
  
  debounceTimer = setTimeout(function() {
    reHighlightAfterDomChange();
  }, 500);
}

// Re-highlight after DOM change
function reHighlightAfterDomChange() {
  if (!currentSearchValue || currentSearchValue.trim() === "") {
    return;
  }
  
  try {
    disconnectMutationObserver();
    removeHighlight();
    applyHighlight(currentSearchValue);
    
    setTimeout(function() {
      setupMutationObserver();
    }, 100);
    
    console.debug("Re-highlighted search terms after DOM change");
  } catch (error) {
    console.warn("Failed to re-highlight after DOM change:", error);
    setupMutationObserver();
  }
}

// Disconnect MutationObserver
function disconnectMutationObserver() {
  if (mutationObserver) {
    mutationObserver.disconnect();
    mutationObserver = null;
  }
  
  if (debounceTimer) {
    clearTimeout(debounceTimer);
    debounceTimer = null;
  }
}

$(function(){
  $(document).on("click", "ul.toc li.book", function() {
    if($(this).children("a[href='#'],a[href='javascript:void 0;']").length == 0)
    {
      $(this).children("a").each(function(){
        location.href=location.href.replace(location.hash,"")+"#t="+$(this).attr("href");
      });
    }
  });
  $(".wSearchField").each(function() {
    $(this).off();
  });
  $(document).on("keyup", ".wSearchField", function(){
    if($(this).val() == "")
    {
      $(".wSearchResultItemsBlock").html("");
      $(".wSearchResultsEnd").addClass("rh-hide");
      $(".wSearchResultsEnd").attr("hidden", "");
      $("#searchMsg").html("2つ以上の語句を入力して検索する場合は、スペース（空白）で区切ります。");
      removeHighlight();
      currentSearchValue = ""; // Clear current search value
      disconnectMutationObserver(); // Disconnect observer when clearing
    }
    else
    {
      $("#searchMsg").html("");
      currentSearchValue = $(this).val(); // Store current search value
      var searchWordTmp = $(this).val().replace(/(.*?)(?:　| )+(.*?)/g, "$1 $2").trim().toLowerCase();
      for(i = 0; i < wide.length; i ++)
      {
        searchWordTmp = searchWordTmp.split(wide[i]).join(narrow[i]);
      }
      var searchWord = searchWordTmp.split(" ");
      var searchQuery = "";
      for(i = 0; i < searchWord.length; i ++)
      {
        searchQuery += ":contains(" + searchWord[i] + ")";
      }
      
      var findItems = searchWords.find(".search_word"+searchQuery);
      if(findItems.length != 0)
      {
        $(".wSearchResultsEnd").removeClass("rh-hide");
        $(".wSearchResultsEnd").removeAttr("hidden");
        $(".wSearchResultItemsBlock").html("");
        findItems.each(function() {
          var displayText = $(this).parent().find(".displayText").text();
          $(".wSearchResultItemsBlock").append($("<div class='wSearchResultItem'><a class='nolink' href='./"+$(this).parent().attr("id")+".html'><div class='wSearchResultTitle'>"+$(this).parent().find(".search_title").html()+"</div></a><div class='wSearchContent'><span class='wSearchContext'>"+displayText+"</span></div></div>"));
        });
        removeHighlight();
        applyHighlight(currentSearchValue);
      }
      else
      {
        removeHighlight();
        $(".wSearchResultsEnd").addClass("rh-hide");
        $(".wSearchResultsEnd").attr("hidden", "");
        $(".wSearchResultItemsBlock").html("");
        displayText = "検索条件に一致するトピックはありません。";
        $(".wSearchResultItemsBlock").append($("<div class='wSearchResultItem'><div class='wSearchContent'><span class='wSearchContext'>"+displayText+"</span></div></div>"));
      }
    }
  });
  $("iframe.topic").on("load", function(){
    if($(".search-input", document).is(":not(.rh-hide)") && ($(".wSearchField", document).val() != ""))
    {
      var searchValue = $(".wSearchField", document).val();
      currentSearchValue = searchValue; // Store current search value
      applyHighlight(searchValue);
    }
    
    // Setup MutationObserver for iframe content changes
    setupMutationObserver();
  });
});
